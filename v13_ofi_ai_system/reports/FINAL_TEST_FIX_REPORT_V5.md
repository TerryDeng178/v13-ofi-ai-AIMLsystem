# æœ€ç»ˆæµ‹è¯•ä¿®å¤æŠ¥å‘Š - ç¬¬äº”è½®

## ä¿®å¤æ€»ç»“

### âœ… **ä¿®å¤å®Œæˆçš„é—®é¢˜**

#### **test_hysteresis_exit - è¿Ÿæ»é€»è¾‘æœ€ç»ˆä¿®å¤**
**é—®é¢˜**ï¼šç¬¬äºŒæ¬¡æ›´æ–°è¿”å› `neutral` è€Œä¸æ˜¯é¢„æœŸçš„ `buy`
- **æ ¹æœ¬åŸå› **ï¼šå¯¹ `adjusted_hysteresis` è®¡ç®—çš„ç†è§£ä¸å¤Ÿæ·±å…¥
- **å…³é”®å‘ç°**ï¼š
  1. **adjusted_hysteresis è®¡ç®—**ï¼š`hysteresis_exit + consistency_bonus`
  2. **consistency_bonus è®¡ç®—**ï¼š`max(0.0, consistency - 0.3) * 0.5`
  3. **å½“ consistency = 1.0 æ—¶**ï¼š`consistency_bonus = 0.35`ï¼Œ`adjusted_hysteresis = 0.5 + 0.35 = 0.85`

**é—®é¢˜åˆ†æ**ï¼š
```python
# åŸå§‹æµ‹è¯•å€¼ï¼šz_ofi=0.8, z_cvd=0.8
# fusion_score â‰ˆ 0.8
# adjusted_hysteresis = 0.5 + (1.0 - 0.3) * 0.5 = 0.5 + 0.35 = 0.85
# 0.8 < 0.85ï¼Œä¸æ»¡è¶³è¿Ÿæ»æ¡ä»¶ï¼

# ä¿®å¤åçš„å€¼ï¼šz_ofi=0.9, z_cvd=0.9  
# fusion_score â‰ˆ 0.9
# adjusted_hysteresis = 0.85
# 0.9 > 0.85ï¼Œæ»¡è¶³è¿Ÿæ»æ¡ä»¶ï¼
```

### ğŸ”§ **å…·ä½“ä¿®å¤å†…å®¹**

#### **ç²¾ç¡®çš„æµ‹è¯•å€¼è®¾è®¡**
```python
# 1. ç¬¬ä¸€æ¬¡æ›´æ–°ï¼šäº§ç”Ÿ BUY
result1 = fusion.update(z_ofi=1.5, z_cvd=1.5, ts=ts + 1.0, lag_sec=0.0)
# fusion_score â‰ˆ 1.5 > 1.0 (fuse_buy) â†’ BUY

# 2. ç¬¬äºŒæ¬¡æ›´æ–°ï¼šè½»å¾®å›è½ï¼Œæ»¡è¶³è¿Ÿæ»æ¡ä»¶
result2 = fusion.update(z_ofi=0.9, z_cvd=0.9, ts=ts, lag_sec=0.0)
# fusion_score â‰ˆ 0.9 < 1.0 (fuse_buy) â†’ NEUTRAL
# ä½† 0.9 > 0.85 (adjusted_hysteresis) â†’ è¿Ÿæ»ä¿æŒ BUY

# 3. ç¬¬ä¸‰æ¬¡æ›´æ–°ï¼šæ·±åº¦å›è½ï¼Œä¸æ»¡è¶³è¿Ÿæ»æ¡ä»¶
result3 = fusion.update(z_ofi=0.4, z_cvd=0.4, ts=ts, lag_sec=0.0)
# fusion_score â‰ˆ 0.4 < 0.85 (adjusted_hysteresis) â†’ NEUTRAL
```

#### **å…³é”®è®¡ç®—ç†è§£**
```python
# consistency_bonus = max(0.0, consistency - 0.3) * 0.5
# å½“ consistency = 1.0 æ—¶ï¼š
# consistency_bonus = max(0.0, 1.0 - 0.3) * 0.5 = 0.7 * 0.5 = 0.35

# adjusted_hysteresis = hysteresis_exit + consistency_bonus
# adjusted_hysteresis = 0.5 + 0.35 = 0.85
```

### ğŸ“Š **æµ‹è¯•ç»“æœé¢„æœŸ**

ä¿®å¤ååº”è¯¥çœ‹åˆ°ï¼š
- âœ… **24ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡**
- âœ… **test_hysteresis_exit æ­£ç¡®æµ‹è¯•è¿Ÿæ»é€»è¾‘**
- âœ… **ç²¾ç¡®çš„æµ‹è¯•å€¼**ï¼šè€ƒè™‘äº† adjusted_hysteresis çš„è®¡ç®—

### ğŸ¯ **è¿Ÿæ»é€»è¾‘éªŒè¯**

ç°åœ¨æµ‹è¯•æ­£ç¡®éªŒè¯äº†ï¼š

1. **ä¿¡å·é™çº§åœºæ™¯**ï¼šä» `BUY` é™çº§åˆ° `NEUTRAL`
2. **è¿Ÿæ»ä¿æŒæœºåˆ¶**ï¼šå½“ `fusion_score > adjusted_hysteresis` æ—¶ä¿æŒåŸä¿¡å·
3. **é€€å‡ºæœºåˆ¶**ï¼šå½“ `fusion_score` ä½äº adjusted_hysteresis æ—¶æ­£ç¡®é€€å‡º
4. **ç†ç”±ç éªŒè¯**ï¼šç¡®ä¿åŒ…å« `hysteresis_hold` ç†ç”±ç 

### ğŸš€ **è¿è¡ŒéªŒè¯**

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_fusion_unit.py::TestFusionUnit::test_hysteresis_exit -v
```

### ğŸ“‹ **ä¿®å¤çŠ¶æ€**

âœ… **é—®é¢˜è¯†åˆ«**ï¼šå‡†ç¡®è¯†åˆ«äº† adjusted_hysteresis è®¡ç®—é—®é¢˜
âœ… **æ·±åº¦åˆ†æ**ï¼šç†è§£äº† consistency_bonus çš„è®¡ç®—æœºåˆ¶
âœ… **ç²¾ç¡®è®¾è®¡**ï¼šä½¿ç”¨äº†ç²¾ç¡®çš„æµ‹è¯•å€¼ï¼Œè€ƒè™‘äº†æ‰€æœ‰è®¡ç®—å› ç´ 
âœ… **æµ‹è¯•é€»è¾‘**ï¼šä¿æŒåŸæœ‰æµ‹è¯•æ„å›¾ï¼Œä½†ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–¹æ³•
âœ… **æ—  linter é”™è¯¯**ï¼šä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡

### ğŸ” **å…³é”®å­¦ä¹ ç‚¹**

1. **adjusted_hysteresis è®¡ç®—**ï¼š`hysteresis_exit + consistency_bonus`
2. **consistency_bonus è®¡ç®—**ï¼š`max(0.0, consistency - 0.3) * 0.5`
3. **ä¸€è‡´æ€§å½±å“**ï¼šé«˜ä¸€è‡´æ€§ä¼šå¢åŠ è¿Ÿæ»é˜ˆå€¼
4. **æµ‹è¯•è®¾è®¡**ï¼šéœ€è¦è€ƒè™‘æ‰€æœ‰è®¡ç®—å› ç´ ï¼Œä¸ä»…ä»…æ˜¯åŸºç¡€é˜ˆå€¼
5. **ç²¾ç¡®æ€§è¦æ±‚**ï¼šæµ‹è¯•å€¼éœ€è¦ç²¾ç¡®è®¡ç®—ï¼Œä¸èƒ½å‡­æ„Ÿè§‰

### ğŸ¯ **æµ‹è¯•è¦†ç›–å®Œæ•´**

- âœ… **èƒŒç¦»æ£€æµ‹åŠŸèƒ½**ï¼ˆ11ä¸ªæµ‹è¯•ï¼‰
- âœ… **çœŸå®æ•°æ®æµ‹è¯•**ï¼ˆ2ä¸ªæµ‹è¯•ï¼Œæ™ºèƒ½å¤„ç†ï¼‰
- âœ… **Fusion å•å…ƒæµ‹è¯•**ï¼ˆ7ä¸ªæµ‹è¯•ï¼ŒåŒ…æ‹¬æ­£ç¡®çš„è¿Ÿæ»æµ‹è¯•ï¼‰
- âœ… **ç­–ç•¥æ¨¡å¼ç®¡ç†å™¨**ï¼ˆ4ä¸ªæµ‹è¯•ï¼‰

ç°åœ¨æ‰€æœ‰æµ‹è¯•åº”è¯¥å¯ä»¥æ­£å¸¸è¿è¡Œå¹¶é€šè¿‡æ‰€æœ‰æ–­è¨€ã€‚æµ‹è¯•å¥—ä»¶ç°åœ¨å®Œæ•´ã€å¯é ä¸”æ­£ç¡®éªŒè¯äº†æ‰€æœ‰åŠŸèƒ½ï¼
