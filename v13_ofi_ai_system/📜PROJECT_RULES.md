# 📜 V13 项目开发规则（严格执行）

> **本规则具有最高优先级，任何开发工作必须严格遵守**

---

## 🎯 **核心原则**

### **真实优先 (Reality First)**
- ✅ **除单元测试外，不允许使用 mock、占位、跳过**
- ✅ 所有功能必须使用真实的币安数据验证
- ✅ 所有组件必须真实实现，不能用简化版替代
- ✅ 所有测试必须用真实数据运行
- ❌ **禁止**: `mock.Mock()`, `@patch`, `TODO`, `pass`, `raise NotImplementedError`
- ❌ **禁止**: 模拟数据、假数据、占位符数据

**验证方法**: 
- 代码审查时搜索关键词: `mock`, `Mock`, `patch`, `TODO`, `NotImplemented`
- 所有功能必须有真实数据验证结果

---

## 🔒 **变更边界 (Change Boundary)**

### **仅可修改任务卡列出的 Allowed files**
- ✅ **任务卡中明确列出的文件** - 可以修改
- ⚠️ **超出任务卡范围的文件** - 必须先询问用户
- ⚠️ **新增文件** - 必须在任务卡中明确说明
- ❌ **禁止擅自修改** - 任务卡外的任何文件

**检查方法**:
1. 每次修改前，检查任务卡是否允许
2. 如需修改任务卡外文件，立即停止并询问用户
3. 获得用户确认后，更新任务卡

**示例**:
```
✅ 允许: 任务1.1.1允许创建 src/binance_websocket_client.py
❌ 禁止: 任务1.1.1中修改 config/binance_config.yaml (未在任务中列出)
⚠️ 需询问: 需要创建 src/utils.py 辅助文件（任务卡未提及）
```

---

## ✏️ **最小补丁原则 (Minimal Patch)**

### **diff-only，不得整文件重写、重命名或移动文件**
- ✅ **仅修改必要的代码行** - 使用 diff/patch 方式
- ✅ **保留现有代码结构** - 不重构无关代码
- ✅ **最小化改动范围** - 只改需要改的
- ❌ **禁止**: 整个文件重写
- ❌ **禁止**: 文件重命名（除非任务卡明确要求）
- ❌ **禁止**: 文件移动（除非任务卡明确要求）
- ❌ **禁止**: 大规模重构（除非任务卡明确要求）

**检查方法**:
1. 使用 `search_replace` 工具进行精确替换
2. 每次修改审查 diff，确保最小化
3. 禁止使用 `write` 工具重写整个文件（新文件除外）

**示例**:
```python
# ✅ 好的做法 - 最小补丁
旧代码:
    def calculate(self):
        return 0

新代码:
    def calculate(self):
        return sum(self.data)

# ❌ 坏的做法 - 整文件重写
删除整个文件重新写入
```

---

## 📦 **依赖管理 (Dependencies)**

### **除非任务卡明确允许，禁止新增依赖**
- ✅ **任务卡中列出的依赖** - 可以添加
- ⚠️ **未在任务卡中的依赖** - 必须先询问用户
- ❌ **禁止擅自添加** - 任何新的 pip 包

**当前允许的依赖** (来自 requirements.txt):
```
numpy>=1.24.0
pandas>=2.0.0
python-binance>=1.0.19
websocket-client>=1.6.0
pyyaml>=6.0
```

**后续阶段的依赖** (需任务卡明确激活):
```
# 阶段3开始:
scikit-learn>=1.3.0
xgboost>=2.0.0

# 阶段4开始:
torch>=2.0.0
torchvision>=0.15.0
```

**检查方法**:
1. 每次 `import` 新包前，检查是否在允许列表
2. 如需新包，立即停止并询问用户
3. 获得确认后，更新 requirements.txt 和任务卡

---

## 🔧 **接口不变量 (Interface Invariants)**

### **WS JSON 字段、模块公开函数签名、目录结构，不得破坏**

#### **1. WebSocket JSON 字段**
- ❌ **禁止修改** 币安 WebSocket 返回的 JSON 字段名
- ❌ **禁止修改** 内部约定的数据格式
- ✅ **允许** 添加新字段（不影响现有字段）

**示例**:
```python
# ❌ 禁止
data['bids']  →  data['buy_orders']  # 破坏接口

# ✅ 允许
data['bids'] = ...
data['bid_depth'] = ...  # 新增字段
```

#### **2. 模块公开函数签名**
- ❌ **禁止修改** 已存在的公开函数参数
- ❌ **禁止修改** 已存在的公开函数返回值类型
- ✅ **允许** 添加可选参数（有默认值）
- ✅ **允许** 添加新的公开函数

**示例**:
```python
# ❌ 禁止
def calculate_ofi(bids, asks):  →  def calculate_ofi(order_book):

# ✅ 允许
def calculate_ofi(bids, asks, weights=None):  # 添加可选参数
```

#### **3. 目录结构**
- ❌ **禁止移动** 已存在的目录
- ❌ **禁止重命名** 已存在的目录
- ✅ **允许** 在任务卡明确要求下创建新目录

**当前目录结构** (不可变):
```
v13_ofi_ai_system/
├── src/
├── tests/
├── data/
├── config/
├── docs/
├── examples/
└── reports/  (可新增)
```

---

## ✅ **完成定义 (Definition of Done, DoD)**

### **每个任务完成的标准**

#### **必须通过**:
1. ✅ **Lint 检查** - 无语法错误、无 linter 警告
2. ✅ **Test 通过** - 所有测试用例通过
3. ✅ **Type Check** - 类型注解正确（如使用）
4. ✅ **No Mocks** - 无 mock、占位、跳过（单元测试除外）

#### **必须产出**:
1. ✅ **任务卡指定的可运行验证**
2. ✅ **真实数据验证结果**
3. ✅ **运行日志/截图**（如适用）
4. ✅ **性能指标**（如任务卡要求）

**检查清单**:
```
[ ] 代码无语法错误
[ ] 通过 lint 检查 (python -m py_compile)
[ ] 通过所有测试
[ ] 无 mock/占位/跳过
[ ] 产出任务卡要求的验证结果
[ ] 使用真实数据验证
[ ] 性能指标达标（如适用）
[ ] 更新任务卡状态
```

---

## 📋 **输出流程 (Output Process)**

### **严格的两阶段流程**

#### **阶段1: 提交计划 (必须)**
在开始任何代码修改前，必须提交计划：

1. **修改文件清单**
   ```
   将要修改的文件:
   - v13_ofi_ai_system/src/binance_websocket_client.py (新建)
   - v13_ofi_ai_system/config/binance_config.yaml (修改第10-15行)
   ```

2. **预估行数**
   ```
   binance_websocket_client.py: 约150行
   binance_config.yaml: 修改5行
   ```

3. **测试设计**
   ```
   验证方法:
   - 运行 WebSocket 客户端 5分钟
   - 检查接收到的数据格式
   - 验证数据完整性
   预期结果:
   - 成功接收至少300条订单簿数据
   - 数据格式正确
   - 无连接中断
   ```

4. **依赖检查**
   ```
   需要的包: websocket-client (已在 requirements.txt)
   新增导入: json, datetime (标准库)
   ```

#### **阶段2: 等待确认**
- ⏸️ **停止并等待** 用户确认计划
- ✅ **用户确认后** 才能开始编码
- ❌ **未确认前** 不得修改任何代码

#### **阶段3: 提交补丁与验证结果**
用户确认后，提交:

1. **代码补丁** (使用 search_replace 或 write)
2. **验证结果**
   ```
   运行结果:
   - 成功接收 650 条订单簿数据
   - 数据格式: ✅ 正确
   - 连接稳定性: ✅ 无中断
   - 延迟: 平均 180ms
   ```
3. **DoD 检查清单** (全部打勾)

---

## ⚠️ **质询触发 (Must Ask)**

### **以下情况必须立即停止并询问用户**

#### **触发条件**:
1. 🤔 **需求含糊** 
   - 任务卡描述不清晰
   - 验证标准不明确
   - 不确定如何实现

2. 💰 **超出变更预算**
   - 修改的文件数 > 任务卡允许的
   - 代码行数 > 预估的 2倍
   - 修改时间 > 预估的 2倍

3. 📦 **需新依赖**
   - 需要安装新的 pip 包
   - 需要使用任务卡未列出的库

4. 🔍 **无法按真数据验证**
   - 真实数据无法获取
   - 真实验证需要过长时间
   - 真实环境无法访问

#### **质询模板**:
```
⚠️ 质询触发：[原因]

当前任务: [任务编号和名称]
问题描述: [具体问题]
影响范围: [会影响什么]

请用户决策:
选项A: [建议方案A]
选项B: [建议方案B]
选项C: [其他建议]

等待用户指示...
```

---

## 📊 **规则遵守检查清单**

### **每次开始任务前**:
- [ ] 阅读任务卡，理解任务范围
- [ ] 确认允许修改的文件
- [ ] 检查是否需要新依赖
- [ ] 准备计划（修改文件、预估行数、测试设计）
- [ ] 提交计划，等待用户确认

### **编码过程中**:
- [ ] 使用真实数据，不用 mock
- [ ] 最小化修改，diff-only
- [ ] 不修改接口（JSON字段、函数签名、目录结构）
- [ ] 不超出任务卡允许的文件范围

### **提交前**:
- [ ] 通过 lint 检查
- [ ] 通过所有测试
- [ ] 无 mock/占位/跳过
- [ ] 产出真实验证结果
- [ ] 更新任务卡状态
- [ ] 提交补丁和验证结果

### **如遇问题**:
- [ ] 立即停止
- [ ] 发起质询
- [ ] 等待用户指示

---

## 🚨 **违规处理**

### **违规行为**:
1. ❌ 使用 mock/占位/跳过（单元测试除外）
2. ❌ 未经允许修改任务卡外文件
3. ❌ 整文件重写而非最小补丁
4. ❌ 擅自添加新依赖
5. ❌ 破坏接口不变量
6. ❌ 未通过 DoD 检查
7. ❌ 未提交计划直接编码
8. ❌ 应质询而未质询

### **处理流程**:
1. 🛑 **立即停止** 当前工作
2. 🔙 **回滚** 不符合规则的修改
3. 📝 **记录** 违规情况
4. 💬 **与用户沟通** 问题和解决方案
5. ✅ **获得确认后** 重新开始

---

## 📚 **规则优先级**

### **优先级顺序**:
1. **最高优先级**: 本规则文档（📜PROJECT_RULES.md）
2. **第二优先级**: 任务卡（📋V13_TASK_CARD.md）
3. **第三优先级**: 开发指导（🎯V13_FRESH_START_DEVELOPMENT_GUIDE.md）
4. **参考优先级**: V12经验总结

### **冲突解决**:
- 如规则之间有冲突，以优先级高的为准
- 如有疑问，必须询问用户
- 用户指示具有最高优先级

---

## 📝 **规则版本历史**

- **V1.0.0** - 2025-01-17 04:20 - 初始创建，定义核心规则
- 后续修改需记录在此

---

## ✅ **规则确认**

**开发者声明**:
- ✅ 我已完整阅读并理解本规则
- ✅ 我承诺严格遵守所有规则
- ✅ 我承诺任何违规立即停止并与用户沟通
- ✅ 我承诺质量优于速度，真实优于完成

**签署**: AI Assistant  
**日期**: 2025-01-17  
**版本**: V1.0.0

---

**规则状态**: ✅ 生效中  
**强制执行**: ✅ 是  
**可协商性**: ❌ 否（除非用户明确修改）

---

## 🎯 **开始工作前必读**

在开始任何任务前，请再次确认:

1. ✅ 我已阅读本规则
2. ✅ 我已阅读任务卡
3. ✅ 我已准备好计划
4. ✅ 我已理解 DoD 标准
5. ✅ 我承诺真实优先

**准备好了吗？开始第一个任务！** 🚀

