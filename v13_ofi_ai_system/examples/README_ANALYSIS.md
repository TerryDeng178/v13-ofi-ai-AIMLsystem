# Analysis.py ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

`analysis.py` æ˜¯ V13 ç³»ç»Ÿçš„æ•°æ®åˆ†æå’ŒéªŒè¯å·¥å…·ï¼Œç”¨äºæ£€æŸ¥OFI/CVDæ•°æ®è´¨é‡å¹¶ç”ŸæˆéªŒæ”¶æŠ¥å‘Šã€‚

**æ¨¡å—**: `v13_ofi_ai_system/examples/analysis.py`  
**ä»»åŠ¡**: Task 1.2.5 å®Œæˆåå¯å¤ç”¨äºæ‰€æœ‰æµ‹è¯•ä»»åŠ¡  
**åŠŸèƒ½**: æ•°æ®éªŒè¯ã€ç»Ÿè®¡åˆ†æã€å›¾è¡¨ç”Ÿæˆã€éªŒæ”¶æŠ¥å‘Š

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```bash
# åˆ†æå•ä¸ªæ•°æ®æ–‡ä»¶
python analysis.py \
    --data v13_ofi_ai_system/data/DEMO-USD/20251017_1826.parquet \
    --out v13_ofi_ai_system/figs \
    --report ANALYSIS_REPORT.md

# åˆ†ææ•´ä¸ªç›®å½•ï¼ˆè‡ªåŠ¨åˆå¹¶æ‰€æœ‰parquetæ–‡ä»¶ï¼‰
python analysis.py \
    --data v13_ofi_ai_system/data/DEMO-USD \
    --out v13_ofi_ai_system/figs \
    --report ANALYSIS_REPORT.md
```

### å‚æ•°è¯´æ˜

| å‚æ•° | å¿…é€‰ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `--data` | âœ… | æ•°æ®æ–‡ä»¶æˆ–ç›®å½•è·¯å¾„ | `data/DEMO-USD/file.parquet` æˆ– `data/DEMO-USD/` |
| `--out` | âŒ | å›¾è¡¨è¾“å‡ºç›®å½• | `figs/` (é»˜è®¤: `v13_ofi_ai_system/examples/figs`) |
| `--report` | âŒ | æŠ¥å‘Šè¾“å‡ºæ–‡ä»¶ | `report.md` (é»˜è®¤: `v13_ofi_ai_system/examples/TASK_1_2_5_REPORT.md`) |

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

`analysis.py` ä¼šè‡ªåŠ¨æ£€æŸ¥ä»¥ä¸‹éªŒæ”¶æ ‡å‡†ï¼š

### 1. æ•°æ®è¦†ç›– (3é¡¹)

| æ£€æŸ¥é¡¹ | é˜ˆå€¼ | è¯´æ˜ |
|--------|------|------|
| **é‡‡æ ·ç‚¹æ•°** | â‰¥300,000 | æ•°æ®é‡æ˜¯å¦å……è¶³ |
| **æ•°æ®è¿ç»­æ€§** | max_gap â‰¤2000ms | æ—¶é—´æˆ³è¿ç»­æ€§ |
| **æ—¶é—´è·¨åº¦** | â‰¥2å°æ—¶ | é‡‡é›†æ—¶é•¿æ˜¯å¦è¶³å¤Ÿ |

### 2. åŠŸèƒ½æ­£ç¡®æ€§ (2é¡¹)

| æ£€æŸ¥é¡¹ | é˜ˆå€¼ | è¯´æ˜ |
|--------|------|------|
| **åˆ†é‡å’Œæ ¡éªŒ** | >99% | `abs(k_components_sum - ofi) < 1e-9` |
| **éç©ºå­—æ®µ** | 100% | å¿…éœ€å­—æ®µæ— NULLå€¼ |

### 3. Z-scoreæ ‡å‡†åŒ– (6é¡¹)

| æ£€æŸ¥é¡¹ | é˜ˆå€¼ | è¯´æ˜ |
|--------|------|------|
| **ä¸­ä½æ•°å±…ä¸­** | âˆˆ[-0.1, +0.1] | Z-scoreåˆ†å¸ƒæ˜¯å¦å±…ä¸­ |
| **IQRåˆç†** | âˆˆ[0.8, 1.6] | å››åˆ†ä½è·æ˜¯å¦æ­£å¸¸ |
| **\|Z\|>2å æ¯”** | âˆˆ[1%, 8%] | å°¾éƒ¨å æ¯”æ˜¯å¦åˆç† |
| **\|Z\|>3å æ¯”** | â‰¤1.5% | æç«¯å€¼æ˜¯å¦è¿‡å¤š |
| **std_zeroæ ‡è®°** | ==0 | æ ‡å‡†å·®ä¸º0çš„æ¬¡æ•° |
| **warmupå æ¯”** | â‰¤10% | é¢„çƒ­æœŸå æ¯” |

### 4. æ•°æ®è´¨é‡ (2é¡¹)

| æ£€æŸ¥é¡¹ | é˜ˆå€¼ | è¯´æ˜ |
|--------|------|------|
| **åæ•°æ®ç‚¹ç‡** | â‰¤0.1% | æ— æ•ˆæ•°æ®å æ¯” |
| **è§£æé”™è¯¯** | ==0 | è§£æå¤±è´¥æ¬¡æ•° |

### 5. æ€§èƒ½æŒ‡æ ‡ (3é¡¹)

| æ£€æŸ¥é¡¹ | é˜ˆå€¼ | è¯´æ˜ |
|--------|------|------|
| **å¤„ç†å»¶è¿Ÿp95** | <5ms | 95åˆ†ä½å»¶è¿Ÿ |
| **é‡è¿é¢‘ç‡** | â‰¤3æ¬¡/å°æ—¶ | WebSocketé‡è¿é¢‘ç‡ |
| **é˜Ÿåˆ—ä¸¢å¼ƒç‡** | â‰¤0.5% | backpressureè§¦å‘ç‡ |

---

## ğŸ“ˆ è¾“å‡ºæ–‡ä»¶

### 1. å›¾è¡¨æ–‡ä»¶ (4å¼ å¿…é€‰)

ç”Ÿæˆåœ¨ `--out` æŒ‡å®šç›®å½•ï¼š

- **hist_z.png** - Z-scoreåˆ†å¸ƒç›´æ–¹å›¾
  - éªŒè¯æ­£æ€æ€§
  - æ˜¾ç¤ºä¸­ä½æ•°ã€Q25ã€Q75

- **ofi_timeseries.png** - OFIåŸå§‹æ—¶é—´åºåˆ—
  - é‡‡æ ·10000ç‚¹
  - å±•ç¤ºåŸå§‹æ³¢åŠ¨

- **z_timeseries.png** - Z-scoreæ—¶é—´åºåˆ—
  - ä»…éwarmupæœŸæ•°æ®
  - æ ‡è®°Â±2å’ŒÂ±3é˜ˆå€¼çº¿

- **latency_box.png** - å¤„ç†å»¶è¿Ÿç®±çº¿å›¾
  - å±•ç¤ºå»¶è¿Ÿåˆ†å¸ƒ
  - è¯†åˆ«å¼‚å¸¸å€¼

### 2. åˆ†ææŠ¥å‘Š

ç”Ÿæˆåœ¨ `--report` æŒ‡å®šè·¯å¾„ï¼š

```markdown
# Task 1.2.5 OFIè®¡ç®—æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ‰§è¡Œæ—¶é—´**: 2025-10-17 20:33:43
**æ•°æ®æº**: `../data/DEMO-USD/20251017_1826.parquet`

## éªŒæ”¶æ ‡å‡†å¯¹ç…§ç»“æœ

### 1. æ•°æ®è¦†ç›–
- [x] é‡‡æ ·ç‚¹æ•°: 352,778 (â‰¥300,000)
- [x] æ•°æ®è¿ç»­æ€§: max_gap=457.11ms (â‰¤2000ms)
- [ ] æ—¶é—´è·¨åº¦: 1.99å°æ—¶ (â‰¥2å°æ—¶)

...

## ç»“è®º
**âœ… æ‰€æœ‰éªŒæ”¶æ ‡å‡†é€šè¿‡ï¼Œå¯ç»§ç»­ä¸‹ä¸€ä»»åŠ¡**
```

### 3. JSONè¯¦ç»†ç»“æœ

ç”Ÿæˆåœ¨ `<out_dir>/analysis_results.json`ï¼š

```json
{
  "total_points": 352778,
  "time_span_hours": 1.99,
  "max_gap_ms": 457.11,
  "continuity_pass": true,
  "z_score": {
    "median": 0.0003,
    "iqr": 1.3696,
    "tail2_pct": 4.52,
    "tail3_pct": 0.20
  },
  ...
}
```

---

## ğŸ’¡ å…¸å‹ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: TaskéªŒæ”¶ï¼ˆå•æ¬¡æµ‹è¯•ï¼‰

```bash
# Task 1.2.5: OFIè®¡ç®—æµ‹è¯•éªŒæ”¶
python analysis.py \
    --data v13_ofi_ai_system/data/DEMO-USD/20251017_1826.parquet \
    --out v13_ofi_ai_system/figs \
    --report v13_ofi_ai_system/examples/TASK_1_2_5_REPORT.md

# æŸ¥çœ‹æŠ¥å‘Š
cat v13_ofi_ai_system/examples/TASK_1_2_5_REPORT.md
```

### åœºæ™¯2: æ‰¹é‡åˆ†æï¼ˆå¤šæ¬¡æµ‹è¯•ï¼‰

```bash
# åˆ†ææ•´ä¸ªç›®å½•ï¼ˆè‡ªåŠ¨åˆå¹¶ï¼‰
python analysis.py \
    --data v13_ofi_ai_system/data/DEMO-USD \
    --out v13_ofi_ai_system/figs \
    --report BATCH_ANALYSIS_REPORT.md
```

### åœºæ™¯3: CVDæ•°æ®éªŒè¯ï¼ˆåç»­ä»»åŠ¡ï¼‰

```bash
# Task 1.2.10: CVDè®¡ç®—æµ‹è¯•éªŒæ”¶
python analysis.py \
    --data v13_ofi_ai_system/data/CVD-USD/20251018_1000.parquet \
    --out v13_ofi_ai_system/figs/cvd \
    --report TASK_1_2_10_CVD_REPORT.md
```

### åœºæ™¯4: å¿«é€Ÿè´¨é‡æ£€æŸ¥

```bash
# åªç”Ÿæˆå›¾è¡¨ï¼Œä¸ç”ŸæˆæŠ¥å‘Š
python analysis.py \
    --data latest_data.parquet \
    --out quick_check/
```

---

## ğŸ“‹ æ•°æ®å­—æ®µè¦æ±‚

### å¿…éœ€å­—æ®µ

åˆ†æè„šæœ¬è¦æ±‚è¾“å…¥æ•°æ®åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `ts` | int64 | æœ¬åœ°æ—¶é—´æˆ³ï¼ˆUTCæ¯«ç§’ï¼‰ |
| `ofi` | float64 | OFIåŸå§‹å€¼ |
| `z_ofi` | float64 | Z-scoreæ ‡å‡†åŒ–å€¼ï¼ˆwarmupæœŸå¯ä¸ºNULLï¼‰ |
| `ema_ofi` | float64 | EMAå¹³æ»‘å€¼ |
| `warmup` | bool | warmupæ ‡è®° |
| `std_zero` | bool | æ ‡å‡†å·®ä¸º0æ ‡è®° |
| `k_components_sum` | float64 | å„æ¡£OFIåˆ†é‡ä¹‹å’Œï¼ˆç”¨äºæ ¡éªŒï¼‰ |

### å¯é€‰å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `event_time_ms` | int64 | äº¤æ˜“æ‰€äº‹ä»¶æ—¶é—´ï¼ˆçœŸå®æµå¿…éœ€ï¼‰ |
| `latency_ms` | float64 | å¤„ç†å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰ |
| `queue_dropped` | int | é˜Ÿåˆ—ä¸¢å¼ƒç´¯è®¡è®¡æ•° |
| `reconnect_count` | int | é‡è¿ç´¯è®¡è®¡æ•° |
| `bad_points` | int | åæ•°æ®ç‚¹ç´¯è®¡è®¡æ•° |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ•°æ®æ ¼å¼

1. **Parquetæ ¼å¼**
   - æ¨èä½¿ç”¨Parquetæ ¼å¼ï¼ˆé«˜æ•ˆå‹ç¼©ï¼‰
   - æ”¯æŒå•æ–‡ä»¶æˆ–ç›®å½•ï¼ˆè‡ªåŠ¨åˆå¹¶ï¼‰

2. **æ—¶é—´æˆ³æ’åº**
   - è„šæœ¬ä¼šè‡ªåŠ¨æŒ‰ `ts` æ’åº
   - æ’åºåæ‰è®¡ç®—è¿ç»­æ€§

3. **å¤šæ–‡ä»¶åˆå¹¶**
   - ç›®å½•æ¨¡å¼è‡ªåŠ¨åˆå¹¶æ‰€æœ‰ `.parquet` æ–‡ä»¶
   - è„šæœ¬ä¼šä¸ºæ¯ä¸ªæ–‡ä»¶æ·»åŠ  `run_id` åˆ—ï¼ˆå–è‡ªæ–‡ä»¶åï¼‰
   - ä¾¿äºåŒºåˆ†ä¸åŒè¿è¡Œã€æ”¯æŒæ‰¹é‡ç»Ÿè®¡åˆ†æ

### æ€§èƒ½å»ºè®®

1. **æ•°æ®é‡**
   - å•æ–‡ä»¶: æ¨è<1000ä¸‡ç‚¹
   - å¤šæ–‡ä»¶: æ¨è<10ä¸ªæ–‡ä»¶
   - å¤§æ•°æ®é‡ä¼šå½±å“å›¾è¡¨ç”Ÿæˆé€Ÿåº¦

2. **å›¾è¡¨é‡‡æ ·**
   - æ—¶é—´åºåˆ—å›¾è‡ªåŠ¨é‡‡æ ·10000ç‚¹
   - ç›´æ–¹å›¾ä½¿ç”¨å…¨é‡æ•°æ®

3. **å†…å­˜å ç”¨**
   - 100ä¸‡ç‚¹çº¦éœ€ 100MB å†…å­˜
   - 1000ä¸‡ç‚¹çº¦éœ€ 1GB å†…å­˜

### å¸¸è§é—®é¢˜

**Q: åˆ†æå¤±è´¥æ€ä¹ˆåŠï¼Ÿ**  
A: æ£€æŸ¥æ•°æ®æ–‡ä»¶æ˜¯å¦åŒ…å«å¿…éœ€å­—æ®µï¼ŒæŸ¥çœ‹é”™è¯¯ä¿¡æ¯ã€‚

**Q: å›¾è¡¨ä¸æ˜¾ç¤ºæ€ä¹ˆåŠï¼Ÿ**  
A: ç¡®è®¤è¾“å‡ºç›®å½•å­˜åœ¨ä¸”æœ‰å†™å…¥æƒé™ã€‚

**Q: å¤šä¸ªæ–‡ä»¶å¦‚ä½•åˆå¹¶ï¼Ÿ**  
A: ç›´æ¥æŒ‡å®šç›®å½•è·¯å¾„ï¼Œè„šæœ¬è‡ªåŠ¨åˆå¹¶æ‰€æœ‰ `.parquet` æ–‡ä»¶ã€‚

**Q: å¦‚ä½•åªç”Ÿæˆç‰¹å®šå›¾è¡¨ï¼Ÿ**  
A: å½“å‰ç‰ˆæœ¬ç”Ÿæˆå…¨éƒ¨4å¼ å›¾è¡¨ï¼Œæ— æ³•å•ç‹¬æŒ‡å®šã€‚

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. ä¿®æ”¹éªŒæ”¶é˜ˆå€¼

å¦‚éœ€è‡ªå®šä¹‰é˜ˆå€¼ï¼Œç›´æ¥ç¼–è¾‘ `analysis.py`ï¼ˆæŒ‰å…³é”®å­—æœç´¢å®šä½ï¼‰ï¼š

```python
# æœç´¢ "total_points >= 300000" ä¿®æ”¹é‡‡æ ·ç‚¹æ•°é˜ˆå€¼
results['total_points'] >= 300000  # æ”¹ä¸ºä½ çš„é˜ˆå€¼

# æœç´¢ "queue_dropped_rate <= 0.005" ä¿®æ”¹é˜Ÿåˆ—ä¸¢å¼ƒç‡é˜ˆå€¼
results['queue_dropped_pass'] = queue_dropped_rate <= 0.005  # æ”¹ä¸º 0.01
```

### 2. æ·»åŠ è‡ªå®šä¹‰æ£€æŸ¥

åœ¨è„šæœ¬ä¸­æ·»åŠ æ–°çš„éªŒè¯é€»è¾‘ï¼š

```python
# åœ¨ main() å‡½æ•°ä¸­æ·»åŠ 
custom_check = df['ofi'].abs().max() < 10.0  # ç¤ºä¾‹ï¼šæ£€æŸ¥OFIæå€¼
results['custom_check_pass'] = custom_check
```

### 3. å¯¼å‡ºåŸå§‹æ•°æ®

```python
import pandas as pd

# è¯»å–åˆ†æç»“æœ
df = pd.read_parquet('data.parquet')

# å¯¼å‡ºç‰¹å®šåˆ—
df[['ts', 'ofi', 'z_ofi']].to_csv('ofi_series.csv', index=False)
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `run_realtime_ofi.py` - ç”Ÿæˆå¾…åˆ†æçš„æ•°æ®
- `README_realtime_ofi.md` - æ•°æ®é‡‡é›†æ–‡æ¡£
- `README_OFI_CALCULATOR.md` - OFIè®¡ç®—å™¨è¯´æ˜
- Taskå¡: `âœ…Task_1.2.5_OFIè®¡ç®—æµ‹è¯•.md`

---

## ğŸ“Š é€€å‡ºç 

è„šæœ¬é€€å‡ºç è¡¨ç¤ºéªŒæ”¶ç»“æœï¼š

- **0**: âœ… æ‰€æœ‰éªŒæ”¶æ ‡å‡†é€šè¿‡
- **1**: âŒ éƒ¨åˆ†éªŒæ”¶æ ‡å‡†æœªé€šè¿‡æˆ–æ‰§è¡Œå¼‚å¸¸

**è¯´æ˜**: è„šæœ¬å¼‚å¸¸ï¼ˆå¦‚æ–‡ä»¶ä¸å­˜åœ¨ã€å­—æ®µç¼ºå¤±ï¼‰ä¹Ÿä¼šè¿”å›1ï¼Œæ— éœ€åŒºåˆ†2ã€‚Shellä¸­åˆ¤æ–­éé›¶å³å¤±è´¥ã€‚

å¯åœ¨CI/CDä¸­ä½¿ç”¨ï¼š

```bash
python analysis.py --data data.parquet --out figs/ --report report.md
if [ $? -eq 0 ]; then
    echo "âœ… éªŒæ”¶é€šè¿‡"
else
    echo "âŒ éªŒæ”¶å¤±è´¥æˆ–å¼‚å¸¸"
    exit 1
fi
```

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **æ–‡ä»¶å‘½å**
   - æ•°æ®æ–‡ä»¶: `YYYYMMDD_HHMM.parquet`
   - æŠ¥å‘Šæ–‡ä»¶: `TASK_X_X_X_REPORT.md`
   - å›¾è¡¨ç›®å½•: æŒ‰ä»»åŠ¡åˆ†ç»„ (`figs/task_1.2.5/`)

2. **ç‰ˆæœ¬ç®¡ç†**
   - æ•°æ®æ–‡ä»¶: æ·»åŠ åˆ° `.gitignore`ï¼ˆå¤ªå¤§ï¼‰
   - å›¾è¡¨: å¯é€‰æ‹©æ€§æäº¤ï¼ˆç”¨äºæ–‡æ¡£ï¼‰
   - æŠ¥å‘Š: å»ºè®®æäº¤ï¼ˆå¯è¿½æº¯ï¼‰

3. **æ‰¹é‡åˆ†æ**
   ```bash
   # åˆ†æå¤šä¸ªä»»åŠ¡çš„æ•°æ®
   for task in task_1.2.5 task_1.2.10; do
       python analysis.py \
           --data data/$task \
           --out figs/$task \
           --report reports/${task}_report.md
   done
   ```

4. **CIé›†æˆ**
   ```yaml
   # .github/workflows/test.yml
   - name: Run Analysis
     run: |
       python analysis.py \
           --data test_data.parquet \
           --out artifacts/ \
           --report test_report.md
       exit_code=$?
       if [ $exit_code -ne 0 ]; then
           exit 1
       fi
   ```

---

**ç‰ˆæœ¬**: V13.1.2.5  
**æœ€åæ›´æ–°**: 2025-10-17  
**ç»´æŠ¤è€…**: V13 OFI+CVD+AI System Team

