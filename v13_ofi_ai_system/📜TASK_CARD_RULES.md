# 📜 V13任务卡执行规则

> **最高优先级文档** - AI助手执行任务前必须查阅此规则

---

## 🎯 核心原则

### **铁律1: 严格按顺序执行**
- ✅ 必须按照任务卡编号顺序执行（0.1 → 0.2 → ... → 4.2.4）
- ❌ **禁止跳过任何任务**，即使看起来简单或重复
- ❌ **禁止同时执行多个任务**，一次只做一个
- ⚠️ 前置任务未完成时，后续任务不得开始

### **铁律2: 用户确认后才能执行**
- ✅ 每个任务开始前，必须等待用户明确确认
- ✅ 每个阶段完成后，必须等待用户决策是否继续
- ❌ **禁止自作主张**，即使认为用户会同意
- 📝 确认格式：用户说"可以"、"开始"、"执行"等明确指令

### **铁律3: 验证标准必须达标**
- ✅ 每个任务都有验证标准，必须全部通过
- ✅ 验证结果必须真实、可验证、有数据支撑
- ❌ **禁止跳过验证**，即使任务看起来完成了
- ❌ **禁止伪造验证结果**
- ⚠️ 验证不通过时，必须重做或优化，不得继续

### **铁律4: 禁止自行修改任务卡**
- ❌ **禁止自行添加任务**
- ❌ **禁止自行删除任务**
- ❌ **禁止自行修改任务内容**
- ❌ **禁止自行调整任务顺序**
- ✅ 任何修改必须先与用户沟通并获得明确同意
- 📝 修改后必须在任务卡维护记录中记录

---

## 📋 执行流程（每个任务）

### **步骤1: 查阅规则** 🔍
```
在开始任何任务前，重新阅读：
1. 📜TASK_CARD_RULES.md（本文档）
2. 📜PROJECT_RULES.md（项目开发规则）
3. 当前任务的独立MD文件（TASKS/StageX/Task_X.X.X_XXX.md）
```

### **步骤2: 制定计划** 📝
```
向用户报告：
1. 当前任务编号和名称
2. 计划修改的文件（必须在Allowed files范围内）
3. 预估修改行数
4. 测试设计（如何验证）
5. 是否需要新增依赖（必须明确说明）
```

### **步骤3: 等待用户确认** ⏸️
```
用户明确说"可以"、"开始"、"执行"等指令后，才能继续
如果用户说"等等"、"先别动"，必须停止
```

### **步骤4: 执行任务** 🚀
```
严格按照计划执行：
1. 只修改Allowed files中的文件
2. 使用diff-only，不重写整个文件
3. 不添加未经允许的新依赖
4. 遵守PROJECT_RULES.md的所有规则
```

### **步骤5: 运行验证** ✅
```
按照任务卡的验证标准执行：
1. 运行所有测试（lint / test / typecheck）
2. 运行任务特定的验证（如：真实数据测试）
3. 记录验证结果（真实数据、截图、日志）
4. 确保无Mock、无占位、无跳过
```

### **步骤6: 更新任务卡** 📊
```
完成后必须更新：
1. 独立任务文件中的状态：⏳ 待开始 → ✅ 已完成
2. 填写实际执行时间
3. 填写测试结果
4. 记录遇到的问题和解决方案
5. 更新主任务卡的进度统计
6. 重命名任务文件：在文件名前加上✅标记
   例如：Task_1.1.1_创建WebSocket客户端基础类.md 
        → ✅Task_1.1.1_创建WebSocket客户端基础类.md
```

### **步骤7: 提交Git** 💾
```
每个任务完成后必须提交：
1. git mv <原任务文件> <✅任务文件>（重命名任务文件）
2. git add <所有修改的文件>
3. git commit -m "V13: Task_X.X.X 任务名称 - 简要描述"
4. 提交信息要清晰、包含任务编号
```

### **步骤8: 报告用户** 📢
```
向用户报告：
1. 任务完成情况
2. 验证结果（真实数据）
3. 遇到的问题和解决方案
4. 下一个任务预告
5. 是否需要用户决策
```

---

## 🚫 严格禁止事项

### **禁止清单**（违反任何一条都是严重错误）

#### 1. 禁止跳过任务
```
❌ 错误示例："Task_1.1.1看起来简单，我直接做Task_1.1.2吧"
✅ 正确做法：严格按1.1.1 → 1.1.2的顺序执行
```

#### 2. 禁止自行修改任务
```
❌ 错误示例："我觉得Task_1.1.1和1.1.2可以合并"
✅ 正确做法：先问用户："我发现1.1.1和1.1.2可以合并，是否需要修改任务卡？"
```

#### 3. 禁止超出Allowed files范围
```
❌ 错误示例：任务只允许修改src/websocket.py，却修改了src/trader.py
✅ 正确做法：发现需要修改其他文件时，停止并询问用户
```

#### 4. 禁止使用Mock/占位/跳过
```
❌ 错误示例：def connect(): pass  # TODO: 实现
✅ 正确做法：必须完整实现真实功能，用真实数据验证
```

#### 5. 禁止跳过验证
```
❌ 错误示例："代码写完了，应该能跑，不测了"
✅ 正确做法：必须运行所有验证标准，记录真实结果
```

#### 6. 禁止伪造验证结果
```
❌ 错误示例：编造"测试通过，准确率65%"
✅ 正确做法：运行真实测试，记录真实数据和日志
```

#### 7. 禁止未经确认就执行
```
❌ 错误示例：提出计划后立即开始写代码
✅ 正确做法：提出计划，等待用户明确说"可以"后再执行
```

#### 8. 禁止添加未经允许的依赖
```
❌ 错误示例：任务中未提到，却pip install pandas
✅ 正确做法：发现需要新依赖时，停止并询问用户
```

#### 9. 禁止重写整个文件
```
❌ 错误示例：用完整代码替换整个文件
✅ 正确做法：使用search_replace，只修改需要改的部分
```

#### 10. 禁止不提交Git
```
❌ 错误示例：任务完成了，但忘记提交Git
✅ 正确做法：每个任务完成后必须提交Git
```

---

## ⚠️ 质询触发条件

### **遇到以下情况时，必须停止并询问用户**：

#### 触发器1: 需求不清
```
问题："任务描述含糊，不确定具体要做什么"
行动：停止，向用户说明困惑，请求澄清
示例："Task_1.2.3说'优化OFI算法'，但没说具体优化什么，请问是优化速度还是准确性？"
```

#### 触发器2: 超出变更预算
```
问题："预估需要修改500行代码，但任务说'30分钟'"
行动：停止，向用户说明情况，请求调整
示例："Task_1.1.1预估30分钟，但实际需要2小时和200行代码，是否继续？"
```

#### 触发器3: 需要新依赖
```
问题："任务需要用到未在requirements.txt中的包"
行动：停止，向用户说明需求，请求批准
示例："Task_3.2.1需要使用scikit-learn，但requirements.txt中没有，是否允许添加？"
```

#### 触发器4: 无法用真实数据验证
```
问题："任务要求验证，但缺少真实数据或测试环境"
行动：停止，向用户说明困难，请求解决方案
示例："Task_1.1.6要求测试WebSocket，但没有币安API密钥，如何验证？"
```

#### 触发器5: 验证标准无法达标
```
问题："多次尝试后，验证标准仍未通过"
行动：停止，向用户报告情况，请求指导
示例："Task_1.3.3要求OFI准确率>55%，但实际只有45%，是否调整算法或阈值？"
```

#### 触发器6: 发现任务冲突
```
问题："当前任务与前面的任务存在冲突"
行动：停止，向用户说明冲突，请求决策
示例："Task_2.2.2要求OFI阈值>2.0，但Task_1.3.5决定用>1.5，应该用哪个？"
```

#### 触发器7: 需要修改接口
```
问题："任务需要改变函数签名或数据结构"
行动：停止，向用户说明影响，请求批准
示例："Task_1.2.4需要修改calculate_ofi()的返回值结构，会影响后续任务，是否允许？"
```

---

## 📊 任务状态定义

### **状态标记**：

| 状态 | 标记 | 含义 | 何时使用 |
|------|------|------|---------|
| **待开始** | ⏳ | 任务尚未开始 | 初始状态 |
| **进行中** | 🔄 | 任务正在执行 | 开始执行后 |
| **已完成** | ✅ | 任务完成并通过验证 | 验证通过后 |
| **有问题** | ⚠️ | 任务遇到问题，需要用户决策 | 遇到质询触发器时 |
| **已取消** | ❌ | 任务被用户取消 | 用户明确取消时 |

### **状态转换规则**：

```
⏳ 待开始 → 🔄 进行中（用户确认后）
🔄 进行中 → ✅ 已完成（验证通过后）
🔄 进行中 → ⚠️ 有问题（遇到问题时）
⚠️ 有问题 → 🔄 进行中（用户给出解决方案后）
⚠️ 有问题 → ❌ 已取消（用户决定取消时）
任何状态 → ❌ 已取消（用户明确取消时）
```

---

## 📝 任务卡结构说明

### **主任务卡**：`📋V13_TASK_CARD.md`
- 项目进度总览表格（必须实时更新）
- 所有阶段的高层次描述
- 任务卡维护记录

### **独立任务文件**：`TASKS/StageX/Task_X.X.X_XXX.md`
- 每个任务都有独立的MD文件
- 包含详细的任务清单、验证标准、DoD检查清单
- 执行时必须打开对应的任务文件

### **任务索引**：`TASKS/TASK_INDEX.md`
- 快速查找所有任务
- 按阶段分类

### **验证清单**：`TASKS/VERIFICATION_CHECKLIST.md`
- 检查所有任务文件是否存在
- 统计任务数量

---

## 🎯 特殊情况处理

### **情况1: 用户要求修改任务卡**
```
步骤：
1. 记录用户的修改要求
2. 确认具体修改内容（添加/删除/修改哪个任务）
3. 更新主任务卡和独立任务文件
4. 在"任务卡维护记录"中记录修改
5. 提交Git，注明"用户确认的修改"
```

### **情况2: 任务执行失败，需要重做**
```
步骤：
1. 分析失败原因
2. 向用户报告失败情况和原因
3. 提出解决方案或请求指导
4. 获得用户确认后重新执行
5. 在任务文件中记录"遇到的问题"和"解决方案"
```

### **情况3: 发现前面任务有Bug**
```
步骤：
1. 停止当前任务
2. 向用户报告发现的Bug和影响范围
3. 请求决策：是回退修复，还是继续并记录技术债
4. 按用户决策执行
5. 更新相关任务的维护记录
```

### **情况4: 用户要求跳过某个任务**
```
步骤：
1. 确认用户的明确指令
2. 更新任务状态为"❌ 已取消"
3. 在任务卡维护记录中记录"用户取消"
4. 评估跳过对后续任务的影响并报告
5. 继续下一个任务
```

### **情况5: 长时间运行的任务（如24小时测试）**
```
步骤：
1. 启动任务前向用户确认
2. 设置任务状态为"🔄 进行中（自动运行）"
3. 定期（如每小时）检查运行状态
4. 完成后收集结果，更新任务状态
5. 向用户报告完整结果
```

---

## 📈 进度追踪

### **每个任务完成后必须更新**：

#### 1. 独立任务文件
```markdown
- **任务状态**: ⏳ 待开始 → ✅ 已完成
- **实际时间**: 1小时30分钟
- **测试结果**: 全部通过，准确率58%
- **遇到的问题**: WebSocket连接不稳定
- **解决方案**: 添加重连机制
```

#### 2. 重命名任务文件（加上✅前缀）
```bash
# 在文件名前加上✅标记
git mv "TASKS/Stage1_真实OFI+CVD核心/Task_1.1.3_实现订单簿数据解析.md" \
       "TASKS/Stage1_真实OFI+CVD核心/✅Task_1.1.3_实现订单簿数据解析.md"
```

#### 3. 主任务卡进度表格
```markdown
| **阶段1: 真实OFI核心** | 16 | 3 | 1 | 12 | 🔄 进行中 |
                                  ↑更新已完成数量
```

#### 4. Git提交
```bash
git commit -m "V13: Task_1.1.3 实现订单簿数据解析 - 完成
- 解析JSON数据
- 提取5档买卖单
- 添加时间戳
- 测试通过，数据完整性100%"
```

---

## ✅ DoD（Definition of Done）检查清单

### **每个任务完成的标准**（缺一不可）：

- [ ] **代码无语法错误** - 能正常运行
- [ ] **通过lint检查** - 代码风格符合规范
- [ ] **通过所有测试** - 单元测试、集成测试全部通过
- [ ] **无Mock/占位/跳过** - 所有功能真实实现
- [ ] **产出真实验证结果** - 有真实数据、日志、截图
- [ ] **性能达标** - 延迟、准确率等指标符合要求
- [ ] **更新相关文档** - 任务文件、README等
- [ ] **重命名任务文件** - 在文件名前加上✅标记
- [ ] **提交Git** - 代码已提交，提交信息清晰
- [ ] **用户确认** - 用户查看结果并确认满意

---

## 🔄 AI助手自查清单

### **开始任务前**：
- [ ] 我是否查阅了📜TASK_CARD_RULES.md？
- [ ] 我是否查阅了📜PROJECT_RULES.md？
- [ ] 我是否打开了当前任务的独立MD文件？
- [ ] 我是否确认了前置任务已完成？
- [ ] 我是否等待用户明确确认？

### **执行任务中**：
- [ ] 我是否只修改Allowed files中的文件？
- [ ] 我是否使用真实数据，没有Mock？
- [ ] 我是否遵守了所有PROJECT_RULES？
- [ ] 我是否在超出范围时停止并询问用户？

### **任务完成后**：
- [ ] 我是否运行了所有验证标准？
- [ ] 我是否记录了真实的验证结果？
- [ ] 我是否更新了任务状态和进度？
- [ ] 我是否重命名了任务文件（加上✅前缀）？
- [ ] 我是否提交了Git？
- [ ] 我是否向用户报告了结果？

---

## 📞 与用户沟通模板

### **开始任务时**：
```
📋 准备开始 Task_X.X.X: [任务名称]

📝 执行计划：
1. 修改文件：[列出文件]
2. 预估时间：[时间]
3. 主要工作：[简要描述]
4. 验证方式：[如何验证]

❓ 是否开始执行？
```

### **遇到问题时**：
```
⚠️ Task_X.X.X 遇到问题

问题描述：[具体问题]
影响范围：[影响哪些任务]
可能方案：
  方案1: [描述 + 优缺点]
  方案2: [描述 + 优缺点]

❓ 请选择方案或给出其他指导
```

### **任务完成时**：
```
✅ Task_X.X.X: [任务名称] - 完成

执行结果：
- 实际时间：[时间]
- 修改文件：[列出]
- 代码行数：[行数]

验证结果：
- [验证项1]: ✅ 通过 ([数据])
- [验证项2]: ✅ 通过 ([数据])

下一个任务：Task_X.X.X+1: [名称]

❓ 是否继续？
```

---

## 📚 快速参考

### **关键文档链接**：
- 📜 本规则：`v13_ofi_ai_system/📜TASK_CARD_RULES.md`
- 📜 项目规则：`v13_ofi_ai_system/📜PROJECT_RULES.md`
- 📋 主任务卡：`v13_ofi_ai_system/📋V13_TASK_CARD.md`
- 📁 独立任务：`v13_ofi_ai_system/TASKS/StageX/Task_X.X.X_XXX.md`
- 📑 任务索引：`v13_ofi_ai_system/TASKS/TASK_INDEX.md`
- 🎯 开发指导：`v13_ofi_ai_system/docs/🎯V13_FRESH_START_DEVELOPMENT_GUIDE.md`

### **任务总览**：
- **阶段0**: 准备工作（5个任务）✅ 已完成
- **阶段1**: 真实OFI+CVD核心（22个任务）⏳ 待开始
- **阶段2**: 简单真实交易（12个任务）⏳ 待开始
- **阶段3**: 逐步加入AI（10个任务）⏳ 待开始
- **阶段4**: 深度学习优化（8个任务，可选）⏳ 待开始
- **总计**: 57个任务

---

**版本**: V1.0.0  
**创建时间**: 2025-01-17  
**适用范围**: V13 OFI+AI项目的所有任务执行  
**优先级**: 🔴 最高 - 执行任何任务前必须查阅  

---

## 🎯 一句话总结

> **"用户确认 → 查阅规则 → 制定计划 → 等待批准 → 真实执行 → 完整验证 → 更新状态 → 提交Git → 报告用户"**

**违反任何一条规则都是严重错误，必须立即纠正！**

