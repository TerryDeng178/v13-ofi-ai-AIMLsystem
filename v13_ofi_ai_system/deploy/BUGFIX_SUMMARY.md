# 修复"运行一段时间后不再落盘"BUG总结

## 修复完成日期
2025-10-27

## 修复的问题

### 核心问题
运行一段时间后，数据采集进程停止保存文件到磁盘。

### 根本原因
根据代码分析，发现以下几个关键BUG：

1. **NTP回拨导致轮转条件永久为假**：使用 `datetime.now().timestamp()` 和 `time.time()` 作为轮转时钟，遇到NTP回拨会导致轮转条件永久不满足
2. **健康检查"自杀式停机"**：网络抖动导致错误计数累积，达到阈值后直接 `running=False` 停机
3. **错误计数累加不会衰减**：所有symbol的错误都累加到一个全局计数器，无法区分临时抖动和真正故障
4. **轮转只在收到消息时触发**：如果数据流短暂卡住但还没超时，缓冲区数据不会刷盘
5. **写失败也更新轮转时间**：保存失败后仍更新轮转时间，导致要等下一轮间隔才重试

## 应用的修复补丁

### 补丁A：使用单调时钟
**位置**：初始化方法、`_check_and_rotate_data`、`_generate_slices_manifest`、`_check_health`

**修改内容**：
- 添加 `self._mono = time.monotonic` 作为单调时钟
- 将所有轮转和健康检查的时间计算改用单调时钟
- 数据接收时间 `last_data_time` 也改用单调时钟

**效果**：避免NTP回拨/跳变导致轮转条件失效

### 补丁B：健康检查不再"自杀"
**位置**：`_check_health`、`_health_check_loop`

**修改内容**：
1. 移除 `running=False` 自杀逻辑
2. 错误计数达到阈值时，增加 `reconnect_count` 并清零 `connection_errors`，返回 True
3. 任一symbol恢复时，错误计数减1（最低为0）
4. 在健康检查循环中定时触发轮转

**效果**：
- 进程不会因临时网络抖动而停机
- 即使数据流卡住，仍能按时刷盘

### 补丁C：只有写成功才更新轮转时间
**位置**：`_check_and_rotate_data`

**修改内容**：
1. 添加 `any_saved` 标志跟踪保存状态
2. 保存后检查缓冲区是否被清空（判定成功）
3. 只有 `any_saved=True` 时才更新 `last_rotate_time`

**效果**：
- 保存失败后不等待下一轮间隔，下次健康检查立即重试

### 补丁D：增强日志信息
**位置**：`_save_data` 异常处理

**修改内容**：
- 错误日志增加异常类型信息

**效果**：
- 更快速定位保存失败原因

## 测试验证建议

### 1. NTP回拨测试
```bash
# 模拟NTP回拨（需要root权限）
# Linux:
sudo date -s "-1 hour"

# 观察进程日志，确认仍能按 PARQUET_ROTATE_SEC 正常落盘
```

### 2. 网络抖动恢复测试
```bash
# 模拟断网
sudo ifconfig <interface> down
# 等待5-8分钟后恢复
sudo ifconfig <interface> up

# 观察：
# - 进程不会停机（running=True）
# - 恢复后1-2分钟内继续落盘
```

### 3. 写失败恢复测试
```bash
# 模拟写失败
chmod 555 deploy/data/ofi_cvd/  # 设为只读
# 等待几个轮转周期
chmod 755 deploy/data/ofi_cvd/  # 恢复可写

# 观察：
# - 写失败后立即在下一次健康检查重试
# - 不会等到下一轮 PARQUET_ROTATE_SEC 间隔
```

## 代码变更清单

### 修改的文件
1. `v13_ofi_ai_system/deploy/run_success_harvest.py`
   - 第225行：添加单调时钟预算
   - 第228-233行：健康监控使用单调时钟
   - 第243-246行：轮转定时器使用单调时钟
   - 第271-301行：`_check_health` 方法重构
   - 第303-305行：`_update_data_time` 使用单调时钟
   - 第1430-1464行：`_check_and_rotate_data` 添加成功判断
   - 第1468行：`_generate_slices_manifest` 使用单调时钟
   - 第1639-1653行：`_health_check_loop` 移除自杀逻辑并触发轮转
   - 第1426行：异常日志增强

### 新增的诊断工具
1. `v13_ofi_ai_system/deploy/bug_analysis.md` - 详细BUG分析报告
2. `v13_ofi_ai_system/deploy/diagnose_harvest.py` - 运行时诊断脚本
3. `v13_ofi_ai_system/deploy/BUGFIX_SUMMARY.md` - 本文件

## 预期效果

修复后，数据采集进程应该能够：

1. **持续稳定运行**：不因网络抖动停机
2. **及时落盘**：即使数据流卡住，健康检查循环仍会触发轮转
3. **快速恢复**：保存失败后不等待，下次健康检查立即重试
4. **NTP免疫**：不受系统时间跳变影响

## 注意事项

1. **事件时间戳（ts_ms）仍使用交易/订单簿自带的时间戳**，不受影响
2. **需要重新启动进程**才能应用修复
3团队的**数据中心/NTP策略**可能需要配合调整
4. **建议监控**：
   - 进程内存使用趋势
   - 轮转成功/失败次数
   - 错误日志中的异常类型

## 后续优化建议

1. 添加缓冲区大小监控和报警
2. 添加保存失败重试次数限制
3. 添加磁盘空间检查
4. 考虑使用持久化队列（如Redis）避免内存积累

