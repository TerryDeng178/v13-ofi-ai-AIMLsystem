# Task 0.7 å®æ–½çŠ¶æ€æŠ¥å‘Š

## ğŸ“… åŸºæœ¬ä¿¡æ¯

- **ä»»åŠ¡åç§°**: åŠ¨æ€æ¨¡å¼åˆ‡æ¢ä¸å·®å¼‚åŒ–é…ç½®
- **å¼€å§‹æ—¶é—´**: 2025-10-19 05:00
- **å½“å‰çŠ¶æ€**: â³ è¿›è¡Œä¸­ï¼ˆé˜¶æ®µ2å·²å®Œæˆï¼‰
- **é¢„è®¡å®Œæˆ**: 2025-10-19 17:00
- **å®é™…è¿›åº¦**: 50% ï¼ˆ6-8å°æ—¶ / 12-16å°æ—¶ï¼‰

---

## âœ… å·²å®Œæˆå·¥ä½œ

### é˜¶æ®µ1: é…ç½®ç»“æ„è®¾è®¡ï¼ˆâœ… 100%ï¼‰

#### 1.1 æ‰©å±• system.yaml âœ…

**å®Œæˆå†…å®¹**:
- âœ… æ·»åŠ  `strategy` é…ç½®æ®µ
  - æ¨¡å¼é€‰æ‹©: `mode: auto | active | quiet`
  - è¿Ÿæ»å‚æ•°: `hysteresis` é…ç½®
  - è§¦å‘å™¨: `triggers.schedule` å’Œ `triggers.market`
  - åˆ†æ¨¡å¼å‚æ•°: `params.{ofi,cvd,risk,performance}.{active,quiet}`

**é’ˆå¯¹æ•°å­—èµ„äº§å¸‚åœºçš„ç‰¹æ®Šä¼˜åŒ–**:
- âœ… æ—¶åŒºè®¾ç½®: `Asia/Hong_Kong`
- âœ… äº¤æ˜“æ—¥å†: `calendar: CRYPTO` (24/7å…¨å¤©å€™)
- âœ… å·¥ä½œæ—¥: `[Mon-Sun]` (7å¤©æ— ä¼‘)
- âœ… èŠ‚å‡æ—¥: `[]` (æ— èŠ‚å‡æ—¥)
- âœ… 4ä¸ªæ´»è·ƒæ—¶æ®µ:
  - 09:00-12:00 (äºšæ´²æ—©ç›˜)
  - 14:00-17:00 (äºšæ´²åˆå)
  - 21:00-02:00 (æ¬§ç¾é«˜å³°ï¼Œæœ€é‡è¦)
  - 06:00-08:00 (ç¾æ´²å¤œç›˜)
- âœ… å¸‚åœºæŒ‡æ ‡é˜ˆå€¼æé«˜:
  - `min_trades_per_min: 500` (vs è‚¡ç¥¨200)
  - `min_quote_updates_per_sec: 100` (vs è‚¡ç¥¨50)
  - `max_spread_bps: 5` (vs è‚¡ç¥¨8)
  - `min_volatility_bps: 10` (vs è‚¡ç¥¨5)
  - æ–°å¢: `min_volume_usd: 1000000`

#### 1.2 æ›´æ–° logging é…ç½® âœ…

- âœ… æ·»åŠ  `level_by_mode` é…ç½®
  - `active: INFO`
  - `quiet: INFO`

#### 1.3 æ›´æ–° features é…ç½® âœ…

- âœ… æ·»åŠ  `features.strategy` æ®µ
  - `dynamic_mode_enabled: true`
  - `throttle_in_quiet: true`
  - `sample_ratio_quiet: 0.3`
  - `dry_run: false`
  - `cli_override_priority: true`

### é˜¶æ®µ2: æ¨¡å¼ç®¡ç†å™¨å®ç°ï¼ˆâœ… 80%ï¼‰

#### 2.1 åˆ›å»º strategy_mode_manager.py âœ…

**æ ¸å¿ƒç±»**:
- âœ… `StrategyMode` æšä¸¾ (ACTIVE/QUIET)
- âœ… `TriggerReason` æšä¸¾ (SCHEDULE/MARKET/MANUAL/HYSTERESIS)
- âœ… `MarketActivity` æ•°æ®ç±»
- âœ… `StrategyModeManager` ä¸»ç±»

**æ ¸å¿ƒæ–¹æ³•**:
- âœ… `__init__()` - åˆå§‹åŒ–ç®¡ç†å™¨
- âœ… `check_schedule_active()` - æ—¶é—´è¡¨åˆ¤å®š
- âœ… `check_market_active()` - å¸‚åœºæ´»è·ƒåº¦åˆ¤å®š
- âœ… `decide_mode()` - æ¨¡å¼å†³ç­–ï¼ˆå«è¿Ÿæ»é€»è¾‘ï¼‰
- âœ… `apply_params()` - åŸå­å‚æ•°åº”ç”¨ï¼ˆCopy-on-Writeï¼‰
- âœ… `update_mode()` - ä¸»æ›´æ–°å…¥å£
- âœ… `get_current_mode()` - è·å–å½“å‰æ¨¡å¼
- âœ… `get_mode_stats()` - è·å–ç»Ÿè®¡ä¿¡æ¯

**å…³é”®ç‰¹æ€§**:
- âœ… æ”¯æŒè·¨åˆå¤œæ—¶é—´çª—å£ï¼ˆå¦‚21:00-02:00ï¼‰
- âœ… æ—¶åŒºæ„ŸçŸ¥ï¼ˆpytzï¼‰
- âœ… è¿Ÿæ»é€»è¾‘ï¼ˆé˜²æŠ–ï¼‰
- âœ… åŸå­çƒ­æ›´æ–°ï¼ˆRCUé”ï¼‰
- âœ… å¹²è·‘æ¨¡å¼ï¼ˆdry_runï¼‰
- âœ… æ‰‹åŠ¨å›ºå®šæ¨¡å¼æ”¯æŒ
- âœ… Windows UTF-8å…¼å®¹

**æµ‹è¯•ç»“æœ**:
```
âœ… Current mode: quiet
âœ… Schedule active: False
âœ… Market active: True
ğŸ“Š Mode statsæ­£å¸¸è¾“å‡º
```

#### 2.2 å‚æ•°åˆ†å‘æœºåˆ¶ â³ï¼ˆå¾…é›†æˆï¼‰

**çŠ¶æ€**: æ¡†æ¶å·²å®Œæˆï¼Œéœ€è¦ä¸å®é™…æ¨¡å—é›†æˆ

**å¾…é›†æˆæ¨¡å—**:
- â³ OFI æ¨¡å—å‚æ•°åˆ·æ–°
- â³ CVD æ¨¡å—å‚æ•°åˆ·æ–°
- â³ Risk æ¨¡å—å‚æ•°åˆ·æ–°
- â³ Performance æ¨¡å—å‚æ•°åˆ·æ–°
- â³ Logging æ¨¡å—å‚æ•°åˆ·æ–°

---

## ğŸ“‹ è¿›è¡Œä¸­å·¥ä½œ

### é˜¶æ®µ3: è§‚æµ‹ä¸ç›‘æ§ï¼ˆâ³ 0%ï¼‰

- â³ Prometheus æŒ‡æ ‡æ³¨å†Œ
- â³ ç»“æ„åŒ–æ—¥å¿—å®ç°
- â³ å‘Šè­¦è§„åˆ™è‰æ¡ˆ

### é˜¶æ®µ4: æµ‹è¯•ä¸éªŒè¯ï¼ˆâ³ 0%ï¼‰

- â³ å•å…ƒæµ‹è¯•
- â³ é›†æˆæµ‹è¯•
- â³ æ–‡æ¡£æ›´æ–°

---

## ğŸ¯ æ ¸å¿ƒè®¾è®¡å†³ç­–

### 1. æ•°å­—èµ„äº§å¸‚åœºé€‚é… âœ…

**å†³ç­–**: å®Œå…¨é’ˆå¯¹æ•°å­—èµ„äº§ï¼ˆåŠ å¯†è´§å¸ï¼‰å¸‚åœºç‰¹æ€§è¿›è¡Œä¼˜åŒ–

**ç†ç”±**:
- 24/7å…¨å¤©å€™äº¤æ˜“ï¼Œæ— å‘¨æœ«æ— èŠ‚å‡æ—¥
- é«˜é¢‘ã€é«˜æ³¢åŠ¨ã€é«˜æµåŠ¨æ€§
- å…¨çƒæ—¶æ®µè½®è½¬ï¼ˆäºšæ´²â†’æ¬§æ´²â†’ç¾æ´²ï¼‰
- æ¬§ç¾æ—¶æ®µï¼ˆ21:00-02:00 HKTï¼‰æ˜¯æœ€æ´»è·ƒæ—¶æ®µ

**å®æ–½**:
- `calendar: CRYPTO`
- 7å¤©å·¥ä½œæ—¥
- 4ä¸ªæ—¶æ®µè¦†ç›–å…¨çƒé«˜å³°
- æé«˜æ‰€æœ‰å¸‚åœºæŒ‡æ ‡é˜ˆå€¼
- å‡Œæ™¨ä½è°·ï¼ˆ03:00-06:00ï¼‰ä¸åœ¨æ´»è·ƒçª—å£

### 2. åŸå­çƒ­æ›´æ–°æœºåˆ¶ âœ…

**å†³ç­–**: é‡‡ç”¨Copy-on-Write/RCUæ¨¡å¼

**ç†ç”±**:
- ä¿è¯å‚æ•°æ›´æ–°çš„åŸå­æ€§ï¼ˆå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å›æ»šï¼‰
- è¯»æ“ä½œä¸é˜»å¡ï¼ˆä½¿ç”¨æ—§å¿«ç…§ï¼‰
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šï¼Œä¸å…è®¸åŠç”Ÿæ•ˆçŠ¶æ€

**å®æ–½**:
- `threading.RLock()` ä¿æŠ¤å‚æ•°åˆ‡æ¢
- åˆ›å»ºæ–°å‚æ•°å¿«ç…§â†’åº”ç”¨â†’ç¡®è®¤/å›æ»š
- è®°å½•å¤±è´¥æ¨¡å—ï¼Œä¾¿äºè¯Šæ–­

### 3. è¿Ÿæ»é€»è¾‘ï¼ˆé˜²æŠ–ï¼‰âœ…

**å†³ç­–**: ä½¿ç”¨çª—å£è®¡æ•°æ–¹å¼é˜²æ­¢é¢‘ç¹åˆ‡æ¢

**ç†ç”±**:
- é¿å…è¾¹ç•Œæ¡ä»¶å¯¼è‡´çš„æŠ–åŠ¨
- `min_active_windows=3`: è¿ç»­3ä¸ªçª—å£æ»¡è¶³æ‰åˆ‡åˆ°active
- `min_quiet_windows=6`: è¿ç»­6ä¸ªçª—å£ä¸æ»¡è¶³æ‰åˆ‡å›quiet
- åˆ‡æ¢é˜ˆå€¼ä¸å¯¹ç§°ï¼ˆ6>3ï¼‰ï¼Œå€¾å‘äºä¿æŒactiveçŠ¶æ€

**å®æ–½**:
- `activity_history` dequeè®°å½•å†å²åˆ¤å®š
- æ»‘åŠ¨çª—å£æ£€æŸ¥è¿ç»­æ€§
- ä¿æŒå½“å‰æ¨¡å¼ç›´åˆ°æ»¡è¶³åˆ‡æ¢æ¡ä»¶

### 4. äºŒå…ƒè§¦å‘å™¨ âœ…

**å†³ç­–**: æ—¶é—´è¡¨è§¦å‘ OR å¸‚åœºè§¦å‘

**ç†ç”±**:
- æ—¶é—´è¡¨ï¼šåŸºäºå†å²ç»éªŒçš„å…ˆéªŒåˆ¤æ–­
- å¸‚åœºæŒ‡æ ‡ï¼šåŸºäºå®æ—¶æ•°æ®çš„åéªŒåˆ¤æ–­
- ä»»ä¸€æ»¡è¶³å³ä¸ºæ´»è·ƒï¼ˆORé€»è¾‘ï¼‰

**å®æ–½**:
- `schedule_active = check_schedule_active()`
- `market_active = check_market_active(activity)`
- `is_active = schedule_active OR market_active`

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•åœºæ™¯ï¼ˆå¾…å®æ–½ï¼‰

- [ ] æ—¶é—´è¡¨åˆ¤å®šï¼ˆå«è·¨åˆå¤œï¼‰
- [ ] å¸‚åœºæŒ‡æ ‡åˆ¤å®šï¼ˆå¤šæ¡ä»¶ç»„åˆï¼‰
- [ ] è¿Ÿæ»é€»è¾‘ï¼ˆé˜²æŠ–ï¼‰
- [ ] å‚æ•°çƒ­æ›´æ–°ï¼ˆæˆåŠŸ/å¤±è´¥/å›æ»šï¼‰
- [ ] ç¯å¢ƒå˜é‡è¦†ç›–
- [ ] æ—¶åŒºè¾¹ç•Œæµ‹è¯•
- [ ] èŠ‚å‡æ—¥åˆ¤å®š
- [ ] å‘¨æœ«åˆ¤å®š

### é›†æˆæµ‹è¯•åœºæ™¯ï¼ˆå¾…å®æ–½ï¼‰

- [ ] é«˜é¢‘â†’å®‰é™â†’é«˜é¢‘çš„ç«¯åˆ°ç«¯åˆ‡æ¢
- [ ] å‚æ•°ç”Ÿæ•ˆéªŒè¯ï¼ˆ6é¡¹å·®å¼‚åŒ–é”®æŠ½æŸ¥ï¼‰
- [ ] é•¿æ—¶é—´ç¨³å®šæ€§ï¼ˆâ‰¥4å°æ—¶ï¼‰
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆCPUã€å†…å­˜ã€å»¶è¿Ÿï¼‰

---

## ğŸ”— æ–‡ä»¶æ¸…å•

### é…ç½®æ–‡ä»¶

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `config/system.yaml` | âœ… å·²æ›´æ–° | æ–°å¢strategyé…ç½®æ®µ |
| `config/environments/development.yaml` | â³ å¾…æ›´æ–° | å¼€å‘ç¯å¢ƒå·®å¼‚åŒ–é…ç½® |
| `config/environments/testing.yaml` | â³ å¾…æ›´æ–° | æµ‹è¯•ç¯å¢ƒå·®å¼‚åŒ–é…ç½® |
| `config/environments/production.yaml` | â³ å¾…æ›´æ–° | ç”Ÿäº§ç¯å¢ƒå·®å¼‚åŒ–é…ç½® |

### ä»£ç æ¨¡å—

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `src/utils/strategy_mode_manager.py` | âœ… å·²åˆ›å»º | æ¨¡å¼ç®¡ç†å™¨ä¸»æ¨¡å—ï¼ˆ600è¡Œï¼‰ |

### æ–‡æ¡£

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `TASKS/Stage0_å‡†å¤‡å·¥ä½œ/Task_0.7_åŠ¨æ€æ¨¡å¼åˆ‡æ¢ä¸å·®å¼‚åŒ–é…ç½®.md` | âœ… å·²å®Œæˆ | ä»»åŠ¡å¡ï¼ˆå«æ•°å­—èµ„äº§ä¼˜åŒ–ï¼‰ |
| `TASKS/Stage0_å‡†å¤‡å·¥ä½œ/Task_0.7_CRYPTO_MARKET_CONSIDERATIONS.md` | âœ… å·²åˆ›å»º | æ•°å­—èµ„äº§å¸‚åœºç‰¹æ®Šè€ƒè™‘ï¼ˆ263è¡Œï¼‰ |
| `TASKS/Stage0_å‡†å¤‡å·¥ä½œ/Task_0.7_IMPLEMENTATION_STATUS.md` | âœ… å·²åˆ›å»º | æœ¬å®æ–½çŠ¶æ€æŠ¥å‘Š |
| `config/README.md` | â³ å¾…æ›´æ–° | æ·»åŠ ç­–ç•¥æ¨¡å¼åˆ‡æ¢ç« èŠ‚ |
| `docs/STRATEGY_MODE_SWITCHING_GUIDE.md` | â³ å¾…åˆ›å»º | è¯¦ç»†è®¾è®¡æ–‡æ¡£ |

---

## âš ï¸ å¾…è§£å†³é—®é¢˜

### é«˜ä¼˜å…ˆçº§

1. **å‚æ•°åˆ†å‘é›†æˆ** âš ï¸
   - å½“å‰ `apply_params()` æ˜¯ç©ºå£³ï¼Œéœ€è¦ä¸å®é™…OFI/CVD/Riskæ¨¡å—é›†æˆ
   - å»ºè®®: å…ˆå®ç°CVDæ¨¡å—çš„å‚æ•°çƒ­æ›´æ–°ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

2. **PrometheusæŒ‡æ ‡é›†æˆ** âš ï¸
   - éœ€è¦æ·»åŠ 13ä¸ªç­–ç•¥ç›¸å…³æŒ‡æ ‡
   - éœ€è¦ä¸ç°æœ‰ç›‘æ§ç³»ç»Ÿé›†æˆ

3. **ç¯å¢ƒç‰¹å®šé…ç½®** âš ï¸
   - `development.yaml`ã€`testing.yaml`ã€`production.yaml` éœ€è¦é’ˆå¯¹ç­–ç•¥æ¨¡å¼æ·»åŠ å·®å¼‚åŒ–é…ç½®

### ä¸­ä¼˜å…ˆçº§

4. **å•å…ƒæµ‹è¯•** âš¡
   - è‡³å°‘éœ€è¦20+æµ‹è¯•ç”¨ä¾‹
   - è¦†ç›–è¾¹ç•Œæ¡ä»¶ï¼ˆè·¨åˆå¤œã€æ—¶åŒºã€èŠ‚å‡æ—¥ç­‰ï¼‰

5. **é›†æˆæµ‹è¯•** âš¡
   - ç«¯åˆ°ç«¯éªŒè¯
   - é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•

6. **æ–‡æ¡£å®Œå–„** âš¡
   - æ›´æ–° `config/README.md`
   - åˆ›å»º `STRATEGY_MODE_SWITCHING_GUIDE.md`

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¯åšï¼ˆä¼˜å…ˆçº§æ’åºï¼‰

1. **åˆ›å»ºç¯å¢ƒç‰¹å®šé…ç½®**ï¼ˆ20åˆ†é’Ÿï¼‰
   - ä¸º `development.yaml`ã€`testing.yaml`ã€`production.yaml` æ·»åŠ ç­–ç•¥å·®å¼‚åŒ–é…ç½®

2. **å®ç°PrometheusæŒ‡æ ‡**ï¼ˆ1-2å°æ—¶ï¼‰
   - æ³¨å†Œ13ä¸ªç­–ç•¥ç›¸å…³æŒ‡æ ‡
   - åœ¨ `update_mode()` ä¸­æ›´æ–°æŒ‡æ ‡

3. **å®ç°ç»“æ„åŒ–æ—¥å¿—**ï¼ˆ30åˆ†é’Ÿï¼‰
   - å®Œå–„ `mode_changed` äº‹ä»¶æ—¥å¿—
   - æ·»åŠ  `params_diff` ç™½åå•

4. **CVDå‚æ•°çƒ­æ›´æ–°é›†æˆ**ï¼ˆ2-3å°æ—¶ï¼‰
   - ä¸ `real_cvd_calculator.py` é›†æˆ
   - å®ç° `apply_params()` çš„CVDéƒ¨åˆ†

5. **å•å…ƒæµ‹è¯•**ï¼ˆ3-4å°æ—¶ï¼‰
   - åˆ›å»º `tests/test_strategy_mode_manager.py`
   - è‡³å°‘20+æµ‹è¯•ç”¨ä¾‹

6. **æ–‡æ¡£æ›´æ–°**ï¼ˆ1-2å°æ—¶ï¼‰
   - æ›´æ–° `config/README.md`
   - åˆ›å»ºè¯¦ç»†è®¾è®¡æ–‡æ¡£

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

### 1. è·¨åˆå¤œæ—¶é—´çª—å£æ”¯æŒ âœ¨

```python
def _is_in_time_window(self, current_mins: int, window: Tuple[int, int]) -> bool:
    start, end = window
    if end > start:
        # æ­£å¸¸çª—å£ï¼š09:00-12:00
        return start <= current_mins < end
    else:
        # è·¨åˆå¤œçª—å£ï¼š21:00-02:00
        return current_mins >= start or current_mins < end
```

### 2. åŸå­çƒ­æ›´æ–°ï¼ˆRCUé”ï¼‰âœ¨

```python
with self.params_lock:
    try:
        # åˆ›å»ºæ–°å‚æ•°å¿«ç…§
        new_params = self._create_params_snapshot(mode)
        # åŸå­åº”ç”¨
        self._apply_to_modules(new_params)
        self.current_params = new_params
    except Exception as e:
        # è‡ªåŠ¨å›æ»š
        logger.error(f"Failed, rolling back: {e}")
        return False, [failed_module]
```

### 3. è¿Ÿæ»é€»è¾‘ï¼ˆé˜²æŠ–ï¼‰âœ¨

```python
# è¿ç»­Nä¸ªçª—å£æ»¡è¶³activeæ¡ä»¶æ‰åˆ‡æ¢
recent_active = [h[1] for h in list(self.activity_history)[-self.min_active_windows:]]
if all(recent_active) and self.current_mode == StrategyMode.QUIET:
    return StrategyMode.ACTIVE, TriggerReason.SCHEDULE, triggers
```

---

## ğŸ‰ é‡Œç¨‹ç¢‘

- âœ… **M1**: é…ç½®ç»“æ„è®¾è®¡å®Œæˆï¼ˆ2025-10-19 05:30ï¼‰
- âœ… **M2**: æ ¸å¿ƒç®¡ç†å™¨å®ç°å®Œæˆï¼ˆ2025-10-19 05:50ï¼‰
- â³ **M3**: è§‚æµ‹ä¸ç›‘æ§å®Œæˆï¼ˆé¢„è®¡ 06:30ï¼‰
- â³ **M4**: æµ‹è¯•ä¸éªŒè¯å®Œæˆï¼ˆé¢„è®¡ 08:00ï¼‰
- â³ **M5**: ä»»åŠ¡æ•´ä½“å®Œæˆï¼ˆé¢„è®¡ 09:00ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-19 05:50  
**è´Ÿè´£äºº**: AI Assistant  
**å®¡æ ¸äºº**: USER

