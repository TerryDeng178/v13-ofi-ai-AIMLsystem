# Task 1.3.1 (v2): æ”¶é›†å†å²OFI+CVDæ•°æ®ï¼ˆå¯ç›´æ¥æ‰§è¡Œï¼‰

## ğŸ“‹ ä»»åŠ¡ä¿¡æ¯
- **ä»»åŠ¡ç¼–å·**: Task_1.3.1 (v2)
- **æ‰€å±é˜¶æ®µ**: é˜¶æ®µ1 - çœŸå®OFI+CVDæ ¸å¿ƒ
- **ä»»åŠ¡çŠ¶æ€**: â³ å¾…å¼€å§‹
- **ä¼˜å…ˆçº§**: é«˜
- **é¢„è®¡æ—¶é—´**: 48-72å°æ—¶ï¼ˆè‡ªåŠ¨è¿è¡Œï¼‰
- **å®é™…æ—¶é—´**: (å®Œæˆåå¡«å†™)

## ğŸ¯ ä»»åŠ¡ç›®æ ‡ï¼ˆæ›´å¯éªŒè¯ï¼‰

è¿ç»­é‡‡é›†48å°æ—¶ï¼ˆå»ºè®®72hï¼‰BTCUSDTã€ETHUSDTï¼ˆå¯å¢å‡ï¼‰å®æ—¶æ•°æ®ï¼Œè¦†ç›–é«˜/ä¸­/ä½æ´»è·ƒæ—¶æ®µã€‚

äº§å‡º5ç±»åˆ†åŒºåŒ–æ•°æ®é›†ï¼ˆParquetï¼‰ï¼šprices, ofi, cvd, fusion, eventsã€‚

ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Šï¼ˆå®Œæ•´æ€§/å»é‡/æ—¶é’Ÿ/å»¶è¿Ÿ/ä¿¡å·é‡ï¼‰ç”¨äºTask 1.3.2çš„åˆ†æè¾“å…¥ã€‚

## ğŸ“¦ äº§å‡ºä¸ç›®å½•ç»“æ„

```
data/ofi_cvd/
  date=YYYY-MM-DD/
    symbol=BTCUSDT/
      kind=prices|ofi|cvd|fusion|events/
        part-*.parquet
    symbol=ETHUSDT/...
artifacts/
  run_logs/harvest_YYYYMMDD_HHMM.log
  dq_reports/dq_YYYYMMDD.json
```

### è¡¨ç»“æ„ï¼ˆæœ€å°‘å­—æ®µï¼‰

**prices**: ts_ms, event_ts_ms, symbol, price, qty, agg_trade_id, latency_ms, recv_rate_tps

**ofi**: ts_ms, symbol, ofi_value, ofi_z, scale, regime

**cvd**: ts_ms, symbol, cvd, delta, z_raw, z_cvd, scale, sigma_floor, floor_used, regime

**fusion**: ts_ms, symbol, score, score_z, regime

**events**ï¼ˆèƒŒç¦»/æ¢è½´/å¼‚å¸¸ï¼‰: ts_ms, symbol, event_type, meta_json

**å‹ç¼©**: Snappyï¼›**åˆ†åŒº**: dateã€symbolã€kindï¼›**æ»šåŠ¨å†™å…¥**: æ¯60ç§’ä¸€ä¸ªæ–‡ä»¶ã€‚

## ğŸ“ ä»»åŠ¡æ¸…å•
- [ ] åˆ›å»ºç»Ÿä¸€æ•°æ®é‡‡é›†è„šæœ¬run_success_harvest.py
- [ ] è®¾ç½®ç¯å¢ƒå˜é‡å’Œé…ç½®å‚æ•°
- [ ] è¿è¡Œ10åˆ†é’Ÿé¢„æ£€ï¼ˆè¿ç»­æ€§/å»é‡ç‡/æ—¶é—´æ¼‚ç§»/å°æ ·æœ¬DoDï¼‰
- [ ] è¿ç»­é‡‡é›†48-72å°æ—¶BTCUSDTã€ETHUSDTæ•°æ®
- [ ] ç”Ÿæˆ5ç±»åˆ†åŒºåŒ–Parquetæ•°æ®é›†
- [ ] åˆ›å»ºæ•°æ®è´¨é‡éªŒè¯è„šæœ¬
- [ ] è®¾ç½®Prometheusç›‘æ§å’ŒGrafanaä»ªè¡¨æ¿
- [ ] ç”Ÿæˆæ•°æ®è´¨é‡æŠ¥å‘Š
- [ ] éªŒè¯DoDéªŒæ”¶æ ‡å‡†

## ğŸ“¦ Allowed Files
- `v13_ofi_ai_system/examples/run_success_harvest.py` (ç»Ÿä¸€é‡‡é›†è„šæœ¬)
- `v13_ofi_ai_system/scripts/validate_ofi_cvd_harvest.py` (éªŒè¯è„šæœ¬)
- `v13_ofi_ai_system/data/ofi_cvd/` (æ•°æ®æ–‡ä»¶)
- `v13_ofi_ai_system/artifacts/` (æ—¥å¿—å’ŒæŠ¥å‘Š)

## ğŸ“š ä¾èµ–é¡¹
- **å‰ç½®ä»»åŠ¡**: Task_1.2.13 (CVD Z-scoreå¾®è°ƒä¼˜åŒ–)
- **ä¾èµ–åŒ…**: pandas, pyarrow, prometheus_client, websockets

## âœ… éªŒè¯æ ‡å‡†ï¼ˆDoDï¼‰

### å®Œæ•´æ€§
- æŒ‰1åˆ†é’Ÿæ¡¶èšåˆï¼Œç©ºæ¡¶ç‡ < 0.1%
- æ–‡ä»¶æ»šåŠ¨æ— ç¼ºå£

### å»é‡
- æŒ‰agg_trade_idå»é‡åï¼Œé‡å¤ç‡ < 0.5%

### å»¶è¿Ÿ
- latency_ms p99 < 120msï¼›p50 < 60ms

### ä¿¡å·é‡
- eventsï¼ˆèƒŒç¦»/æ¢è½´/å¼‚å¸¸ï¼‰åˆè®¡ â‰¥ 1000æ¡/72hï¼ˆå¤šäº¤æ˜“å¯¹æ€»è®¡ï¼‰

### ä¸€è‡´æ€§
- cvd.z_rawä¸z_cvdåœ¨å°¾éƒ¨å­˜åœ¨åˆ†ç¦»ï¼ˆwinsorç”Ÿæ•ˆï¼‰
- åŒ…å«scale/sigma_floor/floor_usedè¯Šæ–­å­—æ®µ

## ğŸ›  è¿è¡Œæ–¹å¼ï¼ˆæ¨èä¸€é”®è„šæœ¬ï¼‰

### è¿è¡Œå…¥å£
`v13_ofi_ai_system/examples/run_success_harvest.py` ä¸CVDç»Ÿä¸€ä¸ºä¸€ä¸ªharvestè„šæœ¬/è¿›ç¨‹ï¼ˆæˆ–supervisorç®¡ä¸¤ä¸ªè¿›ç¨‹ï¼‰ï¼Œå†™å…¥åŒä¸€ç›®å½•ã€‚

### å…³é”®ç¯å¢ƒå˜é‡
```bash
SYMBOLS=BTCUSDT,ETHUSDT
RUN_HOURS=72
PARQUET_ROTATE_SEC=60
WSS_PING_INTERVAL=20
DEDUP_LRU=8192
Z_MODE=delta
SCALE_MODE=hybrid
MAD_MULTIPLIER=1.8
SCALE_FAST_WEIGHT=0.20
HALF_LIFE_SEC=600
WINSOR_LIMIT=8
```

### è¿è¡Œå‰10åˆ†é’Ÿé¢„æ£€ï¼ˆå¿…åšï¼‰
- **è¿ç»­æ€§**: æ— æ–¹å‘ä¸ä¸€è‡´ã€æ— å¼‚å¸¸é‡è¿é£æš´ï¼ˆ>3æ¬¡/10mï¼‰
- **å»é‡ç‡**: é‡å¤æ ·æœ¬ < 0.2%
- **æ—¶é—´æ¼‚ç§»**: abs(event_ts_ms - recv_ts_ms) p99 < 120ms
- **å°æ ·æœ¬DoD**: pricesã€cvdå‡å·²è½ç›˜ï¼Œschemaæ­£ç¡®

## ğŸ“ˆ ç›‘æ§ä¸å‘Šè­¦ï¼ˆä¸Šçº¿å³ç”¨ï¼‰

### å‘Šè­¦è§„åˆ™
- `latency_ms_p99 > 120` æŒç»­10m
- `ws_reconnects_total > 10` /h
- `cvd_floor_hit_rate > 60%` æŒç»­15mï¼ˆç–‘ä¼¼å¸‚å†µ/å‚æ•°å¤±é…ï¼‰
- ç©ºæ¡¶ç‡ > 0.5% /h

### ä»ªè¡¨æ¿æŒ‡æ ‡
- **24hè¶‹åŠ¿**: p(|Z|>2), p(|Z|>3), scale_median, recv_rate_tpsï¼ˆOverall/Active/Quietï¼‰
- **æ•°æ®å¥åº·**: ç©ºæ¡¶çƒ­åŠ›å›¾ã€å»é‡ç‡ã€å†™å…¥æ—¶å»¶

### PrometheusæŒ‡æ ‡
```
recv_rate_tps, ws_reconnects_total, dedup_hits_total, 
latency_ms_p50/p90/p99, cvd_scale_median, cvd_floor_hit_rate, 
write_errors_total, parquet_flush_sec
```

## ğŸ” ç¨³å®šæ€§ä¸æ¢å¤

### WebSocket
- æŒ‡æ•°å›é€€ + æŠ–åŠ¨ã€å¿ƒè·³ï¼ˆ20sï¼‰
- é‡è¿æœŸé—´å¯ç”¨LRUå»é‡

### Checkpoint
- æ¯æ¬¡æˆåŠŸå†™Parquetåæ¨è¿›state/checkpoint.jsonï¼ˆæœ€åoffsetä¸æ—¶é—´ï¼‰

### è‡ªåŠ¨æ¢å¤
- è¿›ç¨‹é‡å¯ä»checkpointæ¢å¤
- å†™å…¥å¤±è´¥é‡è¯•3æ¬¡ â†’ æ‰“ç‚¹å¹¶è·³è¿‡ï¼ˆä¸é˜»å¡æµï¼‰

## ğŸ§ª æ”¶å°¾æ ¡éªŒè„šæœ¬

### è„šæœ¬ä½ç½®
`scripts/validate_ofi_cvd_harvest.py`

### åŠŸèƒ½
è·‘å®Œç»™å‡ºJSONæŠ¥å‘Šï¼ˆç”¨äºDoDï¼‰ï¼š
- ç©ºæ¡¶ç‡è®¡ç®—
- å»¶è¿Ÿç»Ÿè®¡ï¼ˆp50/p90/p99ï¼‰
- æ•°æ®è¡Œæ•°å’Œåˆ†é’Ÿæ•°ç»Ÿè®¡
- äº¤æ˜“å¯¹åˆ—è¡¨

## ğŸ“Š DoDæ£€æŸ¥æ¸…å•
- [ ] ä»£ç æ— è¯­æ³•é”™è¯¯
- [ ] é€šè¿‡lintæ£€æŸ¥
- [ ] é€šè¿‡æ‰€æœ‰æµ‹è¯•
- [ ] æ— mock/å ä½/è·³è¿‡
- [ ] äº§å‡ºçœŸå®éªŒè¯ç»“æœ
- [ ] æ€§èƒ½è¾¾æ ‡
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯é€šè¿‡
- [ ] å»¶è¿ŸæŒ‡æ ‡è¾¾æ ‡
- [ ] ä¿¡å·é‡è¾¾æ ‡
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸

## ğŸ“ æ‰§è¡Œè®°å½•
**å¼€å§‹æ—¶é—´**: (å¡«å†™)  
**å®Œæˆæ—¶é—´**: (å¡«å†™)  
**æ‰§è¡Œè€…**: AI Assistant

### é‡åˆ°çš„é—®é¢˜
- (è®°å½•é—®é¢˜)

### è§£å†³æ–¹æ¡ˆ
- (è®°å½•è§£å†³æ–¹æ¡ˆ)

### ç»éªŒæ•™è®­
- (è®°å½•ç»éªŒ)

## ğŸ—“ æ‰§è¡Œæ­¥éª¤ï¼ˆChecklistï¼‰

1. **é”å®šä¾èµ–ç‰ˆæœ¬**ï¼Œæ‰“å°"é…ç½®æŒ‡çº¹"ï¼ˆZ_MODE/SCALE/MAD/FAST/HLï¼‰
2. **è·‘10åˆ†é’Ÿé¢„æ£€**ï¼Œå…¨éƒ¨é€šè¿‡â†’å¼€å§‹48â€“72hé‡‡é›†
3. **é‡‡é›†ä¸­ç›‘æ§**ä¸Šè¿°æŒ‡æ ‡ä¸å‘Šè­¦ï¼›å¼‚å¸¸è§¦å‘åˆ™ä¸ä¸­æ–­é‡‡é›†ä½†æ ‡æ³¨run_tag
4. **æ¯6å°æ—¶ç”Ÿæˆä¸€æ¬¡DQæŠ¥å‘Š**ï¼›ä»»åŠ¡ç»“æŸæ±‡æ€»æ€»æŠ¥å‘Šä¸æ ·æœ¬å¿«ç…§ï¼ˆå‰/å1hï¼‰
5. **äº§å‡ºå½’æ¡£**ï¼šæ‰“tagï¼ˆæ—¥æœŸ+å‚æ•°æŒ‡çº¹ï¼‰ï¼Œå†™å…¥é˜¶æ®µæ€»è§ˆä¸ä¸‹ä¸€ä»»åŠ¡é“¾æ¥

## âš ï¸ æ³¨æ„äº‹é¡¹ï¼ˆé£é™©ä¸è§„é¿ï¼‰

### æ—¶é’Ÿ
- ä»¥event_ts_msä¸ºä¸»æ—¶é’Ÿï¼Œrecv_ts_msä»…ç”¨äºå»¶è¿Ÿ
- è‹¥ç³»ç»Ÿæ—¶é—´æ¼‚ç§»>200msï¼Œç«‹å³è®°å½•å¹¶ä¸ŠæŠ¥

### ç£ç›˜
- ç¡®ä¿å†™å…¥ååâ‰¥ 10MB/s
- ç£ç›˜å ç”¨é¢„ä¼°BTC/ETH 72h â‰ˆ 2â€“5 GBï¼ˆè§†è¡Œæƒ…ï¼‰

### æƒé™
- ç›®å½•å¯å†™ï¼Œå¼‚å¸¸é€€å‡ºæ—¶ä¸ä¼šé—ç•™åŠå†™æ–‡ä»¶ï¼ˆå…ˆå†™ä¸´æ—¶åï¼Œflushårenameï¼‰

## ğŸ”— ç›¸å…³é“¾æ¥
- ä¸Šä¸€ä¸ªä»»åŠ¡: [Task_1.2.13_CVD_Z-scoreå¾®è°ƒä¼˜åŒ–](./Task_1.2.13_CVD_Z-scoreå¾®è°ƒä¼˜åŒ–.md)
- ä¸‹ä¸€ä¸ªä»»åŠ¡: [Task_1.3.2_åˆ›å»ºOFI+CVDä¿¡å·åˆ†æå·¥å…·](./Task_1.3.2_åˆ›å»ºOFI+CVDä¿¡å·åˆ†æå·¥å…·.md)
- é˜¶æ®µæ€»è§ˆ: [ğŸ“‹V13_TASK_CARD.md](../../ğŸ“‹V13_TASK_CARD.md)

---
**ä»»åŠ¡çŠ¶æ€**: â³ å¾…Task_1.2.13å®Œæˆåå¼€å§‹  
**è´¨é‡è¯„åˆ†**: (å®Œæˆåå¡«å†™)  
**æ˜¯å¦å¯ä»¥ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡**: â“ å¾…æµ‹è¯•é€šè¿‡åç¡®å®š

