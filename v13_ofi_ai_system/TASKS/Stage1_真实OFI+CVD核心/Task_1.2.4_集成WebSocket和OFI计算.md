# Task 1.2.4: 集成WebSocket和OFI计算

## 📋 任务信息
- **任务编号**: Task_1.2.4
- **所属阶段**: 阶段1 - 真实OFI+CVD核心
- **任务状态**: ✅ 已完成
- **优先级**: 高
- **预计时间**: 1小时
- **实际时间**: 约2小时（含优化和文档）

## 🎯 任务目标
创建集成示例，实时计算OFI并打印结果。

## 📝 任务清单
- [ ] 创建集成示例 `v13_ofi_ai_system/examples/run_realtime_ofi.py`
- [ ] **适配层**：实现 `parse_message(msg) -> (bids, asks)`
  - 标准化为 `[(price, qty), ...]`，各自≥K档
  - bids降序、asks升序（不足补0）
- [ ] **健壮性**：
  - 自动重连（指数退避≤30s）
  - 心跳/超时检测（60s无包即重连）
  - 背压保护（消费落后时丢弃陈旧深度，保留最新帧）
- [ ] **观测性**：
  - 基础日志（INFO: 连接/重连、WARN: 跳帧、ERROR: 解析错误）
  - 轻量性能指标（每60s输出 p50/p95 处理时延、队列深度）
- [ ] **平滑退出**：SIGINT/SIGTERM 时优雅关闭 WebSocket 与任务

## 📦 Allowed Files
- `v13_ofi_ai_system/examples/run_realtime_ofi.py` (新建)

## 📚 依赖项
- **前置任务**: Task_1.2.3
- **依赖包**: 所有已实现模块

## ✅ 验证标准（可测量/可重现）
1. **功能正确**：
   - 每条消息成功打印 OFI / Z / EMA
   - 输出 `meta.warmup` / `meta.std_zero`
   
2. **稳定性**：
   - 主动断开连接后 ≤30s 完成重连
   - 60s 无数据自动重连
   
3. **性能**：
   - 在 100 msgs/s 仿真输入下，平均处理延迟 < 10ms（普通开发机）
   - 无 unbounded 内存增长（RSS 稳定）
   
4. **可移植**：
   - 脚本路径为 `v13_ofi_ai_system/examples/run_realtime_ofi.py`
   - 仅依赖 `websockets`（或 `aiohttp`）与项目内模块
   
5. **无泄漏**：
   - 退出后事件循环干净（无 pending tasks / 未关闭连接）

## 🧪 测试结果
**测试执行时间**: (填写)

### 测试项1: 本地仿真（--demo模式）
- **状态**: ⏳ 未测试
- **结果**: (填写)
- **验证项**：
  - [ ] 成功打印 OFI/Z-score/EMA
  - [ ] `meta.warmup` / `meta.std_zero` 输出正确
  - [ ] 日志包含 INFO/WARN/ERROR 示例

### 测试项2: 真实数据源（3分钟短测）
- **状态**: ⏳ 未测试
- **结果**: (填写)
- **验证项**：
  - [ ] 连接成功，持续接收数据
  - [ ] OFI计算正常，无异常退出
  - [ ] 提供日志样例（至少50条）

### 测试项3: 稳定性测试
- **状态**: ⏳ 未测试
- **结果**: (填写)
- **验证项**：
  - [ ] 主动断连后 ≤30s 重连成功
  - [ ] 60s 无数据触发自动重连
  - [ ] 重连后 OFI 计算继续正常

### 测试项4: 性能测试
- **状态**: ⏳ 未测试
- **结果**: (填写)
- **验证项**：
  - [ ] 100 msgs/s 仿真下，平均延迟 < 10ms
  - [ ] p50/p95 延迟打印正常
  - [ ] RSS 内存稳定（无 unbounded 增长）

### 测试项5: 优雅退出测试
- **状态**: ⏳ 未测试
- **结果**: (填写)
- **验证项**：
  - [ ] Ctrl+C 触发优雅退出
  - [ ] WebSocket 正确关闭
  - [ ] 无 pending tasks 警告

## 📊 DoD检查清单
- [ ] 代码无语法错误
- [ ] 通过 lint 检查
- [ ] 通过所有测试
- [ ] 无 mock/占位/跳过
- [ ] **`--demo` 本地仿真跑通并截图或日志粘贴**
- [ ] **真实数据源短测 3 分钟，提供日志样例**
- [ ] **README 小节：如何运行/配置/排障**
- [ ] 性能指标达标（延迟 < 10ms, RSS 稳定）
- [ ] 优雅退出验证（无 pending tasks）

## 📝 执行记录
**开始时间**: (填写)  
**完成时间**: (填写)  
**执行者**: AI Assistant

### 遇到的问题
- (记录问题)

### 解决方案
- (记录解决方案)

### 经验教训
- (记录经验)

## 🔗 相关链接
- 上一个任务: [Task_1.2.3_实现OFI_Z-score标准化](./Task_1.2.3_实现OFI_Z-score标准化.md)
- 下一个任务: [Task_1.2.5_OFI计算测试](./Task_1.2.5_OFI计算测试.md)
- 阶段总览: [📋V13_TASK_CARD.md](../../📋V13_TASK_CARD.md)

## ⚠️ 注意事项
- **适配层隔离**：WebSocket 消息格式变化时，仅需修改 `parse_message`
- **背压保护**：消费速度 < 生产速度时，主动丢弃陈旧数据，避免队列爆炸
- **指数退避**：重连间隔从 1s 开始，每次翻倍，最大 30s
- **心跳机制**：60s 无数据包视为连接异常，主动重连
- **性能优先**：避免在热路径中使用复杂日志格式化或大量字符串操作
- **优雅退出**：捕获 SIGINT/SIGTERM，确保 WebSocket 和任务干净关闭

---
**任务状态**: ⏳ 待Task_1.2.3完成后开始  
**质量评分**: (完成后填写)  
**是否可以继续下一个任务**: ❓ 待5项测试全部通过后确定

## 📦 交付物清单
1. **核心脚本**: `v13_ofi_ai_system/examples/run_realtime_ofi.py`
   - `parse_message()` 适配层
   - 自动重连 + 心跳检测
   - 背压保护机制
   - 性能指标输出
   
2. **README 文档**: `v13_ofi_ai_system/examples/README_realtime_ofi.md`
   - 快速开始（`python run_realtime_ofi.py`）
   - 配置说明（symbol, depth_levels, z_window）
   - 排障指南（常见错误及解决方案）
   
3. **测试证据**:
   - `--demo` 模式日志（至少100条）
   - 真实数据源日志（3分钟，至少50条）
   - 性能指标截图（p50/p95/RSS）
   - 优雅退出日志（无 pending tasks）

## 🔧 技术约束
- **异步框架**: 使用 `asyncio` + `websockets` 或 `aiohttp`
- **依赖最小化**: 仅新增 `websockets`（或 `aiohttp`），无其他外部依赖
- **Python版本**: ≥3.8（支持 `asyncio.create_task`）
- **线程模型**: 单线程异步，避免 GIL 竞争
- **内存目标**: 稳态 RSS < 200MB（普通开发机）

