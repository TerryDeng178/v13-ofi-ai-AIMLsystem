# Task 1.2.10.1 修改总结

## 📝 修改概览

根据用户的专业反馈，对 `Task_1.2.10.1_CVD问题修复（特别任务）.md` 进行了全面优化，主要修正了**时间评估偏乐观**、**指标口径不统一**、**回滚与灰度未固化**等6大问题。

---

## ✅ 主要修改内容

### 1. 时间评估修正（更现实）

**修改前**:
- 预计时间: 4-6小时（过于乐观）

**修改后**:
- **预计时间**: 1-2个工作日（≈12-16小时）
- **详细分解**:
  - P0-A（快速验证）: 1-2小时（含30分钟采集与报告）
  - P0-B（生产化）: 3-4小时（含60分钟采集与报告）
  - P1（稳健化）: 3-5小时（含2×30分钟对比与报告）
  - 金级回归: 2-2.5小时（含120分钟采集与报告）

**说明**: 仅测试耗时合计就≈4.5小时（30+60+30+30+120分钟），加上数据采集、联调与报告生成，1-2个工作日更为合理。

---

### 2. 指标口径统一（新增章节）

新增 **"📐 指标口径统一（重要）"** 章节，明确：

#### ID健康（核心硬指标）
- `agg_dup_rate`: 基于 `agg_trade_id (a字段)` 的重复率，**必须 == 0**
- `backward_rate`: 基于 `agg_trade_id (a字段)` 的倒序率，**必须 ≤ 0.5%**
- **评估方式**: 按 `(event_time_ms, agg_trade_id)` 排序后统计

#### 重复与倒序统计口径明确
- `duplicate_event_time_ms` (3354笔，23.1%) **不计为重复**，这是同毫秒多笔交易的正常现象
- `backward_event_time_ms` (43笔，0.3%) 也是信息项，仅作为乱序缓冲输入依据
- **所有dup/backward统计以 `agg_trade_id` 为准**

#### 到达节奏（分级指标）
- **硬线（阻断项）**: `gaps_over_10s == 0`
- **主口径（验收项）**: `p99_interarrival ≤ 5000ms`
- **信息口径（监控项）**: 记录 `max_gap_ms` 但**不用于阻断**

**原因**: 避免因极个别尖点（如max_gap_ms=8387ms）导致误判。

---

### 3. 配置与回滚策略固化（新增章节）

新增 **"⚙️ 配置与回滚策略"** 章节，包含：

#### 环境变量/配置开关表

| 参数名 | 默认值 | 说明 | 范围 |
|--------|--------|------|------|
| `Z_MODE` | `delta` | Z-score模式：`level`（旧版）\| `delta`（新版） | `{level, delta}` |
| `WATERMARK_MS` | `2000` | 水位线延迟（毫秒） | `[500, 5000]` |
| `HALF_LIFE_TRADES` | `300` | Z-score半衰期（笔数） | `[100, 1000]` |
| `WINSOR_LIMIT` | `8.0` | Z-score截断阈值 | `[3.0, 10.0]` |
| `FREEZE_MIN` | `50` | Z-score最小样本数 | `[20, 200]` |

#### 灰度流程（强制执行4步）

1. **基线测试**（30分钟，Z_MODE=level）
2. **灰度测试**（30分钟，Z_MODE=delta）
3. **对比验证**（任一硬指标退化 → 回滚）
4. **生产切换**（全部指标改善 ≥ 30% → 设为默认）

#### 回滚触发条件

任一条件满足即回滚：
- `agg_dup_rate` 或 `backward_rate` 新增异常
- `continuity_mismatch` 比基线恶化 > 5%
- `P(|Z|>3)` 比基线恶化 > 50%
- 系统异常或程序崩溃

---

### 4. 观测与报告强化（新增章节）

新增 **"📊 观测与报告强化（固化到流水线）"** 章节，包含：

#### 固定导出图表（验收必带6张）

| 序号 | 图表名称 | 文件名 |
|------|---------|--------|
| 1 | Event ID 差值分布 | `event_id_diff.png` |
| 2 | 消息间隔分布 | `interarrival_hist.png` |
| 3 | Z-score分布 | `hist_z.png` |
| 4 | Z-score时序 | `z_timeseries.png` |
| 5 | CVD时序 | `cvd_timeseries.png` |
| 6 | 延迟箱线图 | `latency_box.png` |

#### 指标新增（5项监控指标）

- `buffer_size_p95`: 水位线缓冲队列P95大小
- `late_write_count`: 水位线外写入计数
- `z_freeze_count`: Z-score冻结次数
- `gap_events`: 间隔>5s的事件数
- `agg_backward_count`: aggTradeID倒序计数

#### 报告模板结构（固定格式）

包含5个固定章节：测试概览、核心指标、观测指标、图表、问题与改进。

---

### 5. 负载与边界用例（新增章节）

新增 **"🧪 负载与边界用例（强制回归）"** 章节，包含：

#### 双符号回归（覆盖不同活跃度）

| 符号 | 预期到达率 | 测试时长 |
|------|-----------|---------|
| BTCUSDT | 高频（≈5-10笔/秒） | 30分钟 |
| ETHUSDT | 中频（≈2-3笔/秒） | 30分钟 |

#### 混沌测试（5-10分钟）

模拟重连/乱序场景，验证水位线逻辑：
- 正常运行 → 2分钟
- 模拟网络抖动（手动pause 5秒）→ 恢复运行 3分钟
- 观察 `reconnect_count`、`buffer_size_p95`、`continuity_mismatch`

#### 边界条件测试

- 极稀疏数据（0.1笔/秒）
- 极致高频（BTCUSDT高波动期）
- 长时间无数据（暂停30秒）

---

### 6. RACI与依赖（新增章节）

新增 **"👥 RACI与依赖"** 章节：

#### RACI矩阵

- **R (Responsible)**: AI Assistant + CURSOR + 工程实施
- **A (Accountable)**: USER（任务所有者）
- **C (Consulted)**: CURSOR、数据/监控维护
- **I (Informed)**: 策略侧、QA、相关开发人员

#### 关键依赖项（5项）

- Binance aggTrade稳定接入 ✅
- 现有分析脚本可运行 ✅
- 图表/报告管线正常 ✅
- Parquet读写库 ✅
- Python 3.9+环境 ✅

---

### 7. Ready-to-Run 清单（新增章节）

新增 **"✅ Ready-to-Run 清单（实施前检查）"** 章节，包含：

#### 前置准备（4项）
- 切换唯一键到 `agg_trade_id`
- `(E, a)` 排序 + 一致性校验
- 观测项接入
- 计算器切 ΔCVD 稳健 Z

#### 回归测试（2项）
- 双符号（BTC/ETH）回归
- 报告固化 6 张图

#### 灰度与回滚（3项）
- 灰度开关验证
- 配置热切换测试
- 应急预案文档化

#### 最终交付（3项）
- Git提交并打tag
- 更新所有关联文档
- 通知相关方

---

## 📊 症状清单更新

**修改前**:
- `max_gap_ms` | 8387ms | ≤2000ms | ❌ 严重超标

**修改后**:
- `p99_interarrival` | 3435ms | ≤5000ms | ✅ 通过（信息项）
- `max_gap_ms` | 8387ms | 记录但不阻断 | ⚠️ 信息项
- `agg_dup_rate (a字段)` | 待统计 | == 0 | ⏳ 待验证
- `backward_rate (a字段)` | 待统计 | ≤ 0.5% | ⏳ 待验证

**新增说明**:
- `duplicate_event_time_ms` (3354笔，23.1%) 不计为重复
- `backward_event_time_ms` (43笔，0.3%) 也是信息项
- **真正的重复/倒序统计以 `agg_trade_id (a字段)` 为准**

---

## 📐 验收标准更新

### P0阶段验收（7-8/8通过）

**硬指标（阻断项）**:
- `agg_dup_rate` == 0
- `backward_rate` ≤ 0.5%
- `continuity_mismatch` == 0
- `gaps_over_10s` == 0 （新增）
- `p99_interarrival` ≤ 5000ms （替代max_gap_ms）
- 所有P0代码通过语法检查和单元测试
- P0-B完整验证报告生成（含6张图表）

**信息指标（监控项，不阻断）**:
- `max_gap_ms` 已记录到报告 （降级为监控项）
- `buffer_size_p95` 已记录
- `late_write_count` 已记录
- `agg_backward_count` 已记录

---

## 🔄 修改影响分析

### 对任务执行的影响

#### 正面影响 ✅
1. **时间评估更现实**: 避免了时间压力导致的质量妥协
2. **指标口径统一**: 消除了误判风险，提高验收准确性
3. **回滚策略明确**: 降低了修复失败的风险
4. **观测面增强**: 提升了问题诊断能力
5. **负载用例完善**: 覆盖更多真实场景

#### 潜在挑战 ⚠️
1. **工期延长**: 从4-6小时 → 1-2个工作日
2. **测试成本增加**: 需要双符号 + 混沌测试
3. **灰度流程复杂**: 需要基线和灰度两次测试

#### 缓解措施 🛡️
1. **并行准备**: 报告模板可提前准备
2. **自动化脚本**: 混沌测试可选自动化
3. **分阶段验收**: 不必等全部完成才开始后续任务

---

## 📋 建议执行顺序

基于修改后的任务卡，建议执行顺序：

### Day 1（8-10小时）
1. **P0-A**: 最小验证修复（1-2小时）
   - 添加 `agg_trade_id` 字段
   - 修复排序逻辑
   - 30分钟测试 + 报告

2. **P0-B**: 完整上游修复（3-4小时）
   - 实现2s水位线
   - 完善监控指标
   - 60分钟测试 + 报告

3. **双符号快速验证**（1小时）
   - BTCUSDT 30分钟
   - ETHUSDT 30分钟（可复用P0-B数据）

### Day 2（4-8小时）
4. **P1**: Z-score稳健化（3-5小时）
   - 重构计算器
   - 灰度测试（基线 + 灰度，各30分钟）
   - 对比报告

5. **金级回归**（2-2.5小时）
   - 120分钟测试
   - 完整分析 + 报告

6. **混沌测试**（可选，30分钟）
   - 验证容错能力

---

## ✅ 文档完整性检查

### 新增章节（6个）
- ✅ 📐 指标口径统一（重要）
- ✅ ⚙️ 配置与回滚策略
- ✅ 📊 观测与报告强化（固化到流水线）
- ✅ 🧪 负载与边界用例（强制回归）
- ✅ 👥 RACI与依赖
- ✅ ✅ Ready-to-Run 清单（实施前检查）

### 修改章节（4个）
- ✅ 📋 任务信息（时间评估更新）
- ✅ 🚨 问题总结（症状清单更新）
- ✅ 📐 验收标准（硬指标/监控项分离）
- ✅ 🔬 测试与验证计划（指标更新）

### 保持不变（9个）
- ✅ 🎯 任务目标
- ✅ 根因分析
- ✅ 📦 修复方案（P0/P1清单）
- ✅ 📊 修复进度追踪
- ✅ 📂 产出物清单
- ✅ 🔧 技术实现要点
- ✅ ⚠️ 风险与缓解措施
- ✅ 🔄 关联任务
- ✅ 📝 执行记录

---

## 🎯 核心改进总结

| 改进项 | 修改前 | 修改后 | 收益 |
|--------|--------|--------|------|
| **时间评估** | 4-6小时（乐观） | 1-2工作日（现实） | 避免时间压力 |
| **指标口径** | 混用多个gap指标 | 统一为p99+gaps_over_10s | 消除误判 |
| **重复定义** | 基于event_time_ms | 基于agg_trade_id | 准确统计 |
| **回滚策略** | 未固化 | 灰度流程+回滚条件 | 降低风险 |
| **观测面** | 基础指标 | +5项监控+6张固定图 | 增强诊断 |
| **负载测试** | 单符号 | 双符号+混沌+边界 | 覆盖更全 |
| **RACI** | 无 | 明确4角色+5依赖 | 职责清晰 |
| **Ready-to-Run** | 无 | 12项检查清单 | 降低遗漏 |

---

## 📞 下一步行动

任务卡已全面优化完成，建议：

1. **立即**: 审阅修改后的任务卡 `Task_1.2.10.1_CVD问题修复（特别任务）.md`
2. **确认**: 工期、验收标准、灰度流程是否符合预期
3. **准备**: 提前准备报告模板、配置环境变量
4. **执行**: 按照Day 1 → Day 2顺序开始实施

---

**修改完成时间**: 2025-10-18 03:00  
**修改人**: AI Assistant  
**审核人**: USER（待审核）  
**文档版本**: v1.0

