# Task 1.2.14: é›†æˆCVDæ¨¡å—å‚æ•°çƒ­æ›´æ–°

## ğŸ“‹ ä»»åŠ¡ä¿¡æ¯

- **ä»»åŠ¡ç¼–å·**: Task_1.2.14
- **ä»»åŠ¡åç§°**: é›†æˆCVDæ¨¡å—å‚æ•°çƒ­æ›´æ–°ï¼ˆåŸºäºTask 0.7åŠ¨æ€æ¨¡å¼åˆ‡æ¢ï¼‰
- **æ‰€å±é˜¶æ®µ**: é˜¶æ®µ1 - çœŸå®OFI+CVDæ ¸å¿ƒ
- **ä¼˜å…ˆçº§**: é«˜
- **é¢„è®¡æ—¶é—´**: 2-3å°æ—¶
- **å®é™…æ—¶é—´**: ___ï¼ˆå®Œæˆåå¡«å†™ï¼‰___
- **ä»»åŠ¡çŠ¶æ€**: â³ å¾…å¼€å§‹
- **å‰ç½®ä»»åŠ¡**: 
  - âœ… Task_0.7ï¼ˆåŠ¨æ€æ¨¡å¼åˆ‡æ¢ä¸å·®å¼‚åŒ–é…ç½®ï¼‰- æ¡†æ¶å·²å®Œæˆ
  - âœ… Task_1.2.10ï¼ˆCVDè®¡ç®—æµ‹è¯•ï¼‰- CVDæ¨¡å—å·²ç¨³å®š

---

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

å°† Task 0.7 å®Œæˆçš„åŠ¨æ€æ¨¡å¼åˆ‡æ¢æ¡†æ¶ä¸å®é™…çš„ CVD æ¨¡å—é›†æˆï¼Œå®ç° CVD å‚æ•°çš„çƒ­æ›´æ–°ï¼Œä½¿ç³»ç»Ÿèƒ½å¤Ÿæ ¹æ®å¸‚åœºæ´»è·ƒåº¦è‡ªåŠ¨è°ƒæ•´ CVD è®¡ç®—å‚æ•°ã€‚

### æ ¸å¿ƒç›®æ ‡

1. **å®ç°CVDå‚æ•°çƒ­æ›´æ–°æ¥å£** - åœ¨ `RealCVDCalculator` ä¸­æ·»åŠ  `update_params()` æ–¹æ³•
2. **é›†æˆåˆ°ç­–ç•¥æ¨¡å¼ç®¡ç†å™¨** - åœ¨ `StrategyModeManager.apply_params()` ä¸­è°ƒç”¨CVDæ¨¡å—
3. **éªŒè¯å‚æ•°ç”Ÿæ•ˆ** - ç¡®ä¿å‚æ•°åˆ‡æ¢å CVD è®¡ç®—ä½¿ç”¨æ–°å‚æ•°
4. **æµ‹è¯•çƒ­æ›´æ–°æ€§èƒ½** - éªŒè¯æ›´æ–°è€—æ—¶ â‰¤ 100msï¼ˆP99ï¼‰
5. **éªŒè¯æ•°æ®è¿ç»­æ€§** - ç¡®ä¿å‚æ•°åˆ‡æ¢ä¸å½±å“ CVD åºåˆ—è¿ç»­æ€§

---

## ğŸ“ ä»»åŠ¡æ¸…å•

### é˜¶æ®µ1: CVDæ¨¡å—å¢å¼ºï¼ˆ1å°æ—¶ï¼‰

- [ ] 1.1 åœ¨ `RealCVDCalculator` ç±»ä¸­æ·»åŠ  `update_params()` æ–¹æ³•
  - [ ] æ”¯æŒçƒ­æ›´æ–°ï¼š`window_ticks`, `ema_span`, `denoise_sigma`
  - [ ] ä½¿ç”¨çº¿ç¨‹é”ä¿æŠ¤å…³é”®çŠ¶æ€
  - [ ] è¿”å›æ›´æ–°æˆåŠŸ/å¤±è´¥çŠ¶æ€
  - [ ] è®°å½•å‚æ•°å˜åŒ–æ—¥å¿—

- [ ] 1.2 æ·»åŠ å‚æ•°éªŒè¯é€»è¾‘
  - [ ] éªŒè¯å‚æ•°åˆæ³•æ€§ï¼ˆèŒƒå›´æ£€æŸ¥ï¼‰
  - [ ] éªŒè¯å‚æ•°ç»„åˆåˆç†æ€§
  - [ ] å¤±è´¥æ—¶ä¿æŒåŸå‚æ•°ä¸å˜

- [ ] 1.3 æ·»åŠ çŠ¶æ€ä¿å­˜ä¸æ¢å¤
  - [ ] ä¿å­˜å½“å‰è®¡ç®—çŠ¶æ€ï¼ˆEMAã€MADç­‰ï¼‰
  - [ ] å‚æ•°åˆ‡æ¢æ—¶æ™ºèƒ½è°ƒæ•´çŠ¶æ€
  - [ ] é¿å…çŠ¶æ€çªå˜å¯¼è‡´çš„å¼‚å¸¸å€¼

### é˜¶æ®µ2: é›†æˆåˆ°ç­–ç•¥æ¨¡å¼ç®¡ç†å™¨ï¼ˆ30åˆ†é’Ÿï¼‰

- [ ] 2.1 ä¿®æ”¹ `StrategyModeManager.apply_params()`
  - [ ] æ·»åŠ  CVD æ¨¡å—å®ä¾‹å¼•ç”¨
  - [ ] å®ç° `apply_to_cvd()` æ–¹æ³•
  - [ ] å¤„ç†æ›´æ–°æˆåŠŸ/å¤±è´¥åœºæ™¯
  - [ ] è®°å½•æ›´æ–°è€—æ—¶åˆ° Prometheus

- [ ] 2.2 å®ç°å›æ»šæœºåˆ¶
  - [ ] CVDæ›´æ–°å¤±è´¥æ—¶å›æ»šåˆ°æ—§å‚æ•°
  - [ ] è®°å½•å¤±è´¥æ¨¡å—ä¸º 'cvd'
  - [ ] è§¦å‘å‘Šè­¦

### é˜¶æ®µ3: æµ‹è¯•ä¸éªŒè¯ï¼ˆ30åˆ†é’Ÿ-1å°æ—¶ï¼‰

- [ ] 3.1 å•å…ƒæµ‹è¯•
  - [ ] æµ‹è¯• `update_params()` åŸºæœ¬åŠŸèƒ½
  - [ ] æµ‹è¯•å‚æ•°éªŒè¯é€»è¾‘
  - [ ] æµ‹è¯•çº¿ç¨‹å®‰å…¨æ€§
  - [ ] æµ‹è¯•å¤±è´¥å›æ»š

- [ ] 3.2 é›†æˆæµ‹è¯•
  - [ ] åœ¨çœŸå®æ•°æ®æµä¸­è§¦å‘å‚æ•°åˆ‡æ¢
  - [ ] éªŒè¯CVDåºåˆ—è¿ç»­æ€§
  - [ ] éªŒè¯æ–°å‚æ•°ç”Ÿæ•ˆ
  - [ ] éªŒè¯æ›´æ–°è€—æ—¶ â‰¤ 100ms

- [ ] 3.3 æ€§èƒ½æµ‹è¯•
  - [ ] æµ‹é‡P50/P95/P99æ›´æ–°è€—æ—¶
  - [ ] ç¡®ä¿æ— æ•°æ®ä¸¢å¤±
  - [ ] ç¡®ä¿æ— è®¡ç®—å¼‚å¸¸

---

## ğŸ“¦ Allowed Files

### å…è®¸ä¿®æ”¹çš„æ–‡ä»¶
- `src/real_cvd_calculator.py` - æ·»åŠ  `update_params()` æ–¹æ³•
- `src/utils/strategy_mode_manager.py` - å®ç° CVD é›†æˆ
- `examples/run_realtime_cvd.py` - ä¼ é€’ CVD å®ä¾‹ç»™ç®¡ç†å™¨

### å…è®¸åˆ›å»ºçš„æ–‡ä»¶
- `tests/test_cvd_hot_update.py` - CVD çƒ­æ›´æ–°å•å…ƒæµ‹è¯•
- `examples/test_cvd_mode_switching.py` - ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬

### ä¸å…è®¸ä¿®æ”¹çš„æ–‡ä»¶
- `config/system.yaml` - é…ç½®ç»“æ„å·²å›ºå®š
- å…¶ä»–æ ¸å¿ƒç®—æ³•æ–‡ä»¶

---

## ğŸ“š ä¾èµ–é¡¹

### å‰ç½®ä»»åŠ¡
- âœ… Task_0.7ï¼ˆåŠ¨æ€æ¨¡å¼åˆ‡æ¢æ¡†æ¶ï¼‰
- âœ… Task_1.2.10ï¼ˆCVDè®¡ç®—ç¨³å®šï¼‰

### æŠ€æœ¯ä¾èµ–
- Python threading æ¨¡å—
- å·²æœ‰çš„ PrometheusMetrics
- å·²æœ‰çš„ StrategyModeManager

---

## âœ… éªŒè¯æ ‡å‡†

### åŠŸèƒ½éªŒè¯
- [ ] **V1**: `update_params()` æ–¹æ³•èƒ½æˆåŠŸæ›´æ–° CVD å‚æ•°
- [ ] **V2**: å‚æ•°éªŒè¯èƒ½æ­£ç¡®æ‹’ç»éæ³•å‚æ•°
- [ ] **V3**: çº¿ç¨‹å®‰å…¨ - å¹¶å‘è°ƒç”¨ä¸å¯¼è‡´çŠ¶æ€é”™ä¹±
- [ ] **V4**: å¤±è´¥å›æ»š - æ›´æ–°å¤±è´¥æ—¶ä¿æŒåŸå‚æ•°

### æ€§èƒ½éªŒè¯
- [ ] **V5**: å‚æ•°æ›´æ–°è€—æ—¶ P99 â‰¤ 100ms
- [ ] **V6**: æ›´æ–°æœŸé—´æ— æ•°æ®ä¸¢å¤±
- [ ] **V7**: æ›´æ–°æœŸé—´æ— è®¡ç®—å¼‚å¸¸ï¼ˆNaN/Infï¼‰

### è¿ç»­æ€§éªŒè¯
- [ ] **V8**: CVD åºåˆ—åœ¨å‚æ•°åˆ‡æ¢å‰åä¿æŒè¿ç»­
- [ ] **V9**: Z-score åºåˆ—æ— å¼‚å¸¸è·³å˜ï¼ˆé™¤é¢„æœŸçš„å°ºåº¦å˜åŒ–ï¼‰

### é›†æˆéªŒè¯
- [ ] **V10**: ç­–ç•¥æ¨¡å¼ç®¡ç†å™¨èƒ½æ­£ç¡®è°ƒç”¨ CVD æ›´æ–°
- [ ] **V11**: Prometheus æŒ‡æ ‡æ­£ç¡®è®°å½•æ›´æ–°è€—æ—¶
- [ ] **V12**: æ›´æ–°å¤±è´¥æ—¶è§¦å‘ `strategy_params_update_failures_total` è®¡æ•°

**é€šè¿‡æ ‡å‡†**: 12/12 éªŒè¯å…¨éƒ¨é€šè¿‡

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### å•å…ƒæµ‹è¯•

**æ‰§è¡Œæ—¶é—´**: ___  
**æµ‹è¯•ç¯å¢ƒ**: å¼€å‘ç¯å¢ƒ

| æµ‹è¯•ç”¨ä¾‹ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| test_update_params_success | ___ | åŸºæœ¬åŠŸèƒ½æµ‹è¯• |
| test_update_params_validation | ___ | å‚æ•°éªŒè¯æµ‹è¯• |
| test_update_params_thread_safety | ___ | çº¿ç¨‹å®‰å…¨æµ‹è¯• |
| test_update_params_rollback | ___ | å¤±è´¥å›æ»šæµ‹è¯• |

### é›†æˆæµ‹è¯•

**æ‰§è¡Œæ—¶é—´**: ___  
**æµ‹è¯•ç¯å¢ƒ**: çœŸå®å¸å®‰æ•°æ®æµ

| æµ‹è¯•åœºæ™¯ | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| active â†’ quiet åˆ‡æ¢ | ___ | éªŒè¯å‚æ•°ä»æ´»è·ƒåˆ‡åˆ°å®‰é™æ¨¡å¼ |
| quiet â†’ active åˆ‡æ¢ | ___ | éªŒè¯å‚æ•°ä»å®‰é™åˆ‡åˆ°æ´»è·ƒæ¨¡å¼ |
| CVD åºåˆ—è¿ç»­æ€§ | ___ | åˆ‡æ¢å‰åCVDå€¼è¿ç»­ |
| Z-score åˆç†æ€§ | ___ | åˆ‡æ¢åZ-scoreæ­£å¸¸ |

### æ€§èƒ½æµ‹è¯•

**æ‰§è¡Œæ—¶é—´**: ___  
**æ ·æœ¬æ•°é‡**: 100æ¬¡åˆ‡æ¢

| æŒ‡æ ‡ | ç›®æ ‡ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| æ›´æ–°è€—æ—¶ P50 | â‰¤ 50ms | ___ ms | ___ |
| æ›´æ–°è€—æ—¶ P95 | â‰¤ 80ms | ___ ms | ___ |
| æ›´æ–°è€—æ—¶ P99 | â‰¤ 100ms | ___ ms | ___ |
| æ•°æ®ä¸¢å¤±ç‡ | 0% | ___ % | ___ |
| è®¡ç®—å¼‚å¸¸ç‡ | 0% | ___ % | ___ |

---

## ğŸ“Š DoDæ£€æŸ¥æ¸…å•

### ä»£ç è´¨é‡
- [ ] ä»£ç é€šè¿‡ pylint/flake8 æ£€æŸ¥
- [ ] ä»£ç æœ‰å®Œæ•´çš„ docstring
- [ ] å…³é”®é€»è¾‘æœ‰è¡Œå†…æ³¨é‡Š
- [ ] æ—  TODO/FIXME æ ‡è®°

### æµ‹è¯•è¦†ç›–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ â‰¥ 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡
- [ ] è¾¹ç•Œæ¡ä»¶æµ‹è¯•é€šè¿‡

### æ–‡æ¡£å®Œå–„
- [ ] ä»£ç  docstring å®Œæ•´
- [ ] æ›´æ–° `CVD_SYSTEM_FILES_GUIDE.md`
- [ ] æ·»åŠ å‚æ•°çƒ­æ›´æ–°ä½¿ç”¨ç¤ºä¾‹
- [ ] æ›´æ–° CHANGELOG

### é›†æˆéªŒè¯
- [ ] ä¸ç­–ç•¥æ¨¡å¼ç®¡ç†å™¨é›†æˆæˆåŠŸ
- [ ] Prometheus æŒ‡æ ‡æ­£å¸¸è®°å½•
- [ ] æ—¥å¿—è¾“å‡ºç¬¦åˆé¢„æœŸ
- [ ] æ— é—ç•™é—®é¢˜

---

## ğŸ“ æ‰§è¡Œè®°å½•

### å¼€å§‹æ—¶é—´
___ï¼ˆå¼€å§‹æ—¶å¡«å†™ï¼‰___

### å®Œæˆæ—¶é—´
___ï¼ˆå®Œæˆæ—¶å¡«å†™ï¼‰___

### å®é™…è€—æ—¶
___ï¼ˆå®Œæˆæ—¶å¡«å†™ï¼‰___

### é‡åˆ°çš„é—®é¢˜
___ï¼ˆè®°å½•é‡åˆ°çš„é—®é¢˜ï¼‰___

### è§£å†³æ–¹æ¡ˆ
___ï¼ˆè®°å½•è§£å†³æ–¹æ¡ˆï¼‰___

### ç»éªŒæ•™è®­
___ï¼ˆè®°å½•ç»éªŒæ•™è®­ï¼‰___

---

## ğŸ”— ç›¸å…³é“¾æ¥

### å‰ç½®ä»»åŠ¡
- [Task_0.7_åŠ¨æ€æ¨¡å¼åˆ‡æ¢ä¸å·®å¼‚åŒ–é…ç½®](../Stage0_å‡†å¤‡å·¥ä½œ/âœ…Task_0.7_åŠ¨æ€æ¨¡å¼åˆ‡æ¢ä¸å·®å¼‚åŒ–é…ç½®.md)
- [Task_1.2.10_CVDè®¡ç®—æµ‹è¯•](./âœ…Task_1.2.10_CVDè®¡ç®—æµ‹è¯•.md)

### åç»­ä»»åŠ¡
- [Task_1.2.15_é›†æˆOFI/Risk/Performanceæ¨¡å—](./Task_1.2.15_é›†æˆOFIä¸Riskæ¨¡å—å‚æ•°çƒ­æ›´æ–°.md)
- [Task_1.2.16_çœŸå®ç¯å¢ƒ24å°æ—¶æµ‹è¯•](./Task_1.2.16_çœŸå®ç¯å¢ƒ24å°æ—¶æµ‹è¯•.md)

### å‚è€ƒæ–‡æ¡£
- [Task_0.7_FINAL_COMPLETION_REPORT.md](../Stage0_å‡†å¤‡å·¥ä½œ/Task_0.7_FINAL_COMPLETION_REPORT.md)
- [SYSTEM_CONFIG_GUIDE.md](../../docs/SYSTEM_CONFIG_GUIDE.md)

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æŠ€æœ¯æ³¨æ„äº‹é¡¹

1. **çº¿ç¨‹å®‰å…¨**
   - CVD è®¡ç®—é€šå¸¸åœ¨ä¸»çº¿ç¨‹
   - å‚æ•°æ›´æ–°å¯èƒ½æ¥è‡ªç›‘æ§çº¿ç¨‹
   - å¿…é¡»ä½¿ç”¨é”ä¿æŠ¤å…±äº«çŠ¶æ€

2. **çŠ¶æ€ä¸€è‡´æ€§**
   - EMA çŠ¶æ€éœ€è¦æ™ºèƒ½è°ƒæ•´ï¼ˆä¸èƒ½ç®€å•é‡ç½®ï¼‰
   - MAD çª—å£éœ€è¦ä¿ç•™æˆ–æ’å€¼
   - é¿å…å‚æ•°åˆ‡æ¢å¯¼è‡´çš„å¼‚å¸¸å€¼

3. **æ€§èƒ½æ•æ„Ÿ**
   - CVD æ˜¯é«˜é¢‘è®¡ç®—ï¼ˆæ¯ç¬”äº¤æ˜“ï¼‰
   - å‚æ•°æ›´æ–°å¿…é¡»å¿«é€Ÿï¼ˆâ‰¤ 100msï¼‰
   - é¿å…åœ¨æ›´æ–°æœŸé—´é˜»å¡ä¸»è®¡ç®—

4. **å›æ»šç­–ç•¥**
   - ä¿å­˜æ—§å‚æ•°å‰¯æœ¬
   - æ›´æ–°å¤±è´¥ç«‹å³å›æ»š
   - è®°å½•è¯¦ç»†å¤±è´¥åŸå› 

### ä¸šåŠ¡æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç»­æ€§ä¼˜å…ˆ**
   - å‚æ•°åˆ‡æ¢ä¸åº”å¯¼è‡´CVDåºåˆ—æ–­è£‚
   - Z-score å¯ä»¥æœ‰å°ºåº¦å˜åŒ–ï¼Œä½†ä¸åº”æœ‰çªå˜

2. **ç›‘æ§å……åˆ†**
   - è®°å½•æ¯æ¬¡å‚æ•°åˆ‡æ¢
   - è®°å½•åˆ‡æ¢å‰åçš„CVD/Z-scoreæ ·æœ¬
   - ä¾¿äºåç»­åˆ†æå’Œä¼˜åŒ–

3. **æ¸è¿›å¼é›†æˆ**
   - å…ˆå®ŒæˆCVDï¼Œå†é›†æˆOFI
   - æ¯ä¸ªæ¨¡å—ç‹¬ç«‹éªŒè¯
   - é¿å…ä¸€æ¬¡æ€§é›†æˆå¤šä¸ªæ¨¡å—

---

## ğŸ’¡ å®ç°å»ºè®®

### CVD æ¨¡å—å¢å¼ºç¤ºä¾‹

```python
class RealCVDCalculator:
    def __init__(self, config):
        self.config = config
        self.params_lock = threading.RLock()
        # ... ç°æœ‰ä»£ç  ...
    
    def update_params(self, new_params: Dict[str, Any]) -> Tuple[bool, str]:
        """
        çƒ­æ›´æ–°CVDå‚æ•°
        
        Args:
            new_params: æ–°å‚æ•°å­—å…¸ï¼Œä¾‹å¦‚ï¼š
                {
                    'window_ticks': 2000,
                    'ema_span': 60,
                    'denoise_sigma': 2.5
                }
        
        Returns:
            (æ˜¯å¦æˆåŠŸ, é”™è¯¯ä¿¡æ¯)
        """
        with self.params_lock:
            try:
                # 1. éªŒè¯å‚æ•°
                if not self._validate_params(new_params):
                    return False, "Invalid parameters"
                
                # 2. ä¿å­˜æ—§å‚æ•°ï¼ˆç”¨äºå›æ»šï¼‰
                old_params = self._get_current_params()
                
                # 3. åº”ç”¨æ–°å‚æ•°
                self._apply_params(new_params)
                
                # 4. è°ƒæ•´å†…éƒ¨çŠ¶æ€ï¼ˆå¦‚éœ€è¦ï¼‰
                self._adjust_state(old_params, new_params)
                
                logger.info(f"CVD params updated: {old_params} -> {new_params}")
                return True, ""
                
            except Exception as e:
                logger.error(f"Failed to update CVD params: {e}")
                return False, str(e)
    
    def _validate_params(self, params: Dict[str, Any]) -> bool:
        """éªŒè¯å‚æ•°åˆæ³•æ€§"""
        if 'window_ticks' in params:
            if not (100 <= params['window_ticks'] <= 20000):
                return False
        
        if 'ema_span' in params:
            if not (10 <= params['ema_span'] <= 500):
                return False
        
        if 'denoise_sigma' in params:
            if not (0.5 <= params['denoise_sigma'] <= 5.0):
                return False
        
        return True
```

### ç­–ç•¥æ¨¡å¼ç®¡ç†å™¨é›†æˆç¤ºä¾‹

```python
class StrategyModeManager:
    def __init__(self, config):
        # ... ç°æœ‰ä»£ç  ...
        self.cvd_instance = None  # å°†åœ¨å¤–éƒ¨è®¾ç½®
    
    def set_cvd_instance(self, cvd):
        """è®¾ç½®CVDå®ä¾‹å¼•ç”¨"""
        self.cvd_instance = cvd
    
    def apply_params(self, mode: StrategyMode) -> Tuple[bool, List[str]]:
        """åº”ç”¨å‚æ•°ï¼ˆå«CVDé›†æˆï¼‰"""
        # ... ç°æœ‰ä»£ç  ...
        
        # åº”ç”¨CVDå‚æ•°
        if self.cvd_instance and 'cvd' in new_params:
            success, error = self.cvd_instance.update_params(new_params['cvd'])
            if not success:
                logger.error(f"CVD update failed: {error}")
                _metrics.inc_counter('strategy_params_update_failures_total', {'module': 'cvd'})
                failed_modules.append('cvd')
        
        # ... ç°æœ‰ä»£ç  ...
```

---

**ä»»åŠ¡åˆ›å»ºæ—¶é—´**: 2025-10-19 06:20  
**ä»»åŠ¡åˆ›å»ºè€…**: AI Assistant  
**ä»»åŠ¡ç‰ˆæœ¬**: V1.0  
**ä»»åŠ¡çŠ¶æ€**: â³ å¾…å¼€å§‹

