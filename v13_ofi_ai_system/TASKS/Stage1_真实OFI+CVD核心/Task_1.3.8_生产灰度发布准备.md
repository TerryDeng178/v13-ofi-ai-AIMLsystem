# Task 1.3.7: 生产灰度发布准备（动态模式切换）

## 📋 任务信息

- **任务编号**: Task_1.3.7
- **任务名称**: 生产灰度发布准备（动态模式切换系统）
- **所属阶段**: 阶段1 - 真实OFI+CVD核心（收尾）
- **优先级**: 高
- **预计时间**: 1-2周（分3个阶段灰度）
- **实际时间**: ___（完成后填写）___
- **任务状态**: ⏳ 待开始
- **前置任务**: 
  - ✅ Task_1.2.16（24小时真实环境测试通过）
  - ✅ Task_1.3.6（端到端集成测试通过）
  - ✅ Task_0.8（Grafana监控仪表盘完成）

---

## 🎯 任务目标

以低风险、可控的方式将动态模式切换系统发布到生产环境，通过3阶段灰度逐步扩大范围，每个阶段充分验证后再进入下一阶段。

### 核心目标

1. **灰度方案设计** - 3阶段：10% → 50% → 100%
2. **发布准备** - 配置、脚本、文档、回滚预案
3. **监控与告警** - 确保问题能第一时间发现
4. **风险控制** - 每阶段设置明确的前进/后退条件
5. **知识沉淀** - 记录经验、问题、最佳实践

---

## 📝 灰度发布计划

### 🔷 阶段1: 10%灰度（观察期：3天）

**目标**: 小范围验证系统稳定性

**范围**:
- 启用动态模式切换：仅1个交易对（如ETHUSDT）
- 保守配置：
  - `hysteresis.min_active_windows = 5`（更保守）
  - `hysteresis.min_quiet_windows = 10`（更保守）
  - 活跃模式参数相对保守

**启用条件**:
- ✅ 24小时测试通过
- ✅ 端到端测试通过
- ✅ Grafana仪表盘就绪
- ✅ 告警通道畅通

**前进条件**（满足全部）:
- 3天内无系统崩溃
- 模式切换符合预期（4-8次/天）
- 参数更新P99 ≤ 100ms
- 数据质量无劣化（对比baseline）
- 无critical告警

**后退条件**（任一触发）:
- 系统崩溃或严重错误
- 数据质量显著劣化
- 参数更新超时频繁
- 出现无法解释的异常

---

### 🔷 阶段2: 50%灰度（观察期：1周）

**目标**: 扩大范围，验证多交易对场景

**范围**:
- 启用动态模式切换：3-5个交易对（BTCUSDT/ETHUSDT等）
- 标准配置：
  - `hysteresis.min_active_windows = 3`（标准）
  - `hysteresis.min_quiet_windows = 6`（标准）
  - 活跃模式参数标准激进度

**启用条件**:
- ✅ 阶段1的前进条件全部满足
- ✅ 阶段1期间收集到的问题已修复
- ✅ 性能指标稳定

**前进条件**（满足全部）:
- 1周内无系统崩溃
- 所有交易对表现一致
- 性能指标稳定
- 用户/业务反馈正面
- 相比baseline有提升或持平

**后退条件**（任一触发）:
- 多个交易对同时出现问题
- 性能显著劣化
- 用户/业务强烈反对
- 出现资金安全风险

---

### 🔷 阶段3: 100%全量（观察期：2周）

**目标**: 全面启用，作为默认配置

**范围**:
- 启用动态模式切换：所有交易对
- 生产配置：
  - 根据阶段2的数据调优
  - 可选：启用`throttle_in_quiet`降采样

**启用条件**:
- ✅ 阶段2的前进条件全部满足
- ✅ 经过充分的数据分析和参数调优
- ✅ 团队一致同意

**成功标准**（观察2周后）:
- 系统稳定性≥99.9%
- 整体性能优于或等同于baseline
- 安静期资源消耗降低（如启用降采样）
- 活跃期表现提升
- 团队认可为默认配置

---

## 📝 任务清单

### 准备阶段（1-2天）

- [ ] 1.1 灰度配置准备
  - [ ] 创建 `production_gray_10pct.yaml`
  - [ ] 创建 `production_gray_50pct.yaml`
  - [ ] 创建 `production_full.yaml`
  - [ ] 配置交易对白名单

- [ ] 1.2 脚本准备
  - [ ] 灰度启动脚本
  - [ ] 灰度停止脚本
  - [ ] 回滚脚本（1分钟内回退）
  - [ ] 健康检查脚本

- [ ] 1.3 监控与告警
  - [ ] 验证Grafana仪表盘
  - [ ] 配置专用告警通道
  - [ ] 准备On-call排班
  - [ ] 设置告警升级策略

- [ ] 1.4 文档准备
  - [ ] 灰度发布SOP（标准操作流程）
  - [ ] 问题排查指南
  - [ ] 回滚操作手册
  - [ ] FAQ

- [ ] 1.5 团队准备
  - [ ] 团队培训（监控、告警、回滚）
  - [ ] 演练回滚流程
  - [ ] 确定决策机制
  - [ ] 准备沟通渠道

### 阶段1执行（3天）

- [ ] 2.1 Day 0: 启动
  - [ ] 部署10%灰度配置
  - [ ] 启动服务
  - [ ] 确认切换正常
  - [ ] 持续监控6小时

- [ ] 2.2 Day 1-2: 观察
  - [ ] 每4小时检查一次
  - [ ] 记录所有异常
  - [ ] 收集性能数据
  - [ ] 收集用户反馈

- [ ] 2.3 Day 3: 评估
  - [ ] 生成评估报告
  - [ ] 团队决策会议
  - [ ] 决定：前进/保持/后退

### 阶段2执行（1周）

- [ ] 3.1 Week 0: 启动50%灰度
- [ ] 3.2 Week 0-1: 每日监控与记录
- [ ] 3.3 Week 1 End: 评估与决策

### 阶段3执行（2周）

- [ ] 4.1 Week 0: 启动100%全量
- [ ] 4.2 Week 0-2: 持续监控
- [ ] 4.3 Week 2 End: 最终评估

### 收尾阶段（1-2天）

- [ ] 5.1 知识沉淀
  - [ ] 总结灰度发布经验
  - [ ] 记录遇到的问题与解决方案
  - [ ] 更新文档
  - [ ] 整理最佳实践

- [ ] 5.2 清理与归档
  - [ ] 归档灰度配置
  - [ ] 归档测试数据
  - [ ] 更新生产配置为默认

---

## ✅ 验收标准

### 灰度流程
- [ ] **V1**: 3个阶段按计划执行
- [ ] **V2**: 每个阶段都有明确的前进/后退决策
- [ ] **V3**: 问题能在每个阶段被及时发现和处理

### 稳定性
- [ ] **V4**: 整个灰度期间系统稳定性≥99.9%
- [ ] **V5**: 无critical级别问题
- [ ] **V6**: 所有问题都有记录和解决方案

### 性能
- [ ] **V7**: 相比baseline无显著劣化
- [ ] **V8**: 安静期资源消耗降低≥30%（如启用降采样）
- [ ] **V9**: 活跃期性能提升或持平

### 文档与知识
- [ ] **V10**: 所有操作文档完整
- [ ] **V11**: 问题记录详细
- [ ] **V12**: 经验总结全面

**通过标准**: 12/12 验收全部通过

---

## ⚠️ 风险与预案

### 风险识别

| 风险 | 概率 | 影响 | 预案 |
|------|------|------|------|
| 系统崩溃 | 低 | 高 | 立即回滚，1分钟内恢复 |
| 参数更新超时 | 中 | 中 | 调整hysteresis参数 |
| 数据质量劣化 | 低 | 高 | 回滚，重新调优参数 |
| 模式切换频繁 | 中 | 低 | 调整阈值，加强迟滞 |
| 告警过多 | 中 | 低 | 调整告警阈值 |
| 用户投诉 | 低 | 中 | 快速响应，必要时回滚 |

### 回滚策略

**1分钟快速回滚**:
```bash
# 1. 停止当前服务
./scripts/stop_gray_release.sh

# 2. 切换到baseline配置
export STRATEGY_MODE=quiet  # 强制quiet模式
export DYNAMIC_MODE_ENABLED=false  # 禁用动态切换

# 3. 重启服务
./scripts/start_baseline.sh

# 4. 验证
./scripts/health_check.sh
```

---

## 📊 监控指标

### 核心指标（实时）

| 指标 | 正常范围 | 告警阈值 | 说明 |
|------|---------|---------|------|
| 系统运行时间 | >99.9% | <99% | 稳定性 |
| 模式切换频率 | 4-8次/天 | >15次/天 | 防抖动 |
| 参数更新P99 | <100ms | >200ms | 性能 |
| 数据丢失率 | 0% | >0.1% | 数据质量 |
| CPU使用率 | <50% | >70% | 资源 |
| 内存使用 | <2GB | >3GB | 资源 |

### 业务指标（每日）

| 指标 | 对比基准 | 告警阈值 | 说明 |
|------|---------|---------|------|
| OFI信号质量 | baseline | -5% | - |
| CVD信号质量 | baseline | -5% | - |
| Z-score分布 | baseline | 偏离>10% | - |
| 策略收益 | baseline | -5% | - |

---

## 📦 交付物

### 配置文件
- `config/production_gray_10pct.yaml`
- `config/production_gray_50pct.yaml`
- `config/production_full.yaml`

### 脚本
- `scripts/gray_release/start_10pct.sh`
- `scripts/gray_release/start_50pct.sh`
- `scripts/gray_release/start_full.sh`
- `scripts/gray_release/rollback.sh`
- `scripts/gray_release/health_check.sh`

### 文档
- `docs/GRAY_RELEASE_SOP.md` - 标准操作流程
- `docs/GRAY_RELEASE_TROUBLESHOOTING.md` - 问题排查
- `docs/GRAY_RELEASE_ROLLBACK.md` - 回滚操作
- `docs/reports/GRAY_RELEASE_REPORT_[DATE].md` - 最终报告

---

**任务创建时间**: 2025-10-19 06:40  
**任务状态**: ⏳ 待开始

**特别注意**: 
- 生产灰度是高风险操作，必须严格遵循SOP
- 任何阶段出现问题，优先保证资金安全
- 决策必须基于数据，而非主观判断
- 保持团队沟通畅通，及时同步信息

