# Task 1.2.16: 真实环境24小时测试

## 📋 任务信息

- **任务编号**: Task_1.2.16
- **任务名称**: 真实环境24小时动态模式切换测试
- **所属阶段**: 阶段1 - 真实OFI+CVD核心
- **优先级**: 高
- **预计时间**: 24小时测试 + 2小时分析
- **实际时间**: ___（完成后填写）___
- **任务状态**: ⏳ 待开始
- **前置任务**: 
  - ✅ Task_0.7（动态模式切换框架）
  - ⏳ Task_1.2.14（集成CVD模块参数热更新）
  - ⏳ Task_1.2.15（集成OFI/Risk/Performance模块）

---

## 🎯 任务目标

在真实市场环境下运行24小时，验证动态模式切换系统的稳定性、准确性和性能，观察不同市场时段（活跃/安静）的参数切换效果。

### 核心目标

1. **稳定性验证** - 24小时连续运行无崩溃
2. **模式切换验证** - 自动切换符合预期（时间表+市场指标）
3. **参数生效验证** - OFI+CVD参数在不同模式下正确应用
4. **性能验证** - 参数更新耗时≤100ms，无数据丢失
5. **数据质量验证** - OFI/CVD序列连续性，Z-score合理

---

## 📝 任务清单

### 阶段1: 测试准备（1小时）

- [ ] 1.1 配置测试环境
  - [ ] 确认使用 `production.yaml` 配置
  - [ ] 设置 `strategy.mode = auto`（自动模式）
  - [ ] 配置正确的活跃时间窗口（HKT）
  - [ ] 启用所有 Prometheus 指标

- [ ] 1.2 准备监控工具
  - [ ] 部署 Prometheus（如未部署）
  - [ ] 配置告警规则（6条策略告警）
  - [ ] 准备日志收集（filebeat/logstash）
  - [ ] 准备监控脚本（实时查看模式切换）

- [ ] 1.3 准备测试脚本
  - [ ] 创建启动脚本
  - [ ] 创建停止脚本
  - [ ] 创建状态检查脚本
  - [ ] 创建紧急回滚脚本

### 阶段2: 24小时测试执行

- [ ] 2.1 启动测试（记录时间：___）
  - [ ] 启动 OFI+CVD 实时计算
  - [ ] 启动 StrategyModeManager
  - [ ] 确认初始模式（active/quiet）
  - [ ] 确认所有指标正常上报

- [ ] 2.2 定时检查（每4小时）
  - [ ] **00:00-04:00**: 检查 ___ 次，模式 ___，异常 ___
  - [ ] **04:00-08:00**: 检查 ___ 次，模式 ___，异常 ___
  - [ ] **08:00-12:00**: 检查 ___ 次，模式 ___，异常 ___
  - [ ] **12:00-16:00**: 检查 ___ 次，模式 ___，异常 ___
  - [ ] **16:00-20:00**: 检查 ___ 次，模式 ___，异常 ___
  - [ ] **20:00-24:00**: 检查 ___ 次，模式 ___，异常 ___

- [ ] 2.3 关键时段观测
  - [ ] 凌晨2-6点（安静期）
  - [ ] 上午9-12点（亚洲活跃）
  - [ ] 下午14-17点（亚洲下午）
  - [ ] 晚上21-次日2点（欧美+跨午夜）

- [ ] 2.4 停止测试（记录时间：___）
  - [ ] 优雅停止服务
  - [ ] 导出所有数据
  - [ ] 收集所有日志
  - [ ] 导出 Prometheus 指标

### 阶段3: 数据分析（2小时）

- [ ] 3.1 模式切换分析
  - [ ] 统计切换次数（active ↔ quiet）
  - [ ] 分析切换原因分布（schedule/market/hysteresis）
  - [ ] 验证切换时间点与预期一致
  - [ ] 检查是否有抖动切换

- [ ] 3.2 参数生效分析
  - [ ] 对比不同模式下的参数实际值
  - [ ] 验证参数更新日志完整
  - [ ] 检查params_diff记录

- [ ] 3.3 性能分析
  - [ ] 参数更新耗时分布（P50/P95/P99）
  - [ ] 数据处理延迟（P95）
  - [ ] 队列丢弃率（应为0）
  - [ ] 内存使用趋势

- [ ] 3.4 数据质量分析
  - [ ] OFI/CVD序列连续性
  - [ ] Z-score分布合理性
  - [ ] 模式切换点的数据连续性
  - [ ] 异常值统计

- [ ] 3.5 告警分析
  - [ ] 统计触发的告警
  - [ ] 分析告警合理性
  - [ ] 调整告警阈值建议

---

## 📦 Allowed Files

### 允许创建的文件
- `scripts/start_24h_test.sh` - 启动脚本
- `scripts/monitor_24h_test.py` - 监控脚本
- `scripts/analyze_24h_test.py` - 分析脚本
- `docs/reports/24H_TEST_REPORT_[DATE].md` - 测试报告

### 允许修改的文件
- `config/environments/production.yaml` - 测试配置微调

### 不允许修改的文件
- 核心算法文件（除非发现bug）
- 配置结构文件

---

## ✅ 验证标准

### 稳定性验证
- [ ] **V1**: 24小时连续运行无崩溃
- [ ] **V2**: 无内存泄漏（内存增长<5%）
- [ ] **V3**: 无连接断开（或自动重连成功）
- [ ] **V4**: 日志文件大小可控（<500MB）

### 模式切换验证
- [ ] **V5**: 自动切换次数在合理范围（4-12次/24h）
- [ ] **V6**: 切换原因分布合理（schedule主导）
- [ ] **V7**: 无抖动切换（连续切换间隔≥60s）
- [ ] **V8**: 跨午夜窗口正确处理（21:00-02:00）

### 参数生效验证
- [ ] **V9**: 每次切换后参数确实更新
- [ ] **V10**: params_diff日志完整准确
- [ ] **V11**: OFI/CVD使用新参数计算

### 性能验证
- [ ] **V12**: 参数更新P99 ≤ 100ms
- [ ] **V13**: 数据处理延迟P95 ≤ 5s（分析模式）
- [ ] **V14**: 队列丢弃率 = 0%
- [ ] **V15**: CPU使用率 < 50%（平均）

### 数据质量验证
- [ ] **V16**: OFI/CVD序列无断点
- [ ] **V17**: Z-score分布合理（P(|Z|>2)≤10%）
- [ ] **V18**: 模式切换点无异常值

**通过标准**: 18/18 验证全部通过

---

## 🧪 测试结果

### 测试基本信息

| 项目 | 信息 |
|------|------|
| 测试开始时间 | ___ |
| 测试结束时间 | ___ |
| 实际测试时长 | ___ 小时 |
| 测试交易对 | BTCUSDT / ETHUSDT |
| 测试环境 | Production配置 + 真实币安数据 |

### 模式切换统计

| 指标 | 数值 | 说明 |
|------|------|------|
| 总切换次数 | ___ | active ↔ quiet |
| active → quiet | ___ | - |
| quiet → active | ___ | - |
| 切换原因：schedule | ___ % | - |
| 切换原因：market | ___ % | - |
| 切换原因：hysteresis | ___ % | - |
| 平均切换间隔 | ___ 分钟 | - |
| 最短切换间隔 | ___ 分钟 | 应≥60s |

### 性能指标

| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| 参数更新P50 | ≤50ms | ___ ms | ___ |
| 参数更新P95 | ≤80ms | ___ ms | ___ |
| 参数更新P99 | ≤100ms | ___ ms | ___ |
| 数据延迟P95 | ≤5s | ___ s | ___ |
| 队列丢弃率 | 0% | ___ % | ___ |
| CPU使用率（平均） | <50% | ___ % | ___ |
| 内存使用（峰值） | <2GB | ___ MB | ___ |

### 数据质量指标

| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| OFI记录数 | >50000 | ___ | ___ |
| CVD记录数 | >50000 | ___ | ___ |
| 数据连续性 | 100% | ___ % | ___ |
| Z-score P(>\|2\|) | ≤10% | ___ % | ___ |
| Z-score P(>\|3\|) | ≤2% | ___ % | ___ |
| 异常值率 | <0.1% | ___ % | ___ |

### 告警统计

| 告警名称 | 触发次数 | 是否合理 | 备注 |
|---------|---------|---------|------|
| StrategyModeSwitchingTooFrequently | ___ | ___ | - |
| StrategyModeStuckInQuiet | ___ | ___ | - |
| StrategyParamsUpdateFailed | ___ | ___ | - |
| StrategyModeMetricsStale | ___ | ___ | - |
| StrategyParamsUpdateSlow | ___ | ___ | - |
| CryptoMarketUnusuallyActiveAtNight | ___ | ___ | - |

---

## 📊 DoD检查清单

### 测试完整性
- [ ] 24小时完整运行
- [ ] 每个时段都有检查记录
- [ ] 所有数据已导出
- [ ] 所有日志已收集

### 数据分析
- [ ] 模式切换分析完成
- [ ] 参数生效分析完成
- [ ] 性能分析完成
- [ ] 数据质量分析完成
- [ ] 告警分析完成

### 报告完善
- [ ] 生成详细测试报告
- [ ] 包含所有图表（模式切换、性能、数据质量）
- [ ] 问题清单（如有）
- [ ] 优化建议（如有）

### 决策支持
- [ ] 是否通过24小时稳定性测试
- [ ] 是否可以进入生产灰度
- [ ] 需要调优的参数清单
- [ ] 风险评估

---

## 📝 执行记录

### 测试时间线

| 时间点 | 事件 | 模式 | 说明 |
|--------|------|------|------|
| ___ | 测试开始 | ___ | - |
| ___ | 首次切换 | ___ → ___ | - |
| ___ | ___ | ___ | - |
| ___ | ___ | ___ | - |
| ___ | 测试结束 | ___ | - |

### 遇到的问题
___（记录遇到的问题）___

### 解决方案
___（记录解决方案）___

### 优化建议
___（记录优化建议）___

---

## 🔗 相关链接

### 前置任务
- [Task_0.7_动态模式切换与差异化配置](../Stage0_准备工作/✅Task_0.7_动态模式切换与差异化配置.md)
- [Task_1.2.14_集成CVD模块参数热更新](./Task_1.2.14_集成CVD模块参数热更新.md)
- [Task_1.2.15_集成OFI/Risk/Performance模块](./Task_1.2.15_集成OFI与Risk模块参数热更新.md)

### 后续任务
- [Task_1.3.6_端到端集成测试](./Task_1.3.6_端到端集成测试.md)
- [Task_0.8_创建Grafana监控仪表盘](../Stage0_准备工作/Task_0.8_创建Grafana监控仪表盘.md)

### 参考文档
- [Task_0.7_FINAL_COMPLETION_REPORT.md](../Stage0_准备工作/Task_0.7_FINAL_COMPLETION_REPORT.md)
- [alerting_rules_strategy.yaml](../../config/alerting_rules_strategy.yaml)

---

## ⚠️ 注意事项

### 测试准备

1. **选择合适的时间点**
   - 避开重大新闻发布时段
   - 确保网络环境稳定
   - 提前通知相关人员

2. **备份与回滚**
   - 备份当前稳定配置
   - 准备回滚脚本
   - 确保可以快速恢复

3. **监控准备**
   - 确认Prometheus正常运行
   - 确认告警通道畅通
   - 准备手机/邮件通知

### 测试执行

1. **定时检查**
   - 每4小时至少检查一次
   - 关键时段（凌晨、跨午夜）重点观察
   - 记录所有异常现象

2. **数据保护**
   - 定时备份数据
   - 避免磁盘空间不足
   - 确保数据完整性

3. **应急处理**
   - 发现严重问题立即停止
   - 保留现场数据和日志
   - 执行回滚计划

### 数据分析

1. **全面性**
   - 不只看成功案例
   - 重点分析异常时段
   - 对比不同模式的表现

2. **客观性**
   - 基于数据而非主观感受
   - 记录所有发现（好的和坏的）
   - 给出量化指标

3. **可操作性**
   - 问题要有复现路径
   - 建议要有具体参数
   - 风险要有缓解措施

---

## 💡 监控脚本示例

### 实时监控脚本

```python
# scripts/monitor_24h_test.py
import time
import requests
from datetime import datetime

PROMETHEUS_URL = "http://localhost:9090"

def get_current_mode():
    """查询当前策略模式"""
    query = "strategy_mode_active"
    response = requests.get(f"{PROMETHEUS_URL}/api/v1/query", params={"query": query})
    value = response.json()['data']['result'][0]['value'][1]
    return "active" if int(value) == 1 else "quiet"

def get_transitions_count():
    """查询切换次数"""
    query = "strategy_mode_transitions_total"
    response = requests.get(f"{PROMETHEUS_URL}/api/v1/query", params={"query": query})
    results = response.json()['data']['result']
    return sum(int(r['value'][1]) for r in results)

def main():
    print("📊 24小时测试监控")
    print("=" * 60)
    
    start_time = time.time()
    last_mode = None
    
    while True:
        try:
            current_mode = get_current_mode()
            transitions = get_transitions_count()
            elapsed = (time.time() - start_time) / 3600  # 小时
            
            # 检测模式切换
            if current_mode != last_mode and last_mode is not None:
                print(f"\n🔄 [{datetime.now()}] 模式切换: {last_mode} → {current_mode}")
            
            last_mode = current_mode
            
            # 定时报告
            print(f"[{datetime.now().strftime('%H:%M:%S')}] "
                  f"模式={current_mode}, 切换={transitions}次, 运行={elapsed:.1f}h")
            
            time.sleep(60)  # 每分钟检查一次
            
        except KeyboardInterrupt:
            print("\n\n测试监控停止")
            break
        except Exception as e:
            print(f"❌ 错误: {e}")
            time.sleep(60)

if __name__ == "__main__":
    main()
```

---

**任务创建时间**: 2025-10-19 06:25  
**任务创建者**: AI Assistant  
**任务版本**: V1.0  
**任务状态**: ⏳ 待开始

