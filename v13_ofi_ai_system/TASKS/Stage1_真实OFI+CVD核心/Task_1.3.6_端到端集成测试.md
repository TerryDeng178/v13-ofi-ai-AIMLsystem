# Task 1.3.6: 端到端集成测试（动态模式切换）

## 📋 任务信息

- **任务编号**: Task_1.3.6
- **任务名称**: 端到端集成测试（含动态模式切换）
- **所属阶段**: 阶段1 - 真实OFI+CVD核心
- **优先级**: 高
- **预计时间**: 4-6小时测试 + 2小时分析
- **实际时间**: ___（完成后填写）___
- **任务状态**: ⏳ 待开始
- **前置任务**: 
  - ✅ Task_1.2.14（集成CVD模块参数热更新）
  - ✅ Task_1.2.15（集成OFI/Risk/Performance模块）
  - ✅ Task_1.2.16（24小时真实环境测试）

---

## 🎯 任务目标

通过回放历史数据或合成数据流，验证完整的动态模式切换系统在各种场景下的正确性、连续性和鲁棒性。

### 核心目标

1. **场景覆盖** - 测试所有关键场景（正常切换、边界条件、异常处理）
2. **数据连续性** - 验证参数切换不破坏OFI/CVD序列
3. **性能达标** - 确认所有性能指标满足要求
4. **回滚验证** - 验证失败回滚机制
5. **可重现性** - 确保测试可重复执行

---

## 📝 任务清单

### 阶段1: 测试准备（1小时）

- [ ] 1.1 准备测试数据
  - [ ] 准备4小时历史数据（含活跃/安静时段）
  - [ ] 或创建合成数据流（模拟不同市场状态）
  - [ ] 准备异常数据（网络抖动、极端行情）

- [ ] 1.2 准备测试环境
  - [ ] 配置testing.yaml
  - [ ] 设置快速切换参数（缩短hysteresis时间）
  - [ ] 启用详细日志

- [ ] 1.3 准备测试脚本
  - [ ] 回放脚本
  - [ ] 验证脚本
  - [ ] 数据分析脚本

### 阶段2: 场景测试（3-4小时）

**场景1: 正常模式切换**
- [ ] 2.1 schedule触发：quiet → active（模拟9:00进入活跃窗口）
- [ ] 2.2 schedule触发：active → quiet（模拟12:00离开活跃窗口）
- [ ] 2.3 market触发：quiet → active（市场突然活跃）
- [ ] 2.4 market触发：active → quiet（市场突然安静）

**场景2: 跨午夜与边界**
- [ ] 2.5 跨午夜窗口（21:00-02:00）测试
- [ ] 2.6 窗口边界（活跃窗口起点/终点）测试
- [ ] 2.7 周末与节假日判定测试

**场景3: 迟滞防抖**
- [ ] 2.8 抖动流测试（市场指标频繁波动）
- [ ] 2.9 短时活跃测试（活跃<3个窗口）
- [ ] 2.10 短时安静测试（安静<6个窗口）

**场景4: 参数更新与数据连续性**
- [ ] 2.11 验证OFI参数切换后bucket正确调整
- [ ] 2.12 验证CVD参数切换后window/EMA正确调整
- [ ] 2.13 验证切换点的数据连续性
- [ ] 2.14 验证Z-score序列合理性

**场景5: 异常处理与回滚**
- [ ] 2.15 单模块更新失败（模拟CVD更新失败）
- [ ] 2.16 多模块更新失败
- [ ] 2.17 验证回滚机制
- [ ] 2.18 验证失败告警

**场景6: 性能压力**
- [ ] 2.19 高频切换测试（缩短hysteresis时间）
- [ ] 2.20 极端行情测试（trades>1000/min）
- [ ] 2.21 网络抖动测试（模拟延迟）

### 阶段3: 数据分析（2小时）

- [ ] 3.1 统计所有切换事件
- [ ] 3.2 验证每次切换的参数diff
- [ ] 3.3 分析OFI/CVD序列连续性
- [ ] 3.4 分析性能指标（耗时、延迟）
- [ ] 3.5 生成测试报告

---

## ✅ 验收标准

### 场景覆盖
- [ ] **V1**: 18个关键场景全部执行
- [ ] **V2**: 每个场景有明确的通过/失败判定
- [ ] **V3**: 边界条件和异常场景覆盖

### 数据连续性
- [ ] **V4**: OFI/CVD序列无断点
- [ ] **V5**: 切换点前后数据平滑过渡
- [ ] **V6**: Z-score无异常跳变（除预期尺度变化）

### 性能达标
- [ ] **V7**: 参数更新P99 ≤ 100ms
- [ ] **V8**: 无数据丢失（queue_dropped=0）
- [ ] **V9**: 系统稳定性100%（无崩溃）

### 回滚验证
- [ ] **V10**: 单模块失败能正确回滚
- [ ] **V11**: 多模块失败能正确回滚
- [ ] **V12**: 失败告警正确触发

### 可重现性
- [ ] **V13**: 同样输入产生同样输出
- [ ] **V14**: 测试可自动化执行
- [ ] **V15**: 测试报告自动生成

**通过标准**: 15/15 验收全部通过

---

## 🧪 测试结果

### 场景测试结果

| 场景 | 状态 | 切换耗时 | 数据连续性 | 备注 |
|------|------|---------|-----------|------|
| schedule: quiet→active | ___ | ___ ms | ___% | - |
| schedule: active→quiet | ___ | ___ ms | ___% | - |
| market: quiet→active | ___ | ___ ms | ___% | - |
| market: active→quiet | ___ | ___ ms | ___% | - |
| 跨午夜窗口 | ___ | ___ ms | ___% | - |
| 窗口边界 | ___ | ___ ms | ___% | - |
| 抖动流防抖 | ___ | ___ | ___% | - |
| 短时活跃(<3窗口) | ___ | ___ | ___% | - |
| 短时安静(<6窗口) | ___ | ___ | ___% | - |
| OFI参数切换 | ___ | ___ ms | ___% | - |
| CVD参数切换 | ___ | ___ ms | ___% | - |
| 切换点连续性 | ___ | ___ | ___% | - |
| 单模块失败 | ___ | ___ | ___ | - |
| 多模块失败 | ___ | ___ | ___ | - |
| 回滚机制 | ___ | ___ | ___ | - |
| 失败告警 | ___ | ___ | ___ | - |
| 高频切换 | ___ | ___ ms | ___% | - |
| 极端行情 | ___ | ___ ms | ___% | - |

### 性能统计

| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| 总测试时长 | 4-6h | ___ h | ___ |
| 总切换次数 | >30 | ___ | ___ |
| 参数更新P99 | ≤100ms | ___ ms | ___ |
| 数据丢失率 | 0% | ___ % | ___ |
| 系统崩溃次数 | 0 | ___ | ___ |
| 回滚成功率 | 100% | ___ % | ___ |

---

## 📦 交付物

- `tests/integration/test_e2e_mode_switching.py` - 端到端测试脚本
- `tests/integration/test_data/` - 测试数据
- `docs/reports/E2E_TEST_REPORT_[DATE].md` - 测试报告
- `scripts/run_e2e_tests.sh` - 自动化测试脚本

---

**任务创建时间**: 2025-10-19 06:35  
**任务状态**: ⏳ 待开始

