# CVD系统架构图

## 🏗️ **系统组件关系**

```
┌─────────────────────────────────────────────────────────────────┐
│                        CVD系统架构                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   币安WebSocket  │───▶│  WatermarkBuffer │───▶│RealCVDCalculator│
│   (数据源)       │    │   (数据重排序)   │    │   (核心计算)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   配置管理       │    │   监控系统       │    │   数据存储       │
│  (analysis.env) │    │  (dashboard)    │    │  (parquet)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   质量门控       │    │   分析报告       │    │   优化计划       │
│  (validation)   │    │  (analysis.py)  │    │  (P1.2 roadmap) │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🔄 **数据流处理**

### 1. 数据采集阶段
```
币安WebSocket → JSON解析 → 数据验证 → WatermarkBuffer
```

### 2. CVD计算阶段
```
Trade数据 → Delta计算 → 尺度计算 → Z-score标准化 → 软冻结处理
```

### 3. 质量控制阶段
```
Z-score → 质量门控 → 监控告警 → 数据存储
```

## 📊 **关键算法流程**

### Delta-Z计算流程
```
1. 计算Delta: delta = cvd_t - cvd_{t-1}
2. 更新EWMA: ewma_fast, ewma_slow
3. 计算MAD: mad_raw = MAD(|delta - median|)
4. 混合尺度: scale = max(ewma_mix, sigma_floor)
5. Z-score: z = delta / scale
6. Winsorize: z_final = clip(z, -8.0, 8.0)
```

### 软冻结逻辑
```
1. 计算间隔: interarrival = event_time_t - event_time_{t-1}
2. 判断冻结:
   - >5s → 硬冻结2笔
   - 3.5-5s → 软冻结1笔
   - <3.5s → 正常计算
3. 执行冻结: z = None if post_stale_remaining > 0
```

## 🎯 **质量门控流程**

### 硬线指标检查
```
P(|Z|>2) ≤ 8% ✓
median(|Z|) ≤ 1.0 ✓
数据完整性 = 100% ✓
数据一致性 = 100% ✓
ID健康 = 100% ✓
```

### 优化指标监控
```
P(|Z|>3) ≤ 2% (当前4.65%)
P95(|Z|) ≤ 3.0 (当前2.71)
延迟P95 ≤ 5s (当前4-5s)
```

## 🔧 **配置层次结构**

### 生产配置
```
config/profiles/
├── analysis.env     # 分析模式 (WATERMARK_MS=2000)
└── realtime.env     # 实时模式 (WATERMARK_MS=500)
```

### 微调配置
```
config/step_1_*.env  # 历史微调配置
config/p1_*.env      # 阶段配置
```

## 📈 **监控体系**

### 实时监控
- Z-score质量指标
- 尺度分母健康
- 数据完整性状态
- 系统性能指标

### 告警机制
- 临界告警: P(|Z|>3) > 8%
- 警告告警: P(|Z|>3) > 5%
- 信息告警: 尺度地板过低

## 🚀 **部署架构**

### 单机部署
```
┌─────────────────────────────────────┐
│           单机CVD系统               │
├─────────────────────────────────────┤
│  WebSocket客户端                    │
│  CVD计算引擎                        │
│  数据存储                           │
│  监控系统                           │
└─────────────────────────────────────┘
```

### 未来扩展
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ 数据采集节点 │  │ 计算处理节点 │  │ 存储分析节点 │
└─────────────┘  └─────────────┘  └─────────────┘
        │                │                │
        └────────────────┼────────────────┘
                         │
                ┌─────────────┐
                │  监控中心    │
                └─────────────┘
```

## 🔍 **故障排查流程**

### 问题诊断树
```
Z-score质量不达标
├── 检查MAD_MULTIPLIER
├── 验证SCALE_FAST_WEIGHT
├── 确认软冻结逻辑
└── 检查数据样本

数据解析错误
├── 检查网络连接
├── 验证WebSocket URL
├── 确认JSON格式
└── 检查解析逻辑

延迟过高
├── 调整WATERMARK_MS
├── 检查系统负载
├── 验证网络延迟
└── 优化处理逻辑
```

## 📚 **文档结构**

```
docs/
├── CVD_SYSTEM_README.md          # 详细系统文档
├── CVD_QUICK_REFERENCE.md        # 快速参考指南
├── SYSTEM_ARCHITECTURE.md        # 系统架构说明
├── monitoring/
│   └── dashboard_config.md       # 监控配置
├── roadmap/
│   └── P1.2_optimization_plan.md # 优化计划
└── reports/
    └── STEP_1_FINAL_SUMMARY.md   # 阶段总结
```
