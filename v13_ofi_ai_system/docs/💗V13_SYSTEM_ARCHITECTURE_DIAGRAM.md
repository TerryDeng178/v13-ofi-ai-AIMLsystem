# V13 OFI+CVD+AI 系统架构图

> **V13全新架构**: 从真实数据开始，逐步构建AI能力

## 🏗️ **整体系统架构**

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          V13 OFI+CVD+AI 交易系统                                │
│                        (渐进式智能开发 Progressive Intelligence)                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐             │
│  │  真实数据输入层  │    │  核心计算层      │    │  信号处理层      │             │
│  │ (Real Data)    │    │ (Core Calc)    │    │ (Signal Proc)  │             │
│  │                │    │                │    │                │             │
│  │ • 币安WebSocket │    │ • 真实OFI计算   │    │ • OFI信号生成   │             │
│  │ • 订单簿流(5档) │───▶│ • 真实CVD计算   │───▶│ • CVD信号生成   │             │
│  │ • 成交流(aggTrade)│  │ • 融合指标      │    │ • 融合信号      │             │
│  │ • 实时序列监控  │    │ • 背离检测      │    │ • 背离信号      │             │
│  │                │    │ • Z-score标准化 │    │ • 信号验证      │             │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘             │
│           │                        │                        │                │
│           │                        │                        │                │
│           ▼                        ▼                        ▼                │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐             │
│  │  数据存储层      │    │  AI模型层        │    │  交易执行层      │             │
│  │ (Data Storage) │    │ (AI Models)    │    │ (Execution)    │             │
│  │                │    │                │    │                │             │
│  │ • NDJSON原始流  │    │ • OFI专家模型   │    │ • 测试网交易     │             │
│  │ • Parquet分析库 │    │ • LSTM模型      │    │ • 简单策略      │             │
│  │ • 内存缓存      │    │ • Transformer   │    │ • 风险管理      │             │
│  │ • 延迟追踪      │    │ • CNN模型       │    │ • 成本控制      │             │
│  │ • 序列一致性    │    │ • 集成模型      │    │ • 动态仓位      │             │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘             │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 🔄 **V13渐进式开发流程**

```
阶段0: 准备工作 (1天)
┌──────────────────┐
│  项目环境准备     │
│  • 目录结构       │
│  • 依赖配置       │
│  • 归档V12       │
└──────────────────┘
         │
         ▼
阶段1: 真实OFI+CVD核心 (8-10天) 🔥 核心阶段
┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│ 1.1 真实数据接入  │───▶│ 1.2 真实OFI+CVD   │───▶│ 1.3 OFI+CVD验证   │
│                 │    │      计算         │    │                 │
│ • WebSocket连接  │    │ • OFI计算器      │    │ • 收集历史数据    │
│ • 订单簿数据     │    │ • CVD计算器      │    │ • 信号分析       │
│ • 成交数据       │    │ • Z-score标准化  │    │ • 预测能力       │
│ • 数据存储       │    │ • 融合指标       │    │ • 验证报告       │
│ • 打印日志       │    │ • 背离检测       │    │ • 阶段总结       │
│ • 测试验证       │    │ • 集成测试       │    │                 │
└──────────────────┘    └──────────────────┘    └──────────────────┘
         │
         ▼
阶段2: 简单真实交易 (3-5天)
┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│ 2.1 测试网交易    │───▶│ 2.2 简单策略      │───▶│ 2.3 交易测试      │
│                 │    │                 │    │                 │
│ • 测试网客户端   │    │ • 基于OFI+CVD    │    │ • 24小时测试     │
│ • 下单功能       │    │ • 开仓逻辑       │    │ • 交易分析       │
│ • 订单管理       │    │ • 平仓逻辑       │    │ • 报告生成       │
│ • 功能测试       │    │ • 风险控制       │    │ • 阶段决策       │
└──────────────────┘    └──────────────────┘    └──────────────────┘
         │
         ▼
阶段3: 逐步加入AI (4-6天)
┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐
│ 3.1 真实数据收集  │───▶│ 3.2 AI模型训练    │───▶│ 3.3 AI策略验证    │
│                 │    │                 │    │                 │
│ • 收集交易数据   │    │ • OFI专家模型    │    │ • AI信号过滤     │
│ • 特征工程       │    │ • 简单神经网络   │    │ • 测试网验证     │
│ • 数据清洗       │    │ • 模型优化       │    │ • 策略对比       │
│ • 预处理         │    │ • 保存加载       │    │ • 阶段总结       │
└──────────────────┘    └──────────────────┘    └──────────────────┘
         │
         ▼
阶段4: 深度学习优化 (可选，5-8天)
┌──────────────────┐    ┌──────────────────┐
│ 4.1 深度学习模型  │───▶│ 4.2 模型集成      │
│                 │    │                 │
│ • LSTM模型       │    │ • A/B测试        │
│ • 时间序列数据   │    │ • 模型选择       │
│ • 模型训练       │    │ • 最优策略       │
│ • 模型集成       │    │ • 项目总结       │
└──────────────────┘    └──────────────────┘
```

## 📊 **真实数据流架构 (V13核心)**

```
币安真实数据流:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  币安Futures │───▶│  WebSocket  │───▶│  数据验证    │───▶│  特征提取    │
│     API     │    │  实时流     │    │            │    │  OFI+CVD    │
│             │    │             │    │ • 序列检查   │    │  特征向量    │
│ • 订单簿流   │    │ • depth流    │    │ • 延迟监控   │    │            │
│ • 成交流     │    │ • aggTrade流 │    │ • 完整性     │    │ • OFI Z值   │
│ • 5档深度    │    │ • 100ms推送  │    │ • 质量评分   │    │ • CVD Z值   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                              │
                                                              ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  测试网交易  │◀───│  信号生成    │◀───│  OFI+CVD计算 │◀───│  数据输入    │
│            │    │            │    │            │    │            │
│ • 限价单     │    │ • 融合信号   │    │ • 订单簿OFI  │    │ • 实时数据   │
│ • 市价单     │    │ • 背离信号   │    │ • 成交CVD    │    │ • 历史回放   │
│ • 风险控制   │    │ • 质量评分   │    │ • 融合指标   │    │ • 序列完整   │
│ • 仓位管理   │    │ • 置信度     │    │ • Z-score    │    │ • 延迟跟踪   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 🧠 **V13核心计算层架构**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          OFI+CVD 核心计算层                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ 订单簿流     │  │  OFI计算器   │  │ 成交流       │  │  CVD计算器   │   │
│  │ (depth)    │  │             │  │ (aggTrade) │  │             │   │
│  │            │  │ • 5档OFI     │  │            │  │ • 主动买卖   │   │
│  │ • 实时5档   │──▶│ • 深度权重   │  │ • 买方主动   │──▶│ • 累积差值   │   │
│  │ • 序列号U,u │  │ • 滚动计算   │  │ • 卖方主动   │  │ • EMA平滑   │   │
│  │ • 100ms更新 │  │ • Z-score    │  │ • 数量统计   │  │ • Z-score    │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
│        │                │                │                │           │
│        │                │                │                │           │
│        ▼                ▼                ▼                ▼           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                     OFI+CVD 融合指标层                              │ │
│  │                                                                     │ │
│  │  融合策略: 加权平均 (OFI权重0.6 + CVD权重0.4)                       │ │
│  │  背离检测: 价格趋势 vs OFI/CVD趋势不一致                            │ │
│  │  信号生成: fusion_score + consistency + divergence_type            │ │
│  │  输出结果: 融合得分 + 信号类型 + 一致性 + 背离标识                   │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

## 💾 **V13数据存储架构**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          三层数据存储架构                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  原始流层    │    │  分析库层    │    │  内存缓存层  │                 │
│  │  (NDJSON)  │    │ (Parquet)  │    │ (Memory)   │                 │
│  │            │    │            │    │            │                 │
│  │ • 逐行写入   │───▶│ • 批量转换   │───▶│ • 热点数据   │                 │
│  │ • 易回放     │    │ • 高压缩率   │    │ • 快速查询   │                 │
│  │ • 流式处理   │    │ • 快速查询   │    │ • 实时计算   │                 │
│  │ • 顺序追加   │    │ • 列式存储   │    │ • 滚动窗口   │                 │
│  │ • 文件轮转   │    │ • 索引优化   │    │ • LRU淘汰   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
│                                                                         │
│  数据字段 (完整):                                                        │
│  - ts_recv: 接收时间戳                                                  │
│  - E: 事件时间                                                          │
│  - U, u, pu: 序列号 (首次更新ID, 末次更新ID, 上次末次ID)                 │
│  - bids, asks: 订单簿数据 [[价格, 数量], ...]                           │
│  - latency_event_ms: 事件延迟 (ts_recv - E)                            │
│  - latency_pipeline_ms: 管道延迟 (实时跟踪)                             │
│                                                                         │
│  质量监控:                                                              │
│  - 序列一致性: resyncs (pu != last_u 次数)                              │
│  - 延迟分位: p50/p95/p99                                                │
│  - 接收率: recv_rate (消息/秒)                                          │
│  - 重连次数: reconnects                                                 │
│  - 批次跨度: batch_span (u - U + 1, 观测值)                             │
└─────────────────────────────────────────────────────────────────────────┘
```

## ⚡ **V13执行引擎架构**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          渐进式执行引擎                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  阶段2: 简单真实交易 (基于OFI+CVD)                                      │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  信号接收    │    │  风险检查    │    │  订单生成    │                 │
│  │            │    │            │    │            │                 │
│  │ • OFI+CVD信号│───▶│ • 信号质量   │───▶│ • 测试网     │                 │
│  │ • 融合得分   │    │ • 风险预算   │    │ • 限价单     │                 │
│  │ • 背离信号   │    │ • 仓位限制   │    │ • 市价单     │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
│           │                │                │                          │
│           ▼                ▼                ▼                          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  订单提交    │    │  执行监控    │    │  结果反馈    │                 │
│  │            │    │            │    │            │                 │
│  │ • 测试网API  │    │ • 成交监控   │    │ • 盈亏计算   │                 │
│  │ • 订单确认   │    │ • 滑点监控   │    │ • 性能统计   │                 │
│  │ • 错误处理   │    │ • 延迟监控   │    │ • 数据收集   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
│                                                                         │
│  阶段3+: AI增强交易 (逐步加入AI能力)                                    │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  基础信号    │    │  AI过滤      │    │  增强执行    │                 │
│  │            │    │            │    │            │                 │
│  │ • OFI+CVD基础│───▶│ • 专家模型   │───▶│ • 更高质量   │                 │
│  │ • 融合指标   │    │ • 神经网络   │    │ • 更好风控   │                 │
│  │ • 历史验证   │    │ • 深度学习   │    │ • 更高胜率   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
```

## 📈 **V13性能监控架构**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          实时监控系统                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  数据质量    │    │  计算性能    │    │  交易性能    │                 │
│  │            │    │            │    │            │                 │
│  │ • 接收率     │───▶│ • OFI延迟    │───▶│ • 胜率       │                 │
│  │ • 序列完整性 │    │ • CVD延迟    │    │ • 交易频率   │                 │
│  │ • 延迟分位   │    │ • 信号延迟   │    │ • PnL        │                 │
│  │ • 重连次数   │    │ • 总延迟     │    │ • 夏普比率   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
│           │                │                │                          │
│           ▼                ▼                ▼                          │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│  │  metrics.json│    │  日志分析    │    │  报告生成    │                 │
│  │            │    │            │    │            │                 │
│  │ • 10秒刷新   │    │ • NDJSON     │    │ • 阶段报告   │                 │
│  │ • JSON格式   │    │ • 日志文件   │    │ • 验证报告   │                 │
│  │ • 完整指标   │    │ • 错误追踪   │    │ • 决策依据   │                 │
│  └─────────────┘    └─────────────┘    └─────────────┘                 │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🎯 **V13关键性能指标**

### **阶段1目标: 真实OFI+CVD核心**
- **数据质量**: 
  - 接收率: >1.0 msg/s
  - 序列一致性: resyncs=0, reconnects=0
  - 延迟p95: <2500ms (event), <100ms (pipeline)
- **计算性能**: 
  - OFI计算延迟: <10ms
  - CVD计算延迟: <5ms
  - 融合指标延迟: <3ms
- **验证标准**: 
  - 至少收集24-72小时真实数据
  - OFI/CVD信号准确率 >55%
  - 融合信号准确率 >60%

### **阶段2目标: 简单真实交易**
- **交易执行**: 
  - 测试网24小时连续运行
  - 执行成功率 >95%
  - 订单延迟 <1s
- **交易性能**: 
  - 胜率: >55% (初步目标)
  - 日交易数: 5-20笔
  - PnL: 正收益
  - 最大回撤: <10%

### **阶段3目标: AI增强**
- **AI性能**: 
  - 模型训练成功
  - 预测准确率 >60%
  - 推理延迟 <50ms
- **增强效果**: 
  - 胜率提升 5-10%
  - 信号质量提升 10-20%
  - 风险控制改善

### **阶段4目标: 深度学习优化 (可选)**
- **深度学习**: 
  - LSTM模型成功训练
  - 预测准确率 >70%
  - 集成模型效果验证
- **最终目标**: 
  - 胜率: >65%
  - 日交易数: 50-100笔
  - 夏普比率: >1.0

---

## 🔑 **V13核心设计原则**

### **1. 真实优先 (Authenticity First)**
- ✅ 每个功能都用真实币安数据验证
- ✅ 不使用模拟数据替代关键组件
- ✅ 延迟、序列、完整性必须真实追踪

### **2. 渐进式开发 (Progressive Development)**
- ✅ 从最简单的核心功能开始
- ✅ 每个阶段都有明确的验证标准
- ✅ 只有验证通过才进入下一阶段

### **3. 强约束验证 (Strong Validation)**
- ✅ 数据序列必须连续 (resyncs=0)
- ✅ 延迟必须在合理范围内
- ✅ 信号质量必须经过历史验证

### **4. 最小补丁 (Minimal Patches)**
- ✅ 每次修改只改必要的文件
- ✅ 不重写整个文件
- ✅ 接口保持向后兼容

### **5. 全局协同 (Global Coordination)**
- ✅ 所有组件必须能实际集成
- ✅ 不做孤立的"玩具"模块
- ✅ 接口清晰、文档完整

---

## 📊 **V13 vs V12 对比**

| 维度 | V12 | V13 |
|------|-----|-----|
| **数据源** | 模拟数据为主 | 真实币安数据 |
| **开发方式** | 全栈并行 | 渐进式迭代 |
| **验证标准** | 宽松或无 | 严格强约束 |
| **OFI计算** | 简化公式 | 完整5档加权 |
| **CVD功能** | ❌ 无 | ✅ 完整实现 |
| **数据存储** | CSV单层 | NDJSON+Parquet三层 |
| **序列监控** | ❌ 无 | ✅ 完整追踪 |
| **延迟监控** | ❌ 无 | ✅ 分位统计 |
| **AI集成** | 过早集成 | 数据充足后再加 |
| **测试策略** | 回测为主 | 真实交易优先 |
| **风险控制** | 理论设计 | 实盘验证 |

---

**架构设计原则**:
1. **真实性**: 所有数据、计算、交易都必须是真实的
2. **渐进性**: 先做好核心，再逐步扩展AI能力
3. **可验证**: 每个阶段都有明确的验证标准和真实数据证明
4. **高可靠**: 序列一致性、延迟监控、错误处理完善
5. **灵活性**: 支持OFI单独使用、CVD单独使用、融合使用

---

**文档版本**: V13_System_Architecture_v1.0  
**最后更新**: 2025-10-17  
**状态**: V13全新架构，基于真实数据的渐进式智能开发

