# P1.2 优化路线图

## 🎯 目标
将P(|Z|>3)从当前4.65%进一步压降到≤2%，完成8/8质量门控。

## 📊 当前状态
- ✅ P(|Z|>2): 5.73% (已达标)
- 🎯 P(|Z|>3): 4.65% (目标≤2%)
- ✅ median(|Z|): 0.0013 (优秀)
- ✅ 数据完整性: 100%
- ✅ 数据一致性: 100%
- ✅ ID健康: 100%

## 🚀 优化策略

### 策略1: 精细化地板增强
```bash
# 在现有MAD地板基础上，增加滚动分位地板
scale = max(
    ewma_mix,                           # 现有混合EWMA
    1.4826 * MAD_300 * 1.45,           # 现有MAD地板
    c * Perc90(|Δ|, 300)               # 新增：滚动90%分位地板
)
# c ≈ 0.85–0.95，防止极端低波动段分母过小
```

### 策略2: 按成交速率自适应半衰期
```bash
# 根据当前tps动态调整HALF_LIFE_TRADES
if tps > 2.0:
    HALF_LIFE_TRADES = 280  # 高频段，更快响应
elif tps < 0.5:
    HALF_LIFE_TRADES = 320  # 低频段，更稳
else:
    HALF_LIFE_TRADES = 300  # 中频段，保持当前
```

### 策略3: 扩大软冻结覆盖
```bash
# 当前: 3.5–5.0s → 1笔冻结
# 优化: 4.0–5.0s → 1笔冻结 (收紧阈值)
if interarrival_ms > 5000:
    post_stale_remaining = 2      # 硬冻结：>5s后首2笔
elif interarrival_ms > 4000:     # 从3500调整到4000
    post_stale_remaining = 1      # 软冻结：4-5s后首1笔
```

## 📋 实施计划

### Phase 1: 精细化地板 (1-2天)
1. 实现滚动分位地板计算
2. 测试c=0.85, 0.90, 0.95三个参数
3. 验证P(|Z|>3)改善效果

### Phase 2: 自适应半衰期 (1-2天)
1. 实现tps计算逻辑
2. 实现动态HALF_LIFE_TRADES调整
3. 验证不同tps段的Z-score质量

### Phase 3: 软冻结优化 (1天)
1. 调整软冻结阈值从3.5s→4.0s
2. 验证空窗后Z分布改善
3. 确认不影响正常交易段

### Phase 4: 综合验证 (1天)
1. 组合所有优化策略
2. 运行完整测试套件
3. 确认P(|Z|>3)≤2%达标

## 🎯 成功标准
- P(|Z|>2) ≤ 8% (保持)
- P(|Z|>3) ≤ 2% (目标)
- median(|Z|) ≤ 1.0 (保持)
- 所有工程指标保持100%

## 📊 监控重点
- scale_p5/p50/p95分布变化
- 空窗后首3笔|Z|分布改善
- 不同tps段的Z-score质量
- 整体尾部占比趋势
