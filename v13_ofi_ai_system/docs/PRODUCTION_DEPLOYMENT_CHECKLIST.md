# 背离检测模块生产环境部署检查清单

## 📋 部署概述

**模块**: 背离检测/评分校准  
**部署类型**: 灰度上线（Canary）  
**部署策略**: 信号只读 + 渐进放量  
**目标环境**: 生产环境  

## ✅ 预部署检查

### 1. 配置文件检查
- [ ] `runs/real_test/best_global.yaml` - 全局最佳参数
- [ ] `runs/real_test/best_by_bucket.yaml` - 分桶最佳参数  
- [ ] `config/calibration/divergence_score_calibration.json` - 校准映射
- [ ] `config/environments/production.yaml` - 生产环境配置
- [ ] `runs/metrics_test/prometheus_divergence.yml` - Prometheus配置
- [ ] `runs/metrics_test/divergence_metrics_exporter.py` - 指标导出器
- [ ] `runs/metrics_test/dashboards/divergence_overview.json` - Grafana仪表盘
- [ ] `runs/metrics_test/alerting_rules/divergence_alerts.yaml` - 告警规则

### 2. 依赖检查
- [ ] Python 3.8+ 环境
- [ ] 所有依赖包已安装 (`pip install -r requirements.txt`)
- [ ] 系统资源充足（CPU、内存、磁盘）
- [ ] 网络连接正常

### 3. 验收标准验证
- [ ] 参数调优结果：acc@10 ≥ 55%, acc@20 ≥ 55%
- [ ] 单调性验证：Spearman ρ > 0, p < 0.05
- [ ] 指标对齐：Prometheus/Grafana配置完整
- [ ] 配置热更新：支持原子更新

### 4. 监控准备
- [ ] Prometheus实例运行正常
- [ ] Grafana实例运行正常
- [ ] 告警通道配置完成
- [ ] 监控仪表盘可访问

## 🚀 部署步骤

### 阶段1: 预检 (Pre-flight)
```bash
# 1. 运行预检查
python scripts/deploy_production.py --action check

# 2. 验证指标对齐
python scripts/metrics_alignment.py --out runs/metrics_test

# 3. 测试配置热更新
python scripts/config_hot_update.py --test
```

**预期结果**: 所有检查通过，无错误

### 阶段2: 灰度部署 (Canary)
```bash
# 1. 执行灰度部署
python scripts/deploy_production.py --action deploy

# 2. 验证部署状态
curl http://localhost:8003/metrics

# 3. 检查Grafana仪表盘
# 访问: http://localhost:3000/d/divergence-monitoring-prod
```

**预期结果**: 
- 指标导出器运行正常
- Prometheus开始收集指标
- Grafana仪表盘显示数据
- 背离检测模块运行（只读模式）

### 阶段3: 观察期 (Observation)
**持续时间**: 30-60分钟  
**监控指标**:
- [ ] 事件延迟 P95 < 2.5ms
- [ ] 管线延迟 P95 < 100ms  
- [ ] 背离模块计算 P95 < 10ms
- [ ] 指标闭合误差 < 10%
- [ ] 错误率 < 1%
- [ ] 可用性 > 99.9%

### 阶段4: 放量 (Scale-up)
**条件**: 观察期指标正常  
**操作**:
- [ ] 逐步增加目标品种
- [ ] 监控系统负载
- [ ] 调整参数（如需要）

## 📊 SLO监控指标

### 延迟指标
| 指标 | 阈值 | 告警阈值 | 回滚阈值 |
|------|------|----------|----------|
| 事件延迟P95 | < 2.5ms | > 2ms | > 5ms |
| 管线延迟P95 | < 100ms | > 50ms | > 200ms |
| 背离计算P95 | < 10ms | > 5ms | > 20ms |

### 准确性指标
| 指标 | 阈值 | 告警阈值 | 回滚阈值 |
|------|------|----------|----------|
| 指标闭合误差 | < 10% | > 5% | > 15% |
| 错误率 | < 1% | > 0.5% | > 2% |
| 可用性 | > 99.9% | < 99.5% | < 99% |

### 业务指标
| 指标 | 阈值 | 告警阈值 | 回滚阈值 |
|------|------|----------|----------|
| 事件数/小时 | 10-100 | < 5 或 > 200 | < 1 或 > 500 |
| 分数中位数 | > 50 | < 40 | < 30 |
| 命中率 | > 55% | < 50% | < 45% |

## 🚨 告警规则

### 关键告警 (Critical)
- [ ] 背离检测延迟过高 (> 20ms 持续10分钟)
- [ ] 系统可用性下降 (< 99% 持续5分钟)
- [ ] 错误率过高 (> 2% 持续5分钟)
- [ ] 指标闭合误差过大 (> 15% 持续10分钟)

### 警告告警 (Warning)
- [ ] 背离检测延迟较高 (> 10ms 持续5分钟)
- [ ] 系统负载过高 (CPU > 80% 持续10分钟)
- [ ] 内存使用过高 (> 80% 持续10分钟)
- [ ] 队列积压过多 (> 1000 持续5分钟)

## 🔄 回滚计划

### 自动回滚触发条件
- [ ] 背离检测延迟 > 20ms 持续10分钟
- [ ] 系统可用性 < 99% 持续5分钟
- [ ] 错误率 > 2% 持续5分钟
- [ ] 关键指标异常持续15分钟

### 回滚操作
```bash
# 1. 执行回滚
python scripts/deploy_production.py --action rollback

# 2. 验证回滚状态
curl http://localhost:8003/metrics

# 3. 检查系统恢复
# 监控关键指标30分钟
```

### 回滚验证
- [ ] 系统恢复到稳定状态
- [ ] 关键指标恢复正常
- [ ] 无错误日志
- [ ] 监控仪表盘正常

## 📝 部署后验证

### 功能验证
- [ ] 背离检测信号正常生成
- [ ] 分数计算准确
- [ ] 校准映射生效
- [ ] 热更新功能正常

### 性能验证
- [ ] 延迟指标达标
- [ ] 吞吐量满足要求
- [ ] 资源使用合理
- [ ] 无内存泄漏

### 监控验证
- [ ] Prometheus指标正常
- [ ] Grafana仪表盘显示正确
- [ ] 告警规则生效
- [ ] 日志记录完整

## 🎯 成功标准

### 技术指标
- [ ] 所有SLO指标达标
- [ ] 无关键告警
- [ ] 系统稳定运行30分钟以上
- [ ] 性能指标符合预期

### 业务指标
- [ ] 背离检测准确率 ≥ 55%
- [ ] 信号生成稳定
- [ ] 监控数据完整
- [ ] 用户体验良好

## 📞 应急联系

### 技术负责人
- **主负责人**: V13 Team Lead
- **备用负责人**: V13 Tech Lead
- **联系方式**: [待填写]

### 运维团队
- **监控团队**: [待填写]
- **基础设施团队**: [待填写]
- **联系方式**: [待填写]

## 📋 部署记录

### 部署信息
- **部署时间**: [待填写]
- **部署版本**: v13.0
- **部署人员**: [待填写]
- **部署环境**: 生产环境

### 部署结果
- **部署状态**: [待填写]
- **关键指标**: [待填写]
- **问题记录**: [待填写]
- **后续行动**: [待填写]

---

**注意**: 本检查清单应在每次部署前仔细核对，确保所有项目都已完成。如有任何问题，请立即停止部署并联系技术团队。
