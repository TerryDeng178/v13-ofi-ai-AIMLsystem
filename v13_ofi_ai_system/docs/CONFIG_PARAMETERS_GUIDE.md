# CVD系统配置参数完全指南

## 📋 文档概述

**文档目的**: 详细说明CVD系统所有配置参数的含义、默认值、调优建议  
**适用人员**: 开发者、系统管理员、参数调优人员  
**更新时间**: 2025-10-19

---

## 🎯 核心配置参数总览

### 参数分类

| 类别 | 参数数量 | 调优难度 | 影响范围 |
|------|---------|---------|---------|
| **基础配置** | 5个 | ⭐ 低 | Z-score计算基础 |
| **混合尺度地板** | 7个 | ⭐⭐⭐ 高 | Z-score质量（尾部控制） |
| **空窗冻结** | 3个 | ⭐⭐ 中 | 异常值过滤 |
| **队列策略** | 1个 | ⭐ 低 | 数据完整性 vs 延迟 |
| **性能配置** | 3个 | ⭐ 低 | 系统性能和日志 |

---

## 📊 参数详解

### 1️⃣ 基础配置参数

#### CVD_Z_MODE
**含义**: Z-score计算模式

**可选值**:
- `delta`: Delta-Z模式（Step 1.6基线） ✅ **推荐**
- `level`: Level-Z模式（已弃用）

**默认值**: `delta`

**调优建议**:
- ✅ **固定使用`delta`**，这是Step 1.6基线的核心
- ❌ 不建议使用`level`模式（已被Delta-Z取代）

**影响**:
- 直接决定Z-score计算公式
- Delta-Z模式下：`Z = Delta_CVD / Scale`
- 影响Z质量指标（P(|Z|>2)、P(|Z|>3)）

---

#### HALF_LIFE_TRADES
**含义**: EWMA（指数加权移动平均）半衰期，单位：笔数

**默认值**: `300`

**调优范围**: `200 - 400`

**调优建议**:
- **稳定优先**: 300（Step 1.6基线） ✅
- **响应加快**: 250-280（对突发更敏感）
- **更稳健**: 320-400（更平滑，但响应慢）

**影响**:
- 控制EWMA的"记忆长度"
- 值越小 → 响应越快，但可能更"抖"
- 值越大 → 更稳定，但对突发响应慢

**经验数据**:
| 值 | P(|Z|>2) | P(|Z|>3) | 稳定性 |
|---|----------|----------|--------|
| 250 | 7-9% | 5-7% | 中 |
| 290 | 12% | 10% | 差（不推荐）|
| 300 | 5.7% ✅ | 4.7% | 优 |

---

#### WINSOR_LIMIT
**含义**: Winsorize截断限制，单位：σ（标准差倍数）

**默认值**: `8.0`

**调优范围**: `6.0 - 10.0`

**调优建议**:
- **标准值**: 8.0（Step 1.6基线） ✅
- **更保守**: 6.0-7.0（更激进的异常值处理）
- **更宽松**: 9.0-10.0（保留更多极端值）

**影响**:
- 限制Z-score的极端值：`Z ∈ [-WINSOR_LIMIT, +WINSOR_LIMIT]`
- **不影响2-3σ带内的占比**（P(|Z|>2)、P(|Z|>3)）
- 主要防止个别超大异常值

**⚠️ 注意**:
- 降低WINSOR_LIMIT不会改善P(|Z|>2)或P(|Z|>3)
- 只会"削顶"，不会改变分布的尾部占比

---

#### FREEZE_MIN
**含义**: 暖启动最小笔数，前N笔不产生Z-score

**默认值**: `80`

**调优范围**: `50 - 100`

**调优建议**:
- **标准值**: 80（Step 1.6基线） ✅
- **快速启动**: 50-60（更早产生Z，但可能不稳定）
- **更保守**: 90-100（更充分暖启动）

**影响**:
- 前N笔交易不产生Z-score（避免冷启动误差）
- 值越大 → 暖启动越充分，但延迟产生Z
- 值越小 → 更早产生Z，但初期可能不准

---

#### STALE_THRESHOLD_MS
**含义**: 空窗阈值，单位：毫秒

**默认值**: `5000` (5秒)

**调优范围**: `3000 - 10000`

**调优建议**:
- **标准值**: 5000ms（Step 1.6基线） ✅
- **更敏感**: 3000-4000ms（更早触发冻结）
- **更宽松**: 6000-10000ms（减少误触发）

**影响**:
- 当两笔交易间隔 > STALE_THRESHOLD_MS 时，触发硬冻结
- 硬冻结：空窗后首2笔不产生Z-score（POST_STALE_FREEZE=2）
- 配合软冻结使用（SOFT_FREEZE_MS）

---

### 2️⃣ 混合尺度地板参数 ⭐⭐⭐ 核心

#### SCALE_MODE
**含义**: 尺度计算模式

**可选值**:
- `ewma`: 纯EWMA模式
- `hybrid`: 混合模式（EWMA + MAD地板） ✅ **推荐**

**默认值**: `hybrid`

**调优建议**:
- ✅ **固定使用`hybrid`**，这是Step 1.6的核心改进
- `hybrid`模式提供"稳健尺度地板"，防止分母过小

**影响**:
- `hybrid`模式下：`scale = max(ewma_mix, sigma_floor)`
- `sigma_floor = MAD_SCALE_FACTOR * MAD * MAD_MULTIPLIER`
- 显著改善P(|Z|>3)指标（从9.87%降到4.65%）

---

#### EWMA_FAST_HL
**含义**: 快速EWMA半衰期，单位：笔数

**默认值**: `80`

**调优范围**: `60 - 120`

**调优建议**:
- **标准值**: 80（Step 1.6基线） ✅
- **更快响应**: 60-70（对突发更敏感）
- **更平滑**: 90-120（减少抖动）

**影响**:
- 控制"快速分量"的响应速度
- 配合EWMA_SLOW（从HALF_LIFE_TRADES派生）使用
- 快慢混合：`ewma_mix = w_fast * fast + w_slow * slow`

---

#### SCALE_FAST_WEIGHT & SCALE_SLOW_WEIGHT ⭐⭐⭐ 关键

**含义**: 快速/慢速EWMA的混合权重

**默认值**: 
- `SCALE_FAST_WEIGHT = 0.35`
- `SCALE_SLOW_WEIGHT = 0.65`

**约束**: `SCALE_FAST_WEIGHT + SCALE_SLOW_WEIGHT = 1.0` ✅

**调优建议**:

| 场景 | fast | slow | 效果 |
|------|------|------|------|
| **Step 1.6基线** ✅ | 0.35 | 0.65 | 平衡：P(|Z|>2)=5.7%, P(|Z|>3)=4.7% |
| **更快响应** | 0.40-0.45 | 0.55-0.60 | 对突发更敏感，可能抬高尾部 |
| **更稳健** | 0.25-0.30 | 0.70-0.75 | 更平滑，压尾部 |
| **极端稳健** | 0.20 | 0.80 | 最平滑，但响应慢 |

**⚠️ 关键约束**:
- 两权重之和**必须为1.0**
- 代码会自动归一化，但配置文件应保持和为1.0
- 权重错误会导致尺度异常（分母过大/过小）

**影响**:
- 控制"快慢分量"的混合比例
- fast权重 ↑ → 响应快，但可能抖动
- slow权重 ↑ → 更平滑，压尾部

**经验数据**:
| fast权重 | P(|Z|>2) | P(|Z|>3) | 响应速度 |
|---------|----------|----------|---------|
| 0.20 | ~7% | ~6% | 慢 |
| 0.25 | ~8% | ~7% | 中慢 |
| 0.35 ✅ | 5.7% | 4.7% | 中 |
| 0.40 | ~4% | ~4% | 中快 |

---

#### MAD_WINDOW_TRADES
**含义**: MAD（中位数绝对偏差）窗口大小，单位：笔数

**默认值**: `300`

**调优范围**: `200 - 500`

**调优建议**:
- **标准值**: 300（Step 1.6基线） ✅
- **更灵活**: 200-250（对波动更敏感）
- **更稳定**: 350-500（更稳健的MAD估计）

**影响**:
- 控制MAD计算的样本窗口大小
- 窗口越大 → MAD估计越稳定，但响应慢
- 窗口越小 → MAD更灵活，但可能不稳定

---

#### MAD_SCALE_FACTOR
**含义**: MAD到标准差的缩放因子

**默认值**: `1.4826`

**调优建议**:
- ✅ **不建议修改**，这是统计学标准值
- `1.4826` 是MAD与正态分布标准差的理论比值

**影响**:
- 将MAD转换为等效标准差
- `σ_equivalent ≈ 1.4826 * MAD`

---

#### MAD_MULTIPLIER ⭐⭐⭐ 关键

**含义**: MAD地板乘数，控制"地板高度"

**默认值**: `1.45`

**调优范围**: `1.20 - 1.60`

**调优建议**:

| 场景 | 值 | P(|Z|>2) | P(|Z|>3) | 适用 |
|------|---|----------|----------|------|
| **Step 1.6基线** ✅ | 1.45 | 5.7% | 4.7% | 平衡最优 |
| **压尾部（优先）** | 1.47-1.50 | ~5% | ~3-4% | 进一步压3σ |
| **极限压尾** | 1.55-1.60 | ~4% | ~2-3% | 最保守，可能过度 |
| **更灵活** | 1.35-1.40 | ~7% | ~6% | 允许更多变化 |

**⚠️ 关键注意**:
- **抬高地板**（增大MAD_MULTIPLIER）→ 压尾部（P(|Z|>3)↓）
- **降低地板**（减小MAD_MULTIPLIER）→ 尾部更大（P(|Z|>3)↑）
- 不要低于1.30（会导致P(|Z|>3) > 5%）

**影响**:
- 直接控制`sigma_floor`的高度
- `sigma_floor = 1.4826 * MAD * MAD_MULTIPLIER`
- `scale = max(ewma_mix, sigma_floor)`
- 这是压制P(|Z|>3)的**主要旋钮**

**微调路径** (如果P(|Z|>3)仍>2%):
1. 先试 1.45 → 1.47（小步）
2. 再试 1.47 → 1.50（中步）
3. 最后 1.50 → 1.55（大步，慎用）

---

### 3️⃣ 空窗冻结参数

#### POST_STALE_FREEZE
**含义**: 空窗后冻结笔数（硬冻结）

**默认值**: `2`

**调优范围**: `1 - 3`

**调优建议**:
- **标准值**: 2（Step 1.6基线） ✅
- **更保守**: 3（首3笔不产Z）
- **更激进**: 1（首1笔不产Z）

**影响**:
- 当E间隔 > HARD_FREEZE_MS 时，空窗后首N笔不产Z
- 防止"静默→脉冲"时的大Z误报

---

#### HARD_FREEZE_MS
**含义**: 硬冻结阈值（事件时间间隔），单位：毫秒

**默认值**: `5000` (5秒)

**调优建议**:
- ✅ **与STALE_THRESHOLD_MS保持一致**
- 标准值：5000ms

**影响**:
- E间隔 > 5000ms → 触发硬冻结（首2笔不产Z）

---

#### SOFT_FREEZE_MS
**含义**: 软冻结阈值（事件时间间隔），单位：毫秒

**默认值**: `4000` (4秒)

**调优建议**:
- **标准值**: 4000ms（Step 1.6基线） ✅
- **分段冻结**: 4-5s间隔 → 首1笔冻结

**影响**:
- 4000ms < E间隔 ≤ 5000ms → 触发软冻结（首1笔不产Z）
- 5000ms < E间隔 → 触发硬冻结（首2笔不产Z）

---

### 4️⃣ 队列策略参数 ⭐⭐⭐ 关键

#### DROP_OLD
**含义**: 队列满时是否丢弃旧消息

**可选值**:
- `false`: 阻塞等待（确保数据完整性） ✅ **分析模式必须**
- `true`: 丢弃旧消息（降低延迟）

**默认值**: 
- **分析模式**: `false` ✅
- **实时模式**: 初期`false`，灰度稳定后可改为`true`

**调优建议**:

| 模式 | 阶段 | DROP_OLD | 目的 |
|------|------|----------|------|
| **分析模式** | 任何时候 | **false** ✅ | 数据完整性优先 |
| **实时模式** | 灰度验证（1-2周） | **false** ✅ | 先确保质量 |
| **实时模式** | 灰度稳定后 | true | 可切换为低延迟 |

**⚠️ 硬性要求**:
- **分析模式一律`DROP_OLD=false`**，这是不可妥协的
- **实时模式初期也应`DROP_OLD=false`**，先验证质量

**影响**:
- `false`: 队列满时阻塞，`queue_dropped_rate = 0%` ✅
- `true`: 队列满时丢弃旧消息，可能导致数据丢失

---

### 5️⃣ 性能配置参数

#### PRINT_EVERY
**含义**: 每N条打印一次日志

**默认值**: `1000`

**调优范围**: `100 - 5000`

**调优建议**:
- **标准值**: 1000（Step 1.6基线） ✅
- **详细日志**: 100-500（调试时使用）
- **最小日志**: 2000-5000（生产环境）

**影响**:
- 控制日志输出频率，影响I/O性能
- 值越小 → 日志越详细，但I/O开销大
- 值越大 → 日志越少，性能更好

---

#### METRICS_FLUSH_INTERVAL_MS
**含义**: 指标刷新间隔，单位：毫秒

**默认值**: `10000` (10秒)

**调优建议**:
- **标准值**: 10000ms（Step 1.6基线） ✅
- **更频繁**: 5000ms（更实时的监控）
- **更少开销**: 15000-30000ms（减少刷新）

**影响**:
- 控制监控指标的刷新频率
- 值越小 → 指标更实时，但开销大

---

#### WATERMARK_FLUSH_INTERVAL_MS
**含义**: 水位线强制flush间隔，单位：毫秒

**默认值**: 
- **分析模式**: `200ms`
- **实时模式**: `100ms`

**调优建议**:
- **分析模式**: 200ms ✅
- **实时模式**: 100ms ✅（更低延迟）

**影响**:
- 控制水位线的定时flush频率
- 值越小 → 延迟越低，但CPU开销大

---

## 🎯 场景化调优方案

### 场景1: 分析模式（离线研究）

**目标**: 数据完整性优先，Z质量达标

**推荐配置**:
```bash
# 使用profiles/analysis.env
CVD_Z_MODE=delta
HALF_LIFE_TRADES=300
WINSOR_LIMIT=8.0
FREEZE_MIN=80
STALE_THRESHOLD_MS=5000

SCALE_MODE=hybrid
EWMA_FAST_HL=80
SCALE_FAST_WEIGHT=0.35
SCALE_SLOW_WEIGHT=0.65
MAD_WINDOW_TRADES=300
MAD_SCALE_FACTOR=1.4826
MAD_MULTIPLIER=1.45

POST_STALE_FREEZE=2
HARD_FREEZE_MS=5000
SOFT_FREEZE_MS=4000

DROP_OLD=false               # ★ 关键
WATERMARK_MS=2000
PRINT_EVERY=1000
```

**预期结果**:
- P(|Z|>2) ≤ 8% ✅
- P(|Z|>3) ≤ 5% (可优化到≤2%)
- 队列丢弃率 = 0% ✅

---

### 场景2: 实时模式（低延迟触发）

**目标**: 低延迟优先，同时保证Z质量

**推荐配置**:
```bash
# 使用profiles/realtime.env
# 核心参数与分析模式相同
CVD_Z_MODE=delta
# ... (其他参数同分析模式)

# 差异化配置
WATERMARK_MS=500             # 降低到500ms
DROP_OLD=false               # 初期保持false，灰度后可改true
WATERMARK_FLUSH_INTERVAL_MS=100  # 更频繁flush
```

**灰度策略**:
1. **第1-2周**: `DROP_OLD=false`，验证质量
2. **灰度稳定后**: 可尝试`DROP_OLD=true`，对比延迟和数据质量

---

### 场景3: P(|Z|>3)仍超标（>2%）的微调

**问题**: P(|Z|>3) = 4-5%，需要压到≤2%

**微调路径**:

**Step 1**: 小步抬地板
```bash
MAD_MULTIPLIER=1.47          # 从1.45提高到1.47
```

**Step 2**: 如仍超标，中步抬地板
```bash
MAD_MULTIPLIER=1.50          # 从1.47提高到1.50
```

**Step 3**: 如仍超标，调整权重
```bash
SCALE_FAST_WEIGHT=0.30       # 从0.35降到0.30
SCALE_SLOW_WEIGHT=0.70       # 相应调整
```

**⚠️ 不建议**:
- ❌ 不要降低WINSOR_LIMIT（不会改善2-3σ占比）
- ❌ 不要缩短STALE_THRESHOLD_MS（可能增加误触发）
- ❌ 不要降低MAD_MULTIPLIER（会让尾部更大）

---

## 📊 参数影响矩阵

| 参数 | P(|Z|>2) | P(|Z|>3) | median(|Z|) | 延迟 | 数据完整性 |
|------|----------|----------|-------------|------|-----------|
| HALF_LIFE_TRADES ↑ | ↓小 | ↓小 | - | - | - |
| MAD_MULTIPLIER ↑ | ↓ | ↓↓ | - | - | - |
| SCALE_FAST_WEIGHT ↑ | ↑ | ↑ | - | - | - |
| POST_STALE_FREEZE ↑ | ↓小 | ↓小 | - | - | - |
| DROP_OLD=true | - | - | - | ↓↓ | ↓↓ |
| WATERMARK_MS ↓ | - | - | - | ↓ | ↓小 |

**图例**:
- ↑↑ 显著增加
- ↑ 增加
- ↓ 减少
- ↓↓ 显著减少
- ↓小 轻微减少
- \- 无影响

---

## ✅ 配置检查清单

### 启动前检查

```bash
# 1. 检查模式
echo "CVD_Z_MODE=$CVD_Z_MODE"           # 应为：delta

# 2. 检查权重和
python -c "print(0.35 + 0.65)"          # 应为：1.0

# 3. 检查队列策略
echo "DROP_OLD=$DROP_OLD"               # 分析模式应为：false

# 4. 检查冻结参数
echo "POST_STALE_FREEZE=$POST_STALE_FREEZE"  # 应为：2
echo "HARD_FREEZE_MS=$HARD_FREEZE_MS"        # 应为：5000
echo "SOFT_FREEZE_MS=$SOFT_FREEZE_MS"        # 应为：4000

# 5. 检查水位线
echo "WATERMARK_MS=$WATERMARK_MS"       # 分析：2000，实时：500
```

---

## 📚 相关文档

- [CVD系统文件关联说明](CVD_SYSTEM_FILES_GUIDE.md)
- [CVD系统架构](CVDSYSTEM_ARCHITECTURE.md)
- [Step 1.6干净金测报告](reports/STEP_1_6_CLEAN_GOLD_TEST_REPORT.md)

---

*文档版本: v1.0*  
*最后更新: 2025-10-19*  
*维护者: V13 OFI+CVD+AI System*
