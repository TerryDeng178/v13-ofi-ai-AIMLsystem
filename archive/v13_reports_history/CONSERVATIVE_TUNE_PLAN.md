# 🎯 保守微调试验计划

## 📊 试验矩阵

| 组 | 变更 | ETH 20min | BTC 20min | 放行条件 |
|----|------|-----------|-----------|----------|
| **A1** | 回滚基线（300/8/5000/50） | ✓ | ✓ | 恢复到 ≥P1.1（7/8） |
| **A2** | 半衰期280（其余同A1） | ✓ | ✓ | `P(|Z|>2)≤8%` 且 `P(|Z|>3)≤3%` |
| **B1** | A2 + 稳健尺度（双EWMA或MAD地板） | ✓ | ✓ | `P(|Z|>2)≤8%` 且 `P(|Z|>3)≤2%` |

---

## 🔧 Step A: 单参数微调

### 配置参数
```bash
# Step A配置
CVD_Z_MODE=delta
HALF_LIFE_TRADES=280        # 从300小幅调低到280（-6.7%）
WINSOR_LIMIT=8.0            # 保持基线不变
STALE_THRESHOLD_MS=5000     # 保持基线不变
FREEZE_MIN=60               # 从50调整到60（+20%，更稳健的暖启动）
```

### 目标
- `P(|Z|>2) ≤ 8%`
- `P(|Z|>3) ≤ 3%`
- 若任一劣化，直接退回300

### 验证策略
1. **方向验证**: 仅调整一个参数，验证方向正确性
2. **保守原则**: 小幅调整（-6.7%），避免激进修改
3. **快速回滚**: 发现劣化立即回滚到基线

---

## 🔧 Step B: 稳健尺度地板

### 配置参数
```bash
# Step B配置（在Step A基础上）
CVD_Z_MODE=delta
HALF_LIFE_TRADES=280        # 保持Step A设置
WINSOR_LIMIT=8.0            # 保持基线不变，不再降低
STALE_THRESHOLD_MS=5000     # 保持基线不变
FREEZE_MIN=60               # 保持Step A设置
```

### 稳健尺度方案
**方案1: 双EWMA加权平均**
```python
# 计算两个不同半衰期的EWMA
ewma_fast = EWMA(|Δ|, alpha_fast)    # 半衰期≈80
ewma_slow = EWMA(|Δ|, alpha_slow)    # 半衰期=280
scale = 0.5 * ewma_fast + 0.5 * ewma_slow
```

**方案2: 混合尺度地板**
```python
# 使用MAD作为地板保护
scale = max(EWMA(|Δ|), 1.4826 * MAD_300)
```

### 目标
- `P(|Z|>2) ≤ 8%`
- `P(|Z|>3) ≤ 2%`
- 只有当Step A达不到<3%时，才启用Step B

---

## 📊 监控与报告

### 新增监控指标
1. **Scale（分母）统计**:
   - `scale_t`的P5/P50/P95序列
   - 避免静默后分母过小

2. **空窗后前3笔Z分布**:
   - 应比全量更温和
   - 验证暖启动效果

3. **常规健康项**:
   - `z_freeze_count`: Z冻结次数
   - `gaps_over_10s`: 10秒以上缺口
   - `p99_interarrival`: P99到达间隔

### 报告要求
- 重点关注"分母"而非仅看Z-score本身
- 对比不同测试组的Scale分布
- 分析空窗后Z-score的稳定性

---

## 🚀 执行计划

### 阶段1: A1回滚基线验证
- **状态**: 进行中
- **目标**: 恢复到P1.1基线水平（7/8通过）
- **监控**: 使用`check_conservative_tune_progress.py A1`

### 阶段2: A2单参数微调
- **等待**: A1完成并验证通过
- **目标**: 验证半衰期280的效果
- **监控**: 使用`check_conservative_tune_progress.py A2`

### 阶段3: B1稳健尺度（如需要）
- **条件**: A2达不到P(|Z|>3)≤3%时启用
- **目标**: 通过稳健尺度进一步优化
- **监控**: 使用`check_conservative_tune_progress.py B1`

---

## ⚠️ 风险控制

### 快速回滚机制
1. **实时监控**: 每5分钟检查一次进度
2. **劣化检测**: 发现任一目标指标劣化立即停止
3. **基线恢复**: 立即回滚到已验证的基线参数

### 保守原则
1. **单参数调整**: 每次只调整一个参数
2. **小幅调整**: 调整幅度控制在10%以内
3. **充分验证**: 每个阶段都要充分验证

---

## 📋 配置文件

- `step_a_conservative_tune.env`: Step A配置
- `step_b_robust_scale.env`: Step B配置
- `check_conservative_tune_progress.py`: 监控脚本

---

**计划制定时间**: 2025-10-18 14:05  
**计划版本**: v1.0  
**相关任务**: Task_1.2.10.1_CVD问题修复（特别任务）
